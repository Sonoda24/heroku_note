{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>SVG Editor</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
  <link rel="shortcut icon" href="favicon.ico">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <!--Bootstrap４を３に変え下記３行の変更でBottomメニュー可能となる-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <!-- link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous" -->
  <link rel="stylesheet" href="{% static 'icomoon/style.css' %}">
  <!-- script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script -->
　<!-- script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="  crossorigin="anonymous"></script-->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <!-- script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/1.5/canvg.js"></script>
  <!-- script type="text/javascript" src="{% static 'js/cmanCP_v091.js' %}" --></script>
  <script type="text/javascript" src="{% static 'js/Select_comb.js' %}"></script><!-- for combobox -->
  <script type="text/javascript" src="{% static 'js/rgbcolor.js' %}"></script><!-- for color 変換 -->
  <script type="text/javascript" src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
  <!--　下記３行はDialog表示で必要　-->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<style>
* { 
    margin: 0px; 
    padding: 0px; 
}
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 1000px;
	    font-family: "Arial","游ゴシック","游明朝","Broadway",sans-serif;
        }
	.container-fluid {
            margin: 0;
            padding: 0;
	}
        .row {
            margin: 0;
            padding: 0;
        }
        nav.mt-3 {
	    margin-top: 0 !important;
	    padding: 0;
        }
        .tool {
  	    display: flex;
        }
        .menu {
  	    display: flex;
        }
        .navbar {
	    height: 30px;
	    min-height: 30px;
	}

* {box-sizing: border-box;}
.tool , .tool form , .tool div .tool button .menu , .menu01 .menu02 .menu03 {
	display:inline-block;  
	display: flex;
	}
 .tool select{
		font-family: fontAwesome;
	/*	height:30px;  */
		position: relative; top: 0;
		width:100px;
		margine:0px;
		padding:0px;
/*	background-color: #4CAF50; */
	background-color: #337ab7;
	color: #fff;
	}
 .tool button{
		font-family: fontAwesome;
	/*	height:30px;  */
		margine:0px;
		padding:0px;
/*	background-color: #4CAF50;  */
	background-color: #337ab7;
	color: #fff;
	}
 .tool select:hover {
	opacity: 0.6;
}
 .tool button:hover {
	opacity: 0.6;
}

.Thtm {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width: 100%;
  height: auto;
  outline: none;
}
.Tvis {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width:100%;
  height:auto;
  z-index: 30;
  opacity: 0.;
  outline: none;
}

.canv {
  z-index:20;
  padding:0px;
  left: -20px;
  margin:0px;
  width:100%;
  position: absolute;
  opacity: 0.;  
}


.my_button {
  display: block;
  width: 100px;
  height: 36px;
  margin: 10px 10px 10px 10px; /* 外側の時計回りの余白 */
  text-align: center;
  color: #fff;
  line-height: 36px;
  text-decoration: none;
  background-color: #69c;
  border: 1px solid #69c;
  border-radius: 5px;
  float: left;
}
.my_button:hover {color:#ffffff; background:#0000cc;}


.flex_box {
    display: flex;              /* フレックスボックスにする */
    align-items:stretch;        /* 縦の位置指定 */
}

.colm_flex {
    display: flex;              /* フレックスボックスにする */
    flex-direction:column;        /* 縦の位置指定 */
}


.point_none {
  pointer-events:none;
}
.point_auto {
  pointer-events: auto;
}

.select_none {
  user-select:none;
}

.select_auto {
  user-select:auto;
}
.mgr-50{
    margin-right : 50px;
}

#trig1{
	height:25px;
        background-color:#ffffdd;
}
#trig2{
	height:25px;
        background-color:#ffffdd;
}
#svgtrig1{
	height:25px;
        background-color:#ffffdd;
}
#svgtrig2{
	height:25px;
        background-color:#ffffdd;
}

#svgtrig3{
	height:25px;
        background-color:#ffffdd;
}

.file {
    display: inline-block;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
    padding: 6 -6 6 -6px;
    margin:-6px;
/*    padding: 1em;  */
    border: 1px solid #000;
}
 
.file input[type="file"] {
    opacity: 0;  
    filter: progid:DXImageTransform.Microsoft.Alpha(opacity=0);
    position: absolute;
    right: 0;
    top: 0;
    margin: 0;
    font-size: 12px;
    cursor: pointer;
}

      #contextmenu_a {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:80px;
        height:65px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_a li {
        cursor:pointer;
      }

      #contextmenu_b {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:90px;
        height:90px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_b li {
        cursor:pointer;
      }

      #contextmenu_c {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:110px;
        height:50px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_c li{
        cursor:pointer;
      }

      .contex:hover { 
	background-color: rgba(102, 102, 255, 0.50);
      }


/* PopUp Window に関する部分　*/
.dialog {
  overflow: hidden;
  position: absolute;
  top: 30%;
  height: auto;
  width: 300px;
  display: none;
  border:1px solid #aaa;
  z-index:1000;
}
.dialog-header {
  border: 1px solid #aaa;
  background: #cccccc;
  color: #222222;
  font-weight: bold;
  overflow: hidden;
  padding:5px;
}
.dialog-title {
  float: left;
}
.dialog-close {
  float: right;
  border: 1px solid #d3d3d3;
  background: #e6e6e6;
  font-weight: normal;
  color: #555555;
}
.dialog-content {
  position: relative;
  border: 0;
  padding: .5em 1em;
  background: #fff;
  overflow: auto;
  width: auto;
  height: auto;
  font-size:12px;
  font-weight:normal;
/* normal, bold, lighter, bolder */
  line-height:0.8;
}
/*  mouse handle              */
rect#rect01 {
    cursor: move;
}
/*
circle {
  stroke-width: 2;
  stroke: #f00;
  fill: #ff0;
}
*/
/*
circle:hover {
  stroke: #090;
  fill: #fff;
}
*/

.movable {   /* これは有効　下のhoverは効かない　*/
  pointer-events: all;
  cursor: pointer;
}

.draggable {   /* これは有効　下のhoverは効かない　*/
  pointer-events: all;
  cursor: move;
}

.draggable:hover {
  backgroundColor = "orange";
}

.btn:hover {
      background-color: rgba(102, 102, 255, 0.50);
    }

.wide {   /*　横方向拡大縮小　*/
  pointer-events: all;
  cursor: ew-resize;
}
.height {   /*　上下方向拡大縮小　*/
  pointer-events: all;
  cursor: ns-resize;
}
.ewcross {   /*　easte-west方向拡大縮小　*/
  pointer-events: all;
  cursor: nesw-resize;
}
.wecross {   /*　west-easte方向拡大縮小　*/
  pointer-events: all;
  cursor: nwse-resize;
}
.rotate {   /*　west-easte方向拡大縮小　*/
  pointer-events: all;
  cursor: all-scroll;
}
/*imgタグ関連　　　*/
.img_samp1     { border:solid 5px #000000}
.img_samp2     { border:double 5px #ff0000}
/* Icon説明の吹き出しのテスト　*/
 .my_link {
      position: relative;
    }
 .my_link:hover .my_link_ko {
      display: block;
    }
 .my_link:before {
      margin: 10px;
      font-family: "icomoon";
      content:"\e9cb";
    }
 .my_link .my_link_ko {
      position: relative;
      display: none;
      background-color: rgba(102, 102, 255, 0.50); 
      width:180px;                          /* 吹き出し全体の幅 */
      top:-50px;
      right: 20px;                             /*  left : -1%;  表示位置 */
      font-size: 80%;
    }

  /* SVGアイコン定義コンテナクラス */
  .svg-defs {
    width: 0;
    height: 0;
    visibility: hidden;
  }

  /* SVGアイコンクラス */
  .icon {
    width: 1.25em;
    height: 1.25em;
    fill: currentColor;
    position: relative;
    display: inline-block;
    vertical-align: baseline;
    /* baselineより垂直方向にちょっとだけ下げる */
    top: 0.125em;
  }
　#use_icon.icon:hover {
  　stroke: #090;
  　fill: blue;
    border: 1px solid #dd0000;
    background: #dd0000;
    color:#fff;
　　}

  .show_icon {
    position:relative;
    left:500px;
    top:50px;
    width: 100px;
    height: 1000px;
  }

.my_navi ul {
  display: flex;
  flex-flow: column;
  margin: 0;
  padding: 6px;
  list-style-type: none;
}
.my_navi li.my_hamburger {
  align-self: flex-end;
}
.my_navi a {
  display: block;
  border-radius: 4px;
  padding: 12px 24px;
  color:white;
  background-color:blue;
  text-decoration: none;
}
.my_navi li a:hover {
  opacity: 0.6;
}

@media only screen and (min-width:550px) {
.my_navi ul {
    display: flex;
    flex-flow: row;
    margin: 0;
    padding: 6px;
    list-style-type: none;
  }

.my_navi li.my_hamburger {
     display: none;
  }
}

    </style>
</head>
<body>
<nav class="navbar navbar-expand-sm navbar-dark navbar-default navbar-fixed-bottom">
<!-- nav class="navbar navbar-expand-sm navbar-primary navbar-default navbar-fixed-bottom" -->
    <div class="tool">
	<select id="fgedit" onchange="chng_mode()" style="width:60px; height:25px;" ></p>
	<option value="">Visual</option>
	<option value="">&#xf044;Edit</option>
	<option value="">&#xf1fe;Svg</option>
	<option value="">Html</option>
	</select>
  <div class="menu">
    <div id="menu01" style="display:block;">
	　　<button onclick="doc_print()">&#xf02f; 印刷</button>
	<button onclick="pop_inp_search()">概要</button>
	<button onclick="doc_save()">&#xf1c0; 保存</button>
	<button id="doc_new">新規</button>
	<button id="copy_new">&#xf0c5; Copy</button>
	<button id="design_html">HTML設定</button>
	<button id="pallet_dialog">Pallet</button>
        <button id="trig1" style="color:#fff; opacity:0.8;">文字</button>
	<button id="trig2" style="color:#000; opacity:0.8;">背景</button>
	<button id="chain_svg">新Svg</button>
	<button id="html_undo"> &#xf0e2; </button>
	<button id="html_redo"> &#xf01e; </button>
	　　<button id="Tochara">色変更</button>
	<button id="Cr_To_Br">Br</button>
	<button id="link">&#xf0c1; link</button>
	<!-- button id="image_sel">選択</button -->
	<select id="Shift" onchange="chng_shift()" style="width:50px; height:25px;" ></p>
    		<option value="s001">&#xf036; </option>
    		<option value="s002">&#xf037; </option>
		<option value="s003">&#xf038; </option>
	</select>
	<button id="set_navi">Menu設置</button>
	<button id="html_outer">外部html</button>
	　　<button id="E_clear">clear</button>
	<!-- select id="List" onchange="chng_list()" style="width:50px; height:25px;" ></p>
    		<option value="s001">List</option>
    		<option value="s002">&#xf0ca; </option>
    		<option value="s003">&#xf0cb; </option>
	</select -->
	<!--select id="image_set" onchange="set_image()" style="width:60px; height:25px;" ></p>
    		<option value="s001">画像</option>
    		<option value="s002">Local</option>
		<option value="s003">My_DB</option>
		<option value="s003">Space</option>
    		<option value="s004">配置etc</option>
    		<option value="s005">消去</option>
	</select -->
	<!--bbutton id="image_place">Image</button>
	<button id="image_db">Image_db</button -->
    </div><!-- end menu01 -->
    <div id="menu02" style="display:none;">
	　　<button onclick="doc_print()">印刷</button>
        <select name="svg_tag_menu" id="svg_tag_menu" onchange="chang_svg()" style="width:80px; height:25px;">
		<option value="svg_00">top_svg</option>
  	</select>
	<button id="pallet_dialog2">Pallet</button>
        <button id="svgtrig1"  style="color:#fff; opacity:0.8;">線色</button>
        <button id="svgtrig3"  style="color:#fff; opacity:0.8;">文字</button>
	<button id="svgtrig2"  style="color:#000; opacity:0.8;">塗色</button>
	<button id="svg_undo"> &#xf0e2; </button>
	<button id="svg_redo"> &#xf01e; </button>
        <!--select id="arrow" onchange="chng_arrow()" style="width:60px; height:25px;" ></p>
    		<option value="s001" selected>none</option>
    		<option value="s002">start</option>
		<option value="s003">end</option>
    		<option value="s004">both</option>
	</select>
        <select id="Lstyle" onchange="chng_Lstyle()" style="width:40px; height:25px;" ></p>
    		<option value="s001" selected>none</option>
    		<option value="s002">dash</option>
		<option value="s003">1dash</option>
    		<option value="s004">2dash</option>
	</select -->
	<!-- button id="resolv_svg">Resol</button -->
	　　<button id="draw_fig">描画</button>
        <select name="control" id="control" style="display:none;">
		<option value="none"></option>
		<option value="simp_line">simp</option>
    		<option value="seri_line">serial</option>
    		<option value="close_line">closed</option>
		<option value="smooth">smooth</option>
		<option value="close_smooth">c smooth</option>
		<option value="quad_bezier">q bezier</option>
		<option value="cubic_bezier">c bezier</option>
    		<option value="free_line">free</option>
  	</select>
	<button id="createWindow">図形</button>
        <button id="fig_sel_st">選択</button>
        <button id="fig_reshape">変形</button>
        <button id="fig_scale">拡縮</button>
        <button id="fig_rotate">回転</button>
        <button id="fig_copy">複製</button>
        <button id="fig_updown">反転</button>
        <button id="fig_sel_end">Quit</button>
        <button id="fig_delete">削除</button>
        <button id="check_anime">Check</button>
        <!-- select id="line_size" onchange="chng_width()" style="width:40px; height:25px;" ></p>
    		<option value="s001">1</option>
    		<option value="s002" selected>2</option>
		<option value="s003">4</option>
    		<option value="s004">8</option>
    		<option value="s005">12</option>
		<option value="s006">16</option>
		<option value="s006">24</option>
		<option value="s006">32</option>
		<option value="s006">50</option>
	</select -->
        <!-- button id="draw_mesh">mesh</button -->
	<!-- label for="selfile">import<input type="file" id="selfile">
	</label -->
	<select id="Exp" onchange="export_mode()" style="width:60px; height:25px;" ></p>
		<option value="s_00">export</option>
		<option value="s_01">only svg</option>
		<option value="s_02">to html</option>
	</select>
        <!-- button id="export_svg">export</button -->
        <!-- span id="cp02" onclick="cmanCP_JS_open(this)" cmanCPat="def_color:val=sample2,def_alpha:0,rc_text:sample2,rc_form:#16,rc_bg:cp02"></span>
        <!-- input type='text' value="#0000ff" id="sample2" style="width:60px; height:25px;" onchange="check_svgcolor()" -->
        <!-- label for="selfile"><input type="file" id="selfile">
	</label -->
	<!-- input type="file" id="selfile" -->
	<div class='file' style="display:none;">import<input type="file" id="svgfile" ></div>
	<div class='file' style="display:none;">import<input type="file" id="htmlfile" ></div>
	<select id="Imp" onchange="import_mode()" style="width:60px; height:25px;" ></p>
		<option value="s_00">import</option>
		<option value="s_01">from Net</option>
		<option value="s_02">from .svg</option>
		<option value="s_03">from .html</option>
	</select>
        <button id="basic_fig"  style="display:none;">basic</button>
	<select id="Util" onchange="Utility()" style="width:60px; height:25px;" ></p>
		<option value="s_00">utility</option>
		<option value="a_01">fix</option>
		<option value="a_02">snap</option>
		<option value="s_01">basic</option>
		<option value="s_02">basic2</option>
		<option value="s_03">basic3</option>
		<option value="s_04">Mail</option>
	</select>
	　<svg class="icon"><use width="100%" height="100%" xlink:href="#name" fill="orange"/></svg>
	<button id="clear">clear</button>
<!--input type="button" value="Job1" onClick="goScriptB(0)">
<input type="button" value="Job2" onClick="goScriptB(1)">
<input type="button" value="Job3" onClick="goScriptB(2)" -->
    </div><!-- end menu02 -->
    <div id="menu03" style="display:none;">
	<input type="button" value="Exe1" onClick="goScriptC(0)" >
	<input type="button" value="Exe2" onClick="goScriptC(1)" >
	<input type="button" value="Exe3" onClick="goScriptC(2)" >
	</div><!-- end menu03 -->
  </div><!-- End menu -->
 </div><!-- end Tool -->
</nav>

  <div class="main tab-content"><!-- Start main tab-content -->
  <div class="row">
    <!-- div class="col-sm-9" -->
    <div class="tab-pane" id="tab1"><!-- Start tab1 -->
	<a id="JumpTo" href="#svg_00" style="display:none;"></a>
	<div id="wClone" style="display:none;"></div>
	<textarea id="area_From" style="display:none;">テキストをCopyする</textarea>
	<textarea id="area_To" style="display:none;"></textarea>
        <svg id="chain" class="canv" style="display:none;" width="100%" height="2000" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	</svg>
        <svg id="mesh_canv" class="canv" width="1400" height="2000" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	    <defs>
	      <marker id="start_arw" viewBox="-10 -3 10 6" refX="-10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M -10 0 L 0 -3 L 0 3 Z"/>
	      </marker>
	      <marker id="end_arw" viewBox="0 -3 10 6" refX="10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M 0 -3 L 0 3 L 10 0 Z"/>
	      </marker>
	    </defs>
	</svg>
	<svg id="basic_svg" style="display:none;" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <line id="line01" x1="100" y1="0" x2="100" y2="800" stroke="blue" stroke-width="5"/>
<!--Text   -->  <g fig="text" style="display:none;">
		  <!-- text text-anchor="start" font-size="14" stroke-width="0" rotate="0" style="display:block;" -->
		  <text text-anchor="start" font-size="14" style="display:block;">
			<tspan x="40" y="20" >Text</tspan>
		  </text>
		</g>
<!--circle -->  <g fig="path" close="close" smooth="smooth" class="none">
                  <path d="M100, 50C100, 58.93 97.77, 67.26 93.3, 75C88.84, 82.74 82.74, 88.84 75, 93.3C67.26, 97.77 58.93, 100 50, 100C41.07, 100 32.74, 97.77 25, 93.3C17.26, 88.84 11.16, 82.74 6.7, 75C2.23, 67.26 0, 58.93 0, 50C0, 41.07 2.23, 32.74 6.7, 25C11.16, 17.26 17.26, 11.16 25, 6.7C32.74, 2.23 41.07, 0 50, 0C58.93, 0 67.26, 2.23 75, 6.7C82.74, 11.16 88.84, 17.26 93.3, 25C97.77, 32.74 100, 41.07 100, 50 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--smcirc -->  <g fig="path" close="close" smooth="smooth">
                  <path d="M30, 15C30, 17.68 29.33, 20.18 27.99, 22.5C26.65, 24.82 24.82, 26.65 22.5, 27.99C20.18, 29.33 17.68, 30 15, 30C12.32, 30 9.82, 29.33 7.5, 27.99C5.18, 26.65 3.35, 24.82 2.01, 22.5C0.67, 20.18 0, 17.68 0, 15C0, 12.32 0.67, 9.82 2.01, 7.5C3.35, 5.18 5.18, 3.35 7.5, 2.01C9.82, 0.67 12.32, 0 15, 0C17.68, 0 20.18, 0.67 22.5, 2.01C24.82, 3.35 26.65, 5.18 27.99, 7.5C29.33, 9.82 30, 12.32 30, 15 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--ellips -->  <g fig="path" close="close" smooth="smooth">
		  <path d="M100,25 C99.36,30.02 97.13,34.19 93.3,37.5 C87.98,42.11 81.66,44.73 75,46.65 C66.83,49.01 58.48,50 50,50 C41.52,50 33.17,49.01 25,46.65 C18.34,44.73 12.02,42.11 6.7,37.5 C2.87,34.19 0,30.36 0,25 C0,19.64 2.87,15.81 6.7,12.5 C12.02,7.89 18.34,5.27 25,3.35 C33.17,0.99 41.52,0 50,0 C58.48,0 66.83,0.99 75,3.35 C81.66,5.27 87.98,7.89 93.3,12.5 C97.13,15.81 99.36,19.98 100,25 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--if     -->  <g fig="path" close="close" smooth="else">
		  <path d="M50,0 L0,25 L50,50 L100,25 L50,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectLg -->  <g fig="path" close="close" smooth="else">
		<path d="M0,0 L0,100 L100,100 L100,0 L0,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectSm -->  <g fig="path" close="close" smooth="else">
		  <path d="M0,0 L0,50 L100,50 L100,0 L0,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectRLg-->  <g fig="path" close="close" smooth="trim 10">
		  <path d=" M0,2.5 0,97.5 M0,97.5 Q0,100 2.5,100 M2.5,100 97.5,100 M97.5,100 Q100,100 100,97.5 M100,97.5 100,2.5 M100,2.5 Q100,0 97.5,0 M97.5,0 2.5,0 M2.5,0 Q0,0 0,2.5 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectRSm-->  <g fig="path" close="close" smooth="trim 10">
		  <path d=" M0,2.5 0,47.5 M0,47.5 Q0,50 2.5,50 M2.5,50 97.5,50 M97.5,50 Q100,50 100,47.5 M100,47.5 100,2.5 M100,2.5 Q100,0 97.5,0 M97.5,0 2.5,0 M2.5,0 Q0,0 0,2.5 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--start  -->  <g fig="path" close="close" smooth="trim 45">
		  <path d=" M0,11.25 0,13.75 M0,13.75 Q0,25 11.25,25 M11.25,25 63.75,25 M63.75,25 Q75,25 75,13.75 M75,13.75 75,11.25 M75,11.25 Q75,0 63.75,0 M63.75,0 11.25,0 M11.25,0 Q0,0 0,11.25 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--node   -->	<g fig="path" close="close" smooth="else">
		  <path d="M25,0 L0,25 L25,50 L75,50 L100,25 L75,0 L25,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--input  -->	<g fig="path" close="close" smooth="else">
		  <path d="M75,0 L0,12.5 L0,25 L75,25 L75,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--para   -->	<g fig="path" close="close" smooth="else">
		  <path d="M25,0 L0,50 L75,50 L100,0 L25,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--print  -->	<g fig="fig">
	   	  <g fig="path" close="else" smooth="else">
			<path d="M100,50 L100,0 L0,0 L0,57.5 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
	   	  <g  fig="path" close="else" smooth="smooth">
			<path d="M0,57.5 C3.02,60.42 6.36,62.92 10,65 C12.33,66.33 14.97,66.78 17.5,67.5 C20.81,68.44 24.07,69.57 27.5,70 C30.83,70.42 34.17,70.42 37.5,70 C40.94,69.57 44.26,68.72 47.5,67.5 C51.01,66.19 54.09,64.02 57.5,62.5 C61.61,60.68 65.69,58.8 70,57.5 C74.09,56.27 78.37,56.03 82.5,55 C85.07,54.36 87.47,53.23 90,52.5 C93.31,51.56 96.64,50.72 100,50 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		</g>
<!--drum   -->	<g fig="fig">
		  <g fig="path" close="close" smooth="smooth"><path d="M75,12.5 C74.04,15.01 72.36,16.89 69.97,18.13 C65.66,20.37 60.99,21.42 56.25,22.24 C50.05,23.32 43.79,23.75 37.5,23.75 C31.21,23.75 24.96,23.32 18.75,22.24 C14.01,21.42 9.34,20.37 5.03,18.13 C2.64,16.89 0,15.87 0,12.5 C0,9.13 2.64,8.12 5.03,6.88 C9.34,4.63 14.01,3.58 18.75,2.76 C24.96,1.68 31.21,1.25 37.5,1.25 C43.79,1.25 50.05,1.68 56.25,2.76 C60.99,3.58 65.66,4.63 69.97,6.88 C72.36,8.12 74.04,9.99 75,12.5 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <g fig="path" close="else" smooth="smooth" class="none"><path d="M0.25,65.25 C1.9,67.71 3.98,69.71 6.5,71.25 C9.36,73 12.55,73.9 15.75,74.75 C18.29,75.42 20.9,75.56 23.5,75.75 C27.74,76.06 31.99,76.25 36.25,76.25 C40.17,76.25 44.09,76.13 48,75.75 C52.62,75.3 57.23,74.86 61.75,73.75 C64.83,73 67.82,72.01 70.5,70.25 C72.64,68.85 74.31,67.02 75.5,64.75 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <g fig="line"><path d="M0,12.5 L0,65 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <g fig="line"><path d="M75,65 L75,12.5 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
	        </g>
	</svg>
        <svg  class="svg-defs" width="1000" height="1000" version="1.1" xmlns="http://www.w3.org/2000/svg">
           <symbol id="icon01" viewBox="0 0 440 440">
             <path d="M20, 390L390, 20L420, 50L50, 420" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path>
           </symbol>
           <symbol id="icon02" viewBox="0 0 440 440">
             <path d="M20, 390L370, 40L400, 70L50, 420" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path>
             <path d="M320, 50L420, 20L390, 120" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path>
           </symbol>
	   <symbol id="line" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M20, 390L390, 20L420, 50L50, 420L20, 390 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
	   <symbol id="line-endar" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M270, 60L420, 20L370, 170L270, 60 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M20, 390L370, 40L400, 70L50, 420L20, 390 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
	   <symbol id="line-sttar" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M70, 270L20, 420L170, 370L70, 270 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M390, 20L40, 370L70, 400L420, 50L390, 20 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
	   <symbol id="line-stedar" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M40, 370L370, 40L400, 60L70, 400L40, 370 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M70, 270L20, 420L170, 370L70, 270 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M270, 70L420, 20L370, 170L270, 70 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
           <symbol id="serial" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M40, 340L120, 130L260, 320L320, 90" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="closed" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M60, 220L180, 60L370, 120L220, 360L60, 220 Z" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="smooth" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50, 320C54.93087557603686, 285.14592933947773 64.93087557603687, 251.8125960061444 80, 220C95.6, 187.06666666666666 100.43478260869566, 146.95652173913044 140, 130C176.24113475177305, 114.46808510638299 197.87878787878788, 137.87878787878788 220, 160C242.12121212121212, 182.12121212121212 237.91962174940898, 214.11347517730496 250, 240C261.4035087719298, 264.4360902255639 248.90804597701154, 302.5287356321839 290, 310C330.49751243781094, 317.363184079602 343.55555555555554, 286.31111111111113 360, 260C381.0355987055016, 226.34304207119743 391.0355987055016, 189.67637540453075 390, 150" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="c-smooth" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M60, 220C73.71212121212122, 172.00757575757575 113.43434343434343, 147.42424242424244 150, 120C170.78431372549022, 104.41176470588235 194.76190476190476, 100 220, 100C248.33333333333331, 100 275.2083333333333, 105.83333333333333 300, 120C325.45454545454544, 134.54545454545456 348.8888888888889, 151.11111111111111 360, 180C369.68992248062017, 205.19379844961242 364.49275362318843, 228.26086956521738 350, 250C332.98850574712645, 275.51724137931035 308.7525562372188, 290.92024539877303 280, 300C240.75498575498574, 312.3931623931624 201.08333333333331, 319.6666666666667 160, 310C133.015873015873, 303.6507936507937 127.54385964912282, 275.7894736842105 110, 260C94.10852713178294, 245.69767441860463 44.81481481481481, 273.14814814814815 60, 220" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="q-bezier" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50, 340Q220, 10 306, 252" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="c-bezier" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M40, 360C170, 30 230, 340 397, 122" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="free" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50, 343L50, 338L50, 325L50, 321L50, 314L50, 306L50, 301L50, 297L50, 293L51, 289L54, 281L56, 277L57, 270L60, 263L64, 259L64, 255L67, 250L68, 246L73, 238L78, 231L86, 220L91, 213L97, 206L103, 199L108, 192L119, 183L127, 174L137, 163L147, 154L157, 144L165, 136L172, 130L183, 122L190, 117L196, 112L200, 109L207, 106L211, 104L216, 102L222, 101L228, 97L233, 96L240, 95L246, 94L255, 94L260, 94L266, 94L272, 94L276, 95L280, 98L284, 100L287, 102L291, 107L294, 111L296, 117L300, 122L301, 127L304, 134L305, 140L308, 147L309, 155L311, 165L312, 174L312, 182L312, 197L312, 209L312, 218L312, 230L312, 240L312, 251L311, 258L308, 265L306, 269L304, 274L300, 281L298, 287L292, 298L288, 306L282, 313L278, 317L272, 324L267, 329L263, 330L256, 332L249, 334L245, 334L241, 334L235, 334L227, 334L222, 334L217, 333L212, 327L207, 321L205, 318L201, 306L197, 296L194, 288L191, 279L188, 271L188, 263L188, 254L188, 246L188, 238L188, 231L188, 225L188, 216L188, 210L188, 203L188, 197L189, 191L192, 183L194, 174L197, 167L200, 159L204, 153L208, 145L210, 142L214, 136L217, 129L220, 126L224, 120L226, 116L231, 110L237, 105L239, 102L244, 98L249, 94L256, 90L265, 84L272, 80L280, 75L292, 70L303, 64L313, 60L324, 56L334, 53L349, 46L360, 40L372, 35L382, 30L390, 26L394, 23L397, 21" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="Text" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M38,129 L149,129 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M257,189 L320,344 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M142,259 L227,259 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M370,314 C367.64,320.34 368.31,326.34 372,332 C375.13,336.8 380.39,336.05 385,337 C390.29,338.09 395.62,338.43 401,338 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M366,130 L368,320 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M348,194 L395,194 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M327,182 L250,349 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M224,264 C224.38,255.25 223.72,246.59 222,238 C220.66,231.3 218.71,224.83 215,219 C211.37,213.3 206.54,208.8 201,205 C194.53,200.56 188.5,195.19 180,195 C171.08,194.8 163.86,198.94 157,204 C150.26,208.96 146.08,215.94 142,223 C138.57,228.93 136.93,235.52 135,242 C133.24,247.91 131.48,253.81 131,260 C130.46,267.04 131.24,274.02 132,281 C132.91,289.4 133.47,297.86 136,306 C138.24,313.21 142.07,319.63 146,326 C149.14,331.08 152.37,336.09 157,340 C161.43,343.74 165.94,347.33 172,348 C179.41,348.82 186.51,348.03 193,344 C200.4,339.4 204.93,332.4 209,325 C212.6,318.46 214.6,311.46 215,304 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M94,130 L88,349 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M38,129 L149,129 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="circle" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M400,220 C400,252.15 391.96,282.15 375.88,310 C359.81,337.85 337.85,359.81 310,375.88 C282.15,391.96 252.15,400 220,400 C187.85,400 157.85,391.96 130,375.88 C102.15,359.81 80.19,337.85 64.12,310 C48.04,282.15 40,252.15 40,220 C40,187.85 48.04,157.85 64.12,130 C80.19,102.15 102.15,80.19 130,64.12 C157.85,48.04 187.85,40 220,40 C252.15,40 282.15,48.04 310,64.12 C337.85,80.19 359.81,102.15 375.88,130 C391.96,157.85 400,187.85 400,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M650,310 L650,310 " style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="smcirc" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M270,220 C270,228.93 267.77,237.26 263.3,245 C258.84,252.74 252.74,258.84 245,263.3 C237.26,267.77 228.93,270 220,270 C211.07,270 202.74,267.77 195,263.3 C187.26,258.84 181.16,252.74 176.7,245 C172.23,237.26 170,228.93 170,220 C170,211.07 172.23,202.74 176.7,195 C181.16,187.26 187.26,181.16 195,176.7 C202.74,172.23 211.07,170 220,170 C228.93,170 237.26,172.23 245,176.7 C252.74,181.16 258.84,187.26 263.3,195 C267.77,202.74 270,211.07 270,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="ellips" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M400,220 C397.7,238.07 389.66,253.07 375.88,265 C356.73,281.59 333.99,291.02 310,297.94 C280.6,306.43 250.54,310 220,310 C189.46,310 159.4,306.43 130,297.94 C106.01,291.02 83.27,281.59 64.12,265 C50.34,253.07 40,239.31 40,220 C40,200.69 50.34,186.93 64.12,175 C83.27,158.41 106.01,148.98 130,142.06 C159.4,133.57 189.46,130 220,130 C250.54,130 280.6,133.57 310,142.06 C333.99,148.98 356.73,158.41 375.88,175 C389.66,186.93 397.7,201.93 400,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M400,220 C397.7,238.07 389.66,253.07 375.88,265 C356.73,281.59 333.99,291.02 310,297.94 C280.6,306.43 250.54,310 220,310 C189.46,310 159.4,306.43 130,297.94 C106.01,291.02 83.27,281.59 64.12,265 C50.34,253.07 40,239.31 40,220 C40,200.69 50.34,186.93 64.12,175 C83.27,158.41 106.01,148.98 130,142.06 C159.4,133.57 189.46,130 220,130 C250.54,130 280.6,133.57 310,142.06 C333.99,148.98 356.73,158.41 375.88,175 C389.66,186.93 397.7,201.93 400,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="if" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M220,100 L40,220 L220,340 L400,220 L220,100 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M220,100 L40,220 L220,340 L400,220 L220,100 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectLg" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50,50 L50,390 L390,390 L390,50 L50,50 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectSm" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M80,120 L80,320 L360,320 L360,120 L80,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectRLg" viewBox="0 0 440 440" preserveAspectRatio="none" width="100%" height="100%"><path d=" M50,70 50,370 M50,370 Q50,390 70,390 M70,390 370,390 M370,390 Q390,390 390,370 M390,370 390,70 M390,70 Q390,50 370,50 M370,50 70,50 M70,50 Q50,50 50,70 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectRSm" viewBox="0 0 440 440" preserveAspectRatio="none"><path d=" M100,140 100,300 M100,300 Q100,320 120,320 M120,320 320,320 M320,320 Q340,320 340,300 M340,300 340,140 M340,140 Q340,120 320,120 M320,120 120,120 M120,120 Q100,120 100,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="start" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M120,140 C102.24,142.46 85.58,148.13 70,157 C60.09,162.64 52.99,170.85 48,181 C42.26,192.67 39.36,204.95 40,218 C40.77,233.86 43.89,249.1 52,263 C59.12,275.2 69.8,283.44 82,290 C93.55,296.21 105.89,299.21 119,299 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M115,298 L324,297 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M113,139 L322,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M321,298 C339.79,297.71 356.79,292.04 372,281 C384.33,272.05 388.18,257.93 394,245 C397.43,237.37 399.28,229.4 399,221 C398.58,208.3 397.59,195.72 392,184 C386.52,172.51 379.03,162.74 368,156 C353.23,146.97 337.23,141.64 320,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M120,140 C102.24,142.46 85.58,148.13 70,157 C60.09,162.64 52.99,170.85 48,181 C42.26,192.67 39.36,204.95 40,218 C40.77,233.86 43.89,249.1 52,263 C59.12,275.2 69.8,283.44 82,290 C93.55,296.21 105.89,299.21 119,299 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="node" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M120,120 L40,220 L120,320 L320,320 L400,220 L320,120 L120,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="input" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M340,220 L120,240 L120,280 L330,280 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M320,280 L380,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="para" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M120,120 L80,320 L320,320 L360,120 L120,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="print" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M370,260 L370,120 L70,120 L70,290 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M69,285 C81.34,293.78 94.34,301.45 108,308 C118.9,313.23 130.2,317.32 142,320 C152.54,322.39 163.01,325.46 174,323 C192.95,318.76 210.1,310.18 227,301 C237.58,295.25 245.18,285.72 255,279 C264.27,272.66 273.32,265.94 284,262 C295.62,257.71 307.87,256.67 320,255 C336.93,252.66 353.93,251 371,250 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M370,260 L370,120 L70,120 L70,290 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="drum" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M370,120 L370,330 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M70,120 L70,330 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M68,319 C78.57,329.91 90.57,338.91 104,346 C115.3,351.96 127.59,354.66 140,357 C156.19,360.05 172.62,360.77 189,362 C199.32,362.77 209.65,363.13 220,363 C236.02,362.8 252.06,363.17 268,361 C286.65,358.46 305,354.52 323,349 C334.65,345.43 345.89,340.96 356,334 C361.79,330.01 365.79,324.68 368,318 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M370,120 C366.15,130.04 359.45,137.54 349.9,142.5 C332.65,151.47 313.96,155.69 295,158.97 C270.18,163.27 245.16,165 220,165 C194.84,165 169.82,163.27 145,158.97 C126.04,155.69 107.35,151.47 90.1,142.5 C80.55,137.54 70,133.48 70,120 C70,106.52 80.55,102.46 90.1,97.5 C107.35,88.53 126.04,84.31 145,81.03 C169.82,76.73 194.84,75 220,75 C245.16,75 270.18,76.73 295,81.03 C313.96,84.31 332.65,88.53 349.9,97.5 C359.45,102.46 366.15,109.96 370,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
        </svg>
	<div class="Tvis" id="texx" contenteditable="false" width="100%" height="100%" ></div>
    </div><!-- End tab1 -->
    <div class="tab-pane active" id="tab2"><!-- Start tab2 -->
       <textarea class="Thtm" id="texh" contenteditable="false" style="width:100%; height:100%;"></textarea>
    </div><!-- End tab2 -->
    <!-- /div --><!-- End col-sm-9 -->
    <!-- div class="col-sm-3" -->
	<!-- サブメニュー（左カラム） -->

	<!-- form name="selbox"><br><br>
	<p><label>課題名</label><br>
	<select id="comboboxA" list="list_A" onchange="changeCombA()" style="height:25px; width:180px;"></select>
	<!--input type="text" name="comboA" list="list_A" id="comboboxA" onchange="changeCombA()" autocomplete="off" style="height:25px; width:180px;" -->
	<!--datalist id="list_A"></datalist-->
	<!-- p><label>大分類</label><br>
	<select id="comboboxB"  onchange="changeCombB()" style="height:25px; width:180px;"></select>
	<p><label>中分類</label><br>
	<select id="comboboxC"  onchange="changeCombC()" style="height:25px; width:180px;"></select>
	<p><label>小分類</label><br>
	<select id="comboboxD"  onchange="changeCombD()" style="height:25px; width:180px;"></select>
	</form -->
    <!-- /div--><!-- End col-sm-3 -->
  </div><!-- End row -->
  </div><!-- End main tab-content -->
<!--/div><!-- End container-fluid -->
</body>
<script class="minify">
//
//Global変数など
//
    var cnsvg_field;
　　var cnsvg_nums=0;
    var wfcn_header;
    var cnsvg_header;
    var cnsvg_new_pk
    var cnsvg_tags=[];    // [{ name: "svg_01" ,pk:0}];
    var svg_step_flag=0;

    var svg_now='svg_00';
    var container;
    var org_container;

    var mv_flag=10;
    var isDrawing = false;
    var drawingPoints=[];
    var drawingPath=null;
    var Oper=0;
    var Step=0;
    var Svg_continue=0;
    var Svg_fig_count=0;
    var bz_path='';
    var bz_attribute='';
    var qd_path='';
    var qd_attribute='';
    var bezier_line='';
    var bezier_line1='';
    var first_point='';
    var key_shift=false;
    var my_header='';      //検索keyword群の読み込み用
    var header_term;
    var my_overview='';　　//popup概要のフラグとして使用
    var exe_script01='';
    var overview_term;
    var nav_links=[];
    var save_from="";

    var Editmode="Tvis";
    var Svg_mode=""
    var pre_Svg_mode="";
    var	Draw_mode="";
    var prev_Draw_mode="";
    var Drag_elem='';

   var image_root='';
   var image_pos=null;
   var image_width=200;


    var defaultPathStyle = {
        strokeWidth: "2",
        stroke: "#000",
        strokelinecap:"round",
        fill: "none",
    };
    var defaultCharStyle = {
        strokeWidth: "2",
        stroke: "#000",
        strokelinecap:"round",
        fill: "#000",
    };
    var defaultPointStyle = {
        strokeWidth: "1",
        stroke: "red",
	strokelinecap:"round",
        fill: "none",
    };
    var tempoPathStyle = {
        strokeWidth: "1",
        stroke: "red",
        fill: "none",
    };
    var tempoPathStyle2 = {
        strokeWidth: "1",
        stroke: "blue",
        fill: "none",
    };
    var defaultArrowStyle = '';
    var tempArrowStyle='';
    var defaultLineStyle="none";
    var exe_script03;

    var dumy_group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    dumy_group.setAttribute('fig', 'group');
//
//③System control(mouse handling)の設定
//mousedownのカウントとマウス動作判定用　dblclick,click,Move_mode(mouseupしていない）かの判定
//
    var clickCount = 0 ;
    var Up_count=0;
    var Move_mode=0;
    var mouse_Error=false;

    var first_container = document.getElementById('texx');
    var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);
//console.log('******mousedown set****',first_container);

    function draw_down( e ) {
	if(clickCount==0) Up_count=0;
	++clickCount ;
//console.log('mousedown');
	if(clickCount==1){             //最初のmousedown後から350ミリ秒待つ（その間clickをカウント）
		setTimeout(mouse_handle,350,e);　//dblclick,click,Move_modeかの判定は下の mouse_handle関数で実施
	}
    }

   var mouse_handle=function(e){
//console.log('enter mouse handle');
			Move_mode=0;
			var mode='';
			if(clickCount>=2){
				if(clickCount==Up_count) {
					key_shift=sfift_key(e);
					//console.log('Double clicked Shift=',key_shift);
					mode='dblclick';
				}
				else {
					//console.log('Pretend Double clicked');
					mode='dblclick';
					mouse_Error=true;
				}
			}
			else {
				if(clickCount==Up_count) {
					key_shift=sfift_key(e);
//					console.log('key_event=',key_event(e),'Clicked  Shift=',key_shift);
					mode='click';
				}
				else {
					Move_mode=1;
					//console.log('Down mode')
					mode='Move_mode';
					if(Drag_elem!='') {
						//console.log('Down mode Drag_elem=',Drag_elem);
						}
				}
			}
			//console.log('down=',clickCount,'Up_count=',Up_count,'mode=',mode,'Editmode=',Editmode);
		clickCount=0;
		Up_count=0;

	if ((Editmode=='Svg')&&(mode=='dblclick')) {
		dbl_click_func(e);
	}
	else if ((Editmode=='Svg')&&(mode=='click')){
		click_func(e);
	}
	else if ((Editmode=='Edit')&&(mode=='click')){
		Drag_elem=null;
		move_image_func(e);
		if(Drag_elem) document.getElementById("design_html").click();
//		catch_image();
//		Text_edit();
	}
   }//mouse handle end

//Backspaceキーを無効化する
$("#texx").keydown(function(e) {
console.log('key=',e.key);
	if (e.key === "Backspace"){
//		console.log("Backspaceキーが押されました");
//		return false;  Backspace 無効化
    		if(check_place_bs()==false) {
console.log('*backsp Not text');
			return false;
			}
		else  {
console.log('*backsp Text');
			return true;
			}
		}
	if (e.key === "Delete"){
    		if(check_place_del()==false) {
console.log('*delete Not text');
			return false;
			}
		else  {
console.log('*delete Text');
			return true;
			}
		}
   var res='';
   if(Editmode=="Edit")　{   //　Editモードの場合のみhtml変換
//console.log('Press key=',e.key);
	if(e.key==='Enter'){
		if(e.shiftKey){ //Shift+Enterの場合
//			var res="<br>"
			return true;
console.log('Shift Enter');
			}
		else {  //Enterの場合
console.log('Only Enter');
			if(doc_edit_node) {
				if(prev_doc_edit_style==null) prev_doc_edit_style='';
				if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
					if(prev_doc_edit_style) prev_doc_edit_node.setAttribute('style',prev_doc_edit_style);
					else prev_doc_edit_node.removeAttribute('style');
					}
				doc_edit_node='';
				}
    			var sel = window.getSelection();
    			if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    			var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!
			return true;
			}
		}
	}
});

/*
// 文書のCut処理をキャッチ ( oncut )
first_container.oncut = function() {
	var range=window.getSelection();
//console.log('*cut event catch',range);
}
*/

//Move_modeならばmouseの動きについての処理を記述する
//    var hand_move=org_container.addEventListener('mousemove', draw_move,false);
document.onmousemove = function( e ) {
//console.log('** Draw_mode=',Draw_mode,'Move_mde=',Move_mode,'Svg_mode=',Svg_mode);
  if(Move_mode) {
    switch (Draw_mode){
      case 'Aux':
      case 'Drag':
        	if (drag.isMouseDown == true) {
			drag.target.transform.baseVal[0].matrix.e=drag.target.transform.baseVal[0].matrix.e+e.clientX - drag.offsetx;
			drag.target.transform.baseVal[0].matrix.f=drag.target.transform.baseVal[0].matrix.f+e.clientY - drag.offsety;
			drag.offsetx = e.clientX;
			drag.offsety = e.clientY;
//console.log(drag.offsetx);
		}
		break;
      case 'Text':
        	if (drag.isMouseDown == true) {
//console.log('**Image drag');
  			var x = e.clientX;
  			var y = e.clientY;
  			var width = drag.target.offsetWidth;
  			var height = drag.target.offsetHeight;
  			drag.target.style.top = (y-height/2) + "px";
  			drag.target.style.left = (x-width/2) + "px";
		}
		break;
      case 'Basic':
      case 'Path':
      case 'Draw':
		draw_move(e);
		break;
       default:
//console.log('Area catch');
		draw_move(e);
		break;
	}
   }
}//mousemove end

//mouseup時の処理
//    var hand_up=org_container.addEventListener('mouseup', draw_up,false);
document.onmouseup = function (e) {
　　　　//console.log('mouse up');
		var range=window.getSelection();
		if(range!='') {
//console.log('selection=',range);
			}
　　　　	++Up_count;
		drag.isMouseDown = false;
　　　　	if(mouse_Error) {
　　　　　　		mouse_Error=false;
　　　　　　		Up_count=0;
　　　　　　		}
　　　　	if(Move_mode) {
　　　　　　//console.log('canceled Move_mode');
    			switch (Draw_mode){
      		 	   case 'Aux':
console.log('** element drag stop');
				drag.isMouseDown = false;
				draw_op.aux_pos=e.clientX;
				break;
      			   case 'Basic':
	  		    default:
console.log('** element draw stop');
				draw_up(e);
				break;
				}
			Move_mode=0;
			Up_count=0;
console.log('After basic_moveup=',Up_count);
   			}
    }//mouseup end

//Singleクリック時(Step 0)の処理を入れる
var add_del_P=false;
var click_func=function(e){
console.log('Single Click(Step 0) Step=',Step);
    switch (e.which) {
        case 1:
		add_del_P=false;
console.log('Svg_mode=',Svg_mode,'svg_step=',svg_step_flag)
		if(Svg_mode=='Svg_updown' && svg_step_flag==0) {
			//図形の反転処理
			drag.offsetx = e.clientX;
			drag.offsety = e.clientY;
			svg_step_flag=1;
			document.getElementById("fig_updown").click();
			}

//shift無しのclickで処理する	if(key_shift && Svg_mode=='Selected') {
//console.log('cancel point from selected points');
//			}
//            alert('Left Mouse button pressed.');
            break;
        case 2:
		add_del_P=false;
//            alert('Middle Mouse button pressed.');
            break;
        case 3:
		add_del_P=true;
console.log('**Right mouse button pressed Svg mode=',Svg_mode);
//            alert('Right Mouse button pressed.');
		if(Svg_mode=="Svg_reshape_pending") {
console.log('Point add or del stage start');
			var xp=e.clientX;
			var yp=e.clientY;
			catch_adddel_point(Drag_elem,xp,yp);
/*
			len=Drag_elem.children.length;
				for(var k=len-1;k>0;k--){
				var tagn=Drag_elem.children[k];
				//console.log('k= ',k,tagn);
				Drag_elem.removeChild(tagn);
				}
			path_p=resolv_figure(Drag_elem);
			var error=path_to_circle(tagn,path_p);
*/
			}
		if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")) {
console.log('SVG text edit stage start');
			svg_text_edit(Drag_elem,e);
			}
		if(Svg_mode=="Selected") {
console.log('Simplify Tags or Redraw Tags=',drag.group); 

             		document.getElementById('contextmenu_a').style.left=e.pageX+"px";
                	document.getElementById('contextmenu_a').style.top=e.pageY+"px";
		        document.getElementById('contextmenu_a').style.display="block";

       			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
			var fig_id='g'+(Date.now()).toString();
			wgroup.setAttribute('id', fig_id);
			wgroup.setAttribute('fig', 'group');
			var g_temp=drag.target.appendChild(wgroup);
			var error=plane_simple_fig(g_temp,drag.target,drag.group);
			if(error==0) {
				for(let i=0;i<drag.group.length;i++) {
					drag.target.removeChild(drag.group[i]);
					}
				}
			else {
				drag.target.removeChild(g_temp);
				}
			drag.target=null;
			drag.group=null;
			Svg_mode=="";
			return;

			}
            break;
		add_del_P=false;
        default:
//            alert('You have a strange Mouse!');
    }
	if(Draw_mode){
		if(Draw_mode=='Basic'){
console.log("Draw Basic mode");
			draw_op.posy=e.clientY;
			draw_basic(e);
			}
		if(Draw_mode=='Draw'){
			click_func3(e);
			}
		}
	else if(Svg_mode=='Selected') {
console.log('cancel one from selected tags');
		var xp=e.clientX;
		var yp=e.clientY;
    		var leng=drag.group.length;      	//  drag.group=g_list;
console.log('g_list leng= ',drag.group.length,drag.group);
    		for (var i=0 ;i<leng ;i++){
			tagn=drag.group[i].rect01;
			var result=catch_figure(tagn,xp,yp);
			if(result){
console.log('cancel tag=',drag.group[i]);
				container.removeChild(drag.group[i].rect01);
				drag.group.splice(i,1);
				break;
				}
			}
		}
	else click_func2(e);
	} //Single Click(Step 0) End

function svg_text_edit(Drag_elem,e) {
	var fig_class=Drag_elem.getAttribute('fig');
	if(fig_class=='text') {
		text_dialog();
		}
	else {

             		document.getElementById('contextmenu_b').style.left=e.pageX+"px";
                	document.getElementById('contextmenu_b').style.top=e.pageY+"px";
		        document.getElementById('contextmenu_b').style.display="block";

/*
		var len=Drag_elem.children.length;
		for(let n=0;n<len;n++) {
			var tagn=Drag_elem.children[n];
console.log('child n=',n,tagn);
			if(tagn.nodeName=='path') {
				Object.assign(tagn.style, defaultPathStyle);
console.log('再描画');
				}
			}
*/
		}
   	}

function make_group(fig){
	var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
	var fig_id='g'+(Date.now()).toString();
	group.setAttribute('id', fig_id);
	group.setAttribute('fig', fig);
	group.setAttribute('class', 'group');
	elem=container.appendChild(group);
console.log('make_group=',group,fig_id);
	var result=check_hist(container,elem,'add');
	return {group:group,fig_id:fig_id};
   }

var svg_hist_max=5;
var svg_hist_maxlen=10000;
var svg_hist=[];
var svg_undo=[];
var hist_parent=document.getElementById("wClone");

function check_hist(cont,group,flag) {
	var hist_leng=svg_hist.length;
	var undo_leng=svg_undo.length;
console.log('hist_leng=',hist_leng,' hist=',svg_hist,' undo_leng=',undo_leng);
	for(let k=0;k<undo_leng;k++) {
		if(svg_undo[k].flag=='add') {
			var dtag=document.getElementById(svg_undo[k].group);
			hist_parent.removeChild(dtag);
			}
		}
	svg_undo=[];
	
	var cont_id=container.getAttribute('id');
	var g_id=group.getAttribute('id');
console.log('new_history flag=',flag,cont_id,g_id);
	var leng=0;
	if(flag=='del') {
		temp_delete(group);
		var tagn=group.cloneNode(true);
		var tag_char = new XMLSerializer().serializeToString(tagn);
		leng=tag_char.length;
		}
	var tot_leng=leng;
	for(let k=0;k<svg_hist.length;k++) tot_leng=tot_leng+svg_hist[k].leng;
	if(svg_hist.length>svg_hist_max) tot_leng=tot_leng-svg_hist[0].leng;
	var result;
	var result2=2;
console.log('Total leng=',tot_leng,leng);
	if(tot_leng>svg_hist_maxlen) {
		var result2 = window.confirm('元に戻せません。本当に削除しますか？');
		}
	if(result2==1) {
			svg_hist=[];
			result=1;
			while( hist_parent.firstChild ){
  				hist_parent.removeChild( hist_parent.firstChild );
				}
		}
	if(result2==2) {
		result=1;
		svg_hist.push({flag:flag,cont:cont_id,group:g_id,leng:leng});
		if(flag=='del') hist_parent.appendChild(tagn);
		if(svg_hist.length>svg_hist_max) {
			if(svg_hist[0].flag=='del') {
				var dtag=document.getElementById(svg_hist[0].group);
console.log('dtag id=',svg_hist[0].group,dtag);
				hist_parent.removeChild(dtag);
				}
			svg_hist.shift();
			}
		}
	if(result2==0) result=0;
console.log('hist=',svg_hist);
	return result;
	} //End check_hist

   $("#svg_undo").on("click", function() {
	if(svg_hist.length>0) {
		var list=svg_hist.pop();
console.log('list=',list);
		if(list.flag=='add') {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			container.removeChild(dtag);
			hist_parent.appendChild(tagn);
			}
		else {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			hist_parent.removeChild(dtag);
			container.appendChild(tagn);
			}
		svg_undo.push(list);
		}
console.log('hist=',svg_hist,svg_undo);
	});

   $("#svg_redo").on("click", function() {
	if(svg_undo.length>0) {
		var list=svg_undo.pop();
		if(list.flag=='add') {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			hist_parent.removeChild(dtag);
			container.appendChild(tagn);
			}
		else {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			container.removeChild(dtag);
			hist_parent.appendChild(tagn);
			}
		svg_hist.push(list);
		}
console.log('undo=',svg_undo,svg_hist);
	});

var html_hist_max=5;
var html_hist_maxlen=10000;
var html_hist=[];
var html_undo=[];

function check_html_hist(tag,tag_tree,level,flag) {
	var hist_leng=html_hist.length;
	var undo_leng=html_undo.length;
console.log('hist_leng=',hist_leng,' hist=',html_hist,' undo_leng=',undo_leng);
	for(let k=0;k<undo_leng;k++) {
		if(html_undo[k].flag=='add') {
			var dtag=document.getElementById(html_undo[k].id);
			hist_parent.removeChild(dtag);
			}
		}
	html_undo=[];
	
	var id_flag=0;
console.log('*****new_history flag=',flag,level,tag);
	var leng=0;
	if(flag=='del') {
		cancel_green_line();
		var idn=tag.getAttribute('id');
		if(idn==null) {
			var idn='h'+(Date.now()).toString();
			tag.setAttribute('id', idn);
			id_flag=1;
console.log('not origin id=',idn);
			}
		var tagn=tag.cloneNode(true);
		var tag_char = new XMLSerializer().serializeToString(tagn);
		leng=tag_char.length;
		}
	var tot_leng=leng;
	for(let k=0;k<html_hist.length;k++) tot_leng=tot_leng+html_hist[k].leng;
	if(html_hist.length>html_hist_max) tot_leng=tot_leng-html_hist[0].leng;
	var result;
	var result2=2;
console.log('Total leng=',tot_leng,leng);
	if(tot_leng>html_hist_maxlen) {
		var result2 = window.confirm('元に戻せません。本当に削除しますか？');
		}
	if(result2==1) {
			html_hist=[];
			result=1;
			while( hist_parent.firstChild ){
  				hist_parent.removeChild( hist_parent.firstChild );
				}
		}
	if(result2==2) {
		result=1;
		html_hist.push({flag:flag,level:level,id_flag:id_flag,tag_id:idn,leng:leng,tree:tag_tree});
console.log('add hist leng=',html_hist.length);
		if(flag=='del') {
			hist_parent.appendChild(tagn);
			}
		if(html_hist.length>html_hist_max) {
			if(html_hist[0].flag=='del') {
				var dtag=document.getElementById(html_hist[0].tag_id);
console.log('dtag id=',html_hist[0].tag_id,dtag);
				hist_parent.removeChild(dtag);
				}
			html_hist.shift();
			}
		}
	if(result2==0) result=0;
console.log('html hist=',html_hist);
	return result;
	} //End check_html_hist

   $("#html_undo").on("click", function() {
	if(html_hist.length>0) {
		var list=html_hist.pop();
console.log('html_list=',list);
		if(list.flag=='add') {
			list.id_flag=0;
			var dtag=get_from_tag_tree(list.flag,list.level,list.tree);
			var tag_id=dtag.getAttribute('id');
			if(tag_id==null) {
				var idn='h'+(Date.now()).toString();
				dtag.setAttribute('id', idn);
				list.tag_id=idn;
				list.id_flag=1;
				}
			var tagn=dtag.cloneNode(true);
			dtag.remove();
			hist_parent.appendChild(tagn);
console.log('cancel tag=',tagn);
			}
		else {
			var dtag=document.getElementById(list.tag_id);
			var tagn=dtag.cloneNode(true);
			if(list.id_flag==1) tagn.removeAttribute('id');
			hist_parent.removeChild(dtag);
			set_tag_to_tree(list.flag,list.level,list.tree,tagn)
			}
		html_undo.push(list);
		}
console.log('html hist=',html_hist,html_undo);
	});

   $("#html_redo").on("click", function() {
	if(html_undo.length>0) {
		var list=html_undo.pop();
		if(list.flag=='add') {
			var dtag=document.getElementById(list.tag_id);
			var tagn=dtag.cloneNode(true);
			hist_parent.removeChild(dtag);
			if(list.id_flag==1) tagn.removeAttribute('id');
			set_tag_to_tree(list.flag,list.level,list.tree,tagn)
			}
		else {
			list.id_flag=0;
			var dtag=get_from_tag_tree(list.flag,list.level,list.tree);
			var tag_id=dtag.getAttribute('id');
			if(tag_id==null) {
				var idn='h'+(Date.now()).toString();
				dtag.setAttribute('id', idn);
				list.tag_id=idn;
				list.id_flag=1;
				}
			var tagn=dtag.cloneNode(true);
			dtag.remove();
			hist_parent.appendChild(tagn);
console.log('cancel tag=',tagn);
			}
		html_hist.push(list);
		}
console.log('html undo=',html_undo,html_hist);
	});

function get_from_tag_tree(flag,level,tree) {
console.log('Get tag from tree Top node=',tree[tree.length-1].node,tree);
	var t_node=document.getElementById(tree[tree.length-1].node);
    	for(let i=tree.length-1;i>=0;i--) {
		nn=tree[i].ind;
		if(level==tree[i].level) {
			if(level==0) {
				if(flag=="add") new_node=t_node.children[0];
				else new_node=t_node.children[0];
				}
			else {
				if(flag=="add") new_node=t_node.children[nn+1];
			        else new_node=t_node.children[nn];
				}
			t_node=new_node;
console.log('match tag=',t_node,tree[i],'level=',level);
			break;
			}
		else {
			if(i<tree.length-1) {
				new_node=t_node.children[nn];
				t_node=new_node;
				}
console.log('chidren i=',i,tree[i],tree[i+1],t_node.children);
			}
		}
	return t_node;
}

function set_tag_to_tree(flag,level,tree,tag) {
console.log('Set tag to tree Top node=',tree[tree.length-1].node,tree);
	var t_node=document.getElementById(tree[tree.length-1].node);
    	for(let i=tree.length-1;i>=0;i--) {
		nn=tree[i].ind;
		if(level==tree[i].level) {
console.log('set tag=',t_node,tree[i],'level=',level);
			cancel_green_line();
			if(level==0) {
				if(flag=="add") t_node.insertBefore(tag, t_node.firstChild);
				else t_node.insertBefore(tag, t_node.firstChild);
				}
			else {
				t_node=t_node.children[nn];
				if(flag=="add") $(tag).insertAfter(t_node);
			     	else $(tag).insertBefore(t_node);
				}
			break;
			}
		else {
			if(i<tree.length-1) {
				new_node=t_node.children[nn];
console.log('chidren i=',i,tree[i],tree[i+1],t_node.children);
				t_node=new_node;
				}
			}
	}
}

//Click+Shiftキーが押された時は水平又は垂直のLineを描く
function mend_points() {
	let leng=drawingPoints.length;
	if(Math.abs(drawingPoints[leng-1].x-drawingPoints[leng-2].x)>Math.abs(drawingPoints[leng-1].y-drawingPoints[leng-2].y)){
		drawingPoints[leng-1].y=drawingPoints[leng-2].y;
		}
	else {
		drawingPoints[leng-1].x=drawingPoints[leng-2].x;
		}
//console.log(drawingPoints[leng-1],drawingPoints[leng-2]);
   }

//④HTML　edit
//
//DisplayモードとEditモードの切り替え
//
//Tvis（only displayモード）、Edit(visual edit)  Html（Html表示モード）、SVG（SVG　editモード）の切り替え
//
function chng_mode(){
console.log('**Enter change mode from**',Editmode)
    //選択したf_editによって分岐
    switch (fgedit.selectedIndex){
      case 0:               //     Visual mode
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texx" ).style.zIndex ='40';
		document.getElementById( "texh" ).style.zIndex ='20';
		if(Editmode=="Thtm"){
			//unescape_text();
			document.getElementById("texx").innerHTML=unescapeHtml(document.getElementById("texh").value);
			}
		document.getElementById("texx").contentEditable = false;
    		var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);

		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';
		document.getElementById(svg_now).style.display="block";

		Editmode="Tvis";
		//document.getElementById("texx").focus();
		return_scroll();

console.log('**Enter change mode To**',Editmode)
		break;
      case 1:               //     Edit mode
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texx" ).style.zIndex ='40';
		document.getElementById( "texh" ).style.zIndex ='20';
		if(Editmode=="Thtm"){
//			unescape_text();
//			document.getElementById("texx").innerHTML=document.getElementById("texh").innerHTML;
//			document.getElementById("texx").innerHTML=unescapeHtml(document.getElementById("texh").innerHTML);
			document.getElementById("texx").innerHTML=unescapeHtml(document.getElementById("texh").value);
			}
		document.getElementById("texx").contentEditable = true;
    		var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);

		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';
		document.getElementById(svg_now).style.display="block";

		Editmode="Edit";
		return_scroll();

		//document.getElementById("texx").focus();
console.log('**Enter change mode To**',Editmode,'svg_now=',svg_now)
		break;
      case 2: 
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texh" ).style.zIndex ='10';
		document.getElementById( "texx" ).style.zIndex ='40';
		//document.getElementById( "texx" ).style.zIndex ='10';
    		var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);
//    		var hand_down=org_container.addEventListener( 'mousedown', draw_down,false);
		if(Editmode=="Thtm"){
			document.getElementById("texx").innerHTML=unescapeHtml(document.getElementById("texh").value);
			}

		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';

		set_svg(svg_now);
		document.getElementById(svg_now).style.display="block";

		Editmode="Svg";
		chang_svg();
		no_scroll();

console.log('**Enter change mode To**',Editmode,'svg_now=',svg_now)
		break;
      case 3: 
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texh" ).style.zIndex ='40';
		document.getElementById( "texx" ).style.zIndex ='20';
		escape_text();
		document.getElementById("texh").value=document.getElementById("texx").innerHTML;
		document.getElementById("texh").contentEditable = true;

		nodisp=document.getElementById('tab1');
        	nodisp.style.display='none';
        	disp=document.getElementById('tab2');
        	disp.style.display='block';
		document.getElementById(svg_now).style.display="none";

		Editmode="Thtm";
		return_scroll();

console.log('**Enter change mode To**',Editmode,'svg_now=',svg_now)
		break;
    }
    change_css(Editmode);
    chng_menu(Editmode);
}

function chng_menu(Editmode){        /*   取り敢えずのメニュー切り替え　*/
    switch (Editmode){
      case 'Tvis':               //     Visual mode
      case 'Edit':               //     Visual edit mode
		menu01=document.getElementById('menu01');
       		menu01.style.display='block';
		menu02=document.getElementById('menu02');
       		menu02.style.display='none';
		menu03=document.getElementById('menu03');
       		menu03.style.display='none';
		break;
      case 'Svg':               //     SVG mode
		menu01=document.getElementById('menu01');
       		menu01.style.display='none';
		menu02=document.getElementById('menu02');
       		menu02.style.display='block';
		menu03=document.getElementById('menu03');
       		menu03.style.display='none';
		break;
      case 'Thtm':               //     Html mode
		menu01=document.getElementById('menu01');
       		menu01.style.display='none';
		menu02=document.getElementById('menu02');
       		menu02.style.display='none';
		menu03=document.getElementById('menu03');
       		menu03.style.display='block';
		break;
	}
}

function change_css(Editmode) {

	if(Editmode=="Svg"){
      		document.getElementById('svg_00').classList.remove('point_none');
		document.getElementById('svg_00').classList.add('point_auto');
console.log('pointable');
		user_select('none');
		}
	else {
		document.getElementById('svg_00').classList.remove('point_auto');
      		document.getElementById('svg_00').classList.add('point_none');
console.log('point none');
		user_select('auto');
		}

	for(var i=0;i<cnsvg_tags.length;i++){
		var svg_tag=cnsvg_tags[i].name;
		if(Editmode=="Svg"){
      			document.getElementById(svg_tag).classList.remove('point_none');
			document.getElementById(svg_tag).classList.add('point_auto');
console.log('pointable');
			user_select('none');
			}
		else {
			document.getElementById(svg_tag).classList.remove('point_auto');
      			document.getElementById(svg_tag).classList.add('point_none');
console.log('point none');
			user_select('auto');
			}
		}

	var mark = document.getElementsByClassName('chain_svg_mark');
	for(var i=0;i<mark.length;i++){
		if(Editmode=='Svg' || Editmode=='Edit'){
			mark[i].setAttribute('style', 'display:block;');
console.log('svg_mark');
			}
		else {
			mark[i].setAttribute('style', 'display:none;');
			}
		}

   } //End of change_css

function user_select(mode) {

	if(mode=="none"){
		document.getElementById('svg_00').classList.remove('select_auto');
      		document.getElementById('svg_00').classList.add('select_none');
console.log('select none');
		}
	else {
      		document.getElementById('svg_00').classList.remove('select_none');
		document.getElementById('svg_00').classList.add('select_auto');
console.log('selectable');
		}

	for(var i=0;i<cnsvg_tags.length;i++){
		var svg_tag=cnsvg_tags[i].name;
		if(mode=="none"){
			document.getElementById(svg_tag).classList.remove('select_auto');
      			document.getElementById(svg_tag).classList.add('select_none');
console.log('select none');
			}
		else {
      			document.getElementById(svg_tag).classList.remove('select_none');
			document.getElementById(svg_tag).classList.add('select_auto');
console.log('selectable');
			}
		}
   } //End of select_none

function expand_svg(svtex,svg_tagn) {
　　　const svg = document.getElementById(svg_tagn);
      if(svtex!=''){
	  	var n_s=0;
	  	var i=0;
	  	var n_last=svtex.length;
	  	do {
             		i = i + 1;
      	     		n_e = svtex.indexOf('|<=>|',n_s );
	     		if(n_e<0) {
				n_e=n_last;
				}	     
console.log('num=',i,' n_start and n_last=',n_s,n_e,n_last);
	     		text_n=svtex.substring(n_s , n_e);
console.log('num= ',i,' tex= ',text_n)
	     		n_s=n_e+5;
             		const domParser = new DOMParser();
　　	     		parsedSVGDoc = domParser.parseFromString(text_n, 'image/svg+xml');
   	    		 parsedSVG = parsedSVGDoc.childNodes[0];
　　	     		svg.appendChild(parsedSVG);
	     		svg.lastChild.outerHTML=text_n
	     		Svg_fig_count+=1;
console.log('***SVG fig count= ',Svg_fig_count)
	     		} while (n_s < n_last);
	     	//first childをcontainerとする
console.log('***open g01 group as container');
	     	container=svg.children[1];
console.log('**parent= ',svg,'container=',container);
		var fig_id=container.getAttribute('id');
console.log('container id=',fig_id);
	  	}
	else {　//読み込むsvgデータがない場合はid=g01の<g>タグを作成してcontainerとする。
console.log('***make g01 group as container');
		container=svg;
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		container=group;
		}
    }//End of expand_svg

    function escape_text(){
//document text部(divsvgタグの取得）とescape処理

	var k=svg_tag_menu.length;
console.log(svg_tag_menu,svg_tag_menu.options[0].value,'leng=',k);

	for(let i=0;i<k ;i++) {
		var div_tag='div'+svg_tag_menu.options[i].value;
		var tag=document.getElementById(div_tag);
//		var tagn=tag.cloneNode(true);
//console.log('tag=',tagn,'new=',newdiv);
		tags_escape_text(tag);
console.log('escaped=',tag);
		}
	} //End of escape_text

    function tags_escape_text(tag) {
//console.log('tag=',tag);
	var len=tag.childNodes.length;
	if(len>0) {
//console.log('tag node=',tag.nodeName);
		for(var k=0 ;k<len ;k++){
			var tagn=tag.childNodes[k];
			tags_escape_text(tagn);
			}
console.log('tags escaped=',tag);
		}
	else {
//console.log('last node=',tag.nodeName);
		if(typeof(tag)=='string') {
			tag=escapeHtml(tag);
			}
		else {
			tag.textContent=escapeHtml(tag.textContent);
			}
console.log('simple tag escaped=',tag);
		}
	}

    function chng_shift() {
    const selectedText = window.getSelection().toString();
console.log(selectedText);
    var align_tx;

    var sel = window.getSelection();
    if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了

    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!

    switch (Shift.selectedIndex){
      case 0:               
		align_tx='text-align: left;';
		break;
      case 1:               
		align_tx='text-align: center;';
		break;
      case 2:               
		align_tx='text-align: right;';
		break;
		}

    var newNode = document.createElement('p');
    newNode.setAttribute('style', align_tx);
    newNode.setAttribute('fig', '段落');
    newNode.innerHTML =  sel.toString();   //選択文字列をnewNodeとして設定
    range.deleteContents();    // 範囲選択箇所を一旦削除
    range.insertNode(newNode); // 前後に<b>と</b>を入れる。
    }

    function chng_list() {
var range = window.getSelection().getRangeAt(0);
var  content = range.extractContents();
//console.log(content);

span = document.createElement('SPAN');
span.setAttribute('fig', '強調');
span.appendChild(content);
var contenthtml = span.innerHTML;
//console.log(contenthtml);
    var newNode;

var string = (contenthtml.replace(/(<([^>]+)>)/ig,'|<=>|')).split('|<=>|');
console.log(string.length,string);

    if(!contenthtml) return; //範囲選択されている箇所がない場合は何もせず終了

    switch (List.selectedIndex){
      case 0:               
		break;
      case 1:               
		newNode = document.createElement('ul');
		break;
      case 2:               
		newNode = document.createElement('ol');
		break;
		}
//console.log(newNode);
	for (var i=0; i<string.length; i++){
	if(string[i]!="") {
        	var li=document.createElement('li');
//console.log(li,newNode);
        	newNode.appendChild(li);
        	li.innerHTML=li.innerHTML + string[i];
		}
	}

    	//newNode.innerHTML =  sel.toString();   //選択文字列をnewNodeとして設定
    	range.deleteContents();    // 範囲選択箇所を一旦削除
    	range.insertNode(newNode); // 前後に<ul>と</ul>を入れる。

    }

    link.onclick = function() { 
    const selectedText = window.getSelection().toString();
console.log('link sel=',selectedText);

    var sel = window.getSelection();
    if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!

    var newNode =document.createElement('a');
    newNode.setAttribute('fig', 'リンク');
    var user = window.prompt("link先を入力してください", "");
    newNode.href = user;
    newNode.innerHTML = selectedText;   //tag部分に<>を含むと変更出来ない。
console.log('sel_chara=',selectedText,'link=',user);
    newNode.setAttribute('target', '_blank');
    newNode.setAttribute('rel', 'noopener');
    range.deleteContents();    // 範囲選択箇所を一旦削除
    range.insertNode(newNode);
//    window.getSelection().removeAllRanges();
    }

/*
function set_image(){
//move_image_func(e)と連動して画像配置を決める
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
    switch (image_set.selectedIndex){
      case 0:               
		break;
      case 1:               
console.log('from Local');
		//image_pos=catch_caret();
//console.log('image_pos=',image_pos);
//		if(image_pos=='') break;
		local_image();
		//image_set.value='s001';
		break;
      case 2:               
console.log('from My_DB');
//		image_pos=catch_caret();
//console.log('image_pos=',image_pos);
//console.log('image_pos_common=',image_pos.commonAncestorContainer.parentNode);
//var position=image_pos.commonAncestorContainer.parentNode;
//var image_width=position.clientWidth;
//console.log('width=',position.clientWidth);
//		if(image_pos=='') break;
		db_image();
		//image_set.value='s001';
		break;
      case 3:               
console.log('Space placement');
		image_pos=catch_caret();
		if(image_pos=='') break;
		space_set();
		//image_set.value='s001';
		break;
      case 4:               
console.log('image placement');
		Svg_mode='image';
		image_root='fixed';		
		break;
      case 5:               
console.log('delete image');
		Svg_mode='image';
		image_root='fixed';
		break;
	}
   }
*/

function image_first_set(param){
console.log('Enter to image_first_set');
	if(photo_type=='flex') {
		var a_fig=doc_edit_node.parentNode;
console.log('photo_type flex node=',a_fig);
		a_fig.innerHTML='';
		a_fig.setAttribute('fig', 'figure');
//		var fig_id='g'+(Date.now()).toString();
//		a_fig.setAttribute('id', fig_id);
		var a_imag = document.createElement('img');
		var title='写真の説明';
		var alt='';
		if(document.getElementById('im_pam5').value) title=document.getElementById('im_pam5').value;
		var figcap = document.createElement('figcaption');
		figcap.innerHTML=title;
		if(document.getElementById('im_pam4').value) alt=document.getElementById('im_pam4').value;
		if(alt) a_imag.setAttribute('alt', alt);
		figcap.setAttribute('align', 'center');
		a_imag.setAttribute('fig', 'img');
		a_imag.src=param;
console.log('a_img=',a_imag);
		var rect=a_fig.getBoundingClientRect();
console.log('context_pos=',rect);
		var width=rect.right-rect.left;
		width=Math.round(Number(width*10/10));
		width=String(width);
console.log('width=',width);
		//a_imag.setAttribute('width', width);
		parms='width:'+width+';';
		a_imag.setAttribute('atyle', parms);
		a_fig.appendChild(a_imag);
		a_fig.appendChild(figcap);
		var figcap2 = document.createElement('p');
		figcap2.innerHTML='更なる解説';
		a_fig.appendChild(figcap2);
		doc_edit_node=a_fig;
    		tag_trees=[];
    		tag_trees=get_tagStruct(doc_edit_node,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		display_current_tag(doc_edit_node);
		}
	else {
		// figureタグを生成
//alert('絵写真の配置は小枠内のみです。');
//		return;
		var a_fig=doc_edit_node;
console.log('photo_type new node=',a_fig);
		var a_imag = document.createElement('img');
		a_imag.src=param;
console.log(a_imag.src);
		//if(document.getElementById('im_pam1').value) width=document.getElementById('im_pam1').value;
		//if(document.getElementById('im_pam2').value) height=document.getElementById('im_pam2').value;
		var width='200px';
		a_imag.setAttribute('fig', 'img');
		//a_imag.setAttribute('width', width);
		//a_imag.setAttribute('align', 'left');
		parms='width:'+width+';'+'float:left; margin-right:20px;'
		//if(height) a_imag.setAttribute('height', height);
		a_imag.setAttribute('style', parms)
		a_fig.appendChild(a_imag);
		figcap.setAttribute('style', 'text-align:center;');
		var title='写真の説明';
		var alt='';
		if(document.getElementById('im_pam5').value) title=document.getElementById('im_pam5').value;
		var figcap = document.createElement('figcaption');
		figcap.innerHTML=title;
		if(document.getElementById('im_pam4').value) alt=document.getElementById('im_pam4').value;
		a_img.appendChild(figcap);
		if(alt) a_imag.setAttribute('alt', alt);		
		var figcap2 = document.createElement('p');
		figcap2.innerHTML='更なる説明';
		a_fig.appendChild(figcap2);
console.log('not found in flex_box');
    		tag_trees=[];
    		tag_trees=get_tagStruct(doc_edit_node,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		display_current_tag(doc_edit_node);
		}
   }

function search_imgtag(tag) {
//console.log('Enter search_imgtag tag=',tag);
	var flex_tag='';
	src_flg=1;
	var dmtag=tag;
	do {
		var flex=dmtag.getAttribute('class');
//console.log('flex=',flex,' tag=',dmtag);
		if(flex=='flex') {
			flex_tag=dmtag;
			src_flg=0;
			}
		else {
			if(flex=='svg') src_flg=0
			else dmtag=dmtag.parentNode;
			}
	} while (src_flg);
	return flex_tag;
	}

function space_set(){

	var range=catch_caret();

	// figureタグを生成
	var a_fig= document.createElement('div');
	a_fig.setAttribute('style', 'float:left;');
	a_fig.setAttribute('fig', 'image');
	var fig_id='g'+(Date.now()).toString();
	a_fig.setAttribute('id', fig_id);

	var a_imag = document.createElement('img');
	a_imag.setAttribute('width', '100px');
	a_imag.setAttribute('height', '50px');

	a_fig.appendChild(a_imag);
//	$(a_fig).insertAfter('#svg_00');
	range.insertNode(a_fig);

	let rgbColor = document.getElementById(fig_id).style.backgroundColor;
	let color = new RGBColor(rgbColor);
	let hexColor = color.toHex();

//	var dummy='border:solid 1px '+hexColor+';';
	var dummy='border:0px none;';
console.log('border=',dummy,'color=',rgbColor,hexColor);
	a_imag.setAttribute('style', dummy);

   }

function catch_caret() {

    const selectedText = window.getSelection().toString();
//console.log('**Image position at text=',selectedText);
    if(Editmode!='Edit') {
		alert('Only Edit mode');
		return;
		}
    var sel = window.getSelection();
	try {
		    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!
//console.log('sel=',sel,' range=',range);
		} catch (error) {
//  	alert('not specifyed cursor position');
	var range = document.createRange();
	var node = document.getElementById("texx").childNodes[1];
console.log('node=',node);
	range.setStart(node, 0);
	range.setEnd(node, 3);
	}
    return range;

}

//function jump to url test
function  jump_to_url() {
console.log('jump to URL test');

	make_url(String(25));

	const flag = true;
	try {
	    if (flag) {
        	throw new Error('終了します');
    		}
    	console.log('実行されないコード');

	} catch (e) {
    		console.log(e.message);
if (window === window.top) {
console.log('It is a top-level browsing context and history=',history.length);
			}
		window.close();
		}
   }

//function chara start
    Tochara.onclick = function() {
	const selectedText = window.getSelection().toString();
	fw_colval=document.querySelector('#trig1').style.backgroundColor;
	bk_colval=document.querySelector('#trig2').style.backgroundColor;
console.log('Sel_text=',selectedText,'color=',fw_colval);

	var sel = window.getSelection();
  	if(!sel.rangeCount) return; 

  	var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
  	var font = document.createElement("span");
  	font.style.color = fw_colval;
  	font.style.backgroundColor=bk_colval;
  	range.surroundContents(font);

	//  var span = document.createElement("span");     //OK
	//  span.style.color = colval;
	//  range.surroundContents(span);

	}  //function chara end

    Cr_To_Br.onclick = function() {

	const selection = window.getSelection();
	if(!selection.rangeCount) return; 
	
	var range = selection.getRangeAt(0);
	// 選択範囲を含む親タグを取り出す
//console.log('rang parent=',range.commonAncestorContainer);
	const dom=range.commonAncestorContainer;
//console.log('dom=',dom);

	// pタグを取得して列挙  'p'（ｐ　tag）から'*'（すべてのtag）に変更した　2022.3.15
	const ptags = dom.querySelectorAll('*');
console.log('ptags=',ptags);
	var nstr='';
	for (const ptag of ptags) {
console.log('node=',ptag.nodeName);
		if(ptag.nodeName=='A') nstr=nstr+ptag.outerHTML+'<br>';
		else if(ptag.nodeName!='FONT') nstr=nstr+ptag.innerText+'<br>';
		}
//	var nstr=nstr.replace(/<("[^"]*"|'[^']*'|[^'">])*>/g,'<br>')

	var newar=nstr.split('<br>');
console.log('str=',nstr,'new array=',newar);
	nstr='';
	for(let i=0;i<newar.length;i++) {
		if(newar[i]!='') nstr=nstr+newar[i]+'<br>';
		}

	var new_ptag= document.createElement("p");
	new_ptag.innerHTML=nstr;
console.log(new_ptag);
	var clsname=''
	if(dom.nodeName=='DIV') clsname=dom.getAttribute('class');
	if(dom.nodeName=='DIV' && clsname=='divsvg') {
console.log('replace first tag=',dom);
		dom.innerHTML='';
		dom.insertBefore(new_ptag, dom.firstChild);
		}
	else {
		$(new_ptag).insertAfter(dom);
		dom.remove();
		}
	}  //function chara end

var Popcheck=0;

function doc_print() {
	window.print();
		} 

//function doc_save start  /*  編集中のレコードの保存　　　　*/
function doc_save() {
	if(save_from!="") {
		alert('from html document not allowed to save');
		return;
		} 
	if(under_con=='no') {
		alert('save is not allowed this version');
		return;
		}
	if(pallet_mend_flag==true) save_sysparms();
	pallet_mend_flag=false;
console.log('my_header bef firm(6)=',my_header);
	my_confirm(6);
console.log('**doc saved at my_confirm(6) my_header=',my_header);
   }  //function doc_save end

function fold_svg(tagn){
	var svg_tags=document.getElementById(tagn);    //document.querySelector('#svg_00');
console.log('**Svg_tag length=',svg_tags.childElementCount);
	svg_tag='';
	for (nn = 0; nn < svg_tags.childElementCount; nn++) {
		var fig_grp=svg_tags.children[nn].getAttribute('fig');
		if( fig_grp=='top'){
			var tagnn=svg_tags.children[nn];
			var len=tagnn.childElementCount;
console.log('Top node=',tagn.nodeName,'len=',len);
			for(var k=len-1; k>0 ;k--) {
				var childtag=tagnn.children[k];
console.log('nodeName=',childtag.nodeName);
				if(childtag.nodeName!='g') {
console.log('deleted nodeName=',childtag.nodeName);
					tagnn.removeChild(childtag);
					}
				}
console.log('saved nodeName=',svg_tags.children[nn].nodeName);
			svg_tag=svg_tag+svg_tags.children[nn].outerHTML+'|<=>|';
			}
console.log('***list n =',nn,' length = ', svg_tag.length);
		}
	return svg_tag;

	}//End fold_svg
/*
function fold_cnsvg(tagn){
	var svg_tags=document.getElementById(tagn);    //document.querySelector('#svg_00');
console.log('**Svg_tag=',svg_tags,'children=',svg_tags.childElementCount);
	return svg_tags.outerHTML;
	}//End fold_cnsvg
*/
/*  新規レコードの作成　　　　*/
    doc_new.onclick = function() {
	if(under_con=='no') {
		alert('新規save is not allowed this version');
		return;
		}
    var div_parent=document.getElementById("wClone");
    var svg_div = document.createElement('div');
    var newtag='svg_00';
    var divtag='div'+newtag;
    svg_div.setAttribute('id', divtag);
    svg_div.setAttribute('class', 'svg');
    svg_div.setAttribute('level', '0');
    svg_div.setAttribute('fig', '基本枠');
    var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
    svg_div.setAttribute('style', marginLR);
    var first_node = document.createElement('p');
    first_node.setAttribute('fig', '段落');
    first_node.innerHTML='これは新規レコードです。     ';
    svg_div.appendChild(first_node);
console.log('*** newRecord　Entered  ***');
    div_parent.appendChild(svg_div);
    var bare_text=div_parent.innerHTML;
console.log('text=',bare_text);

	var svg_tag='';
	var new_overview=newdoc_compose();
console.log(new_overview);
	var tex_to_serv=escapeHtml(escape(bare_text));
	svg_tag=escapeHtml(escape(svg_tag));

        $.ajax({
            url: "/db_serv/newrec/",
            async:true,
            data: {
		"description":tex_to_serv,
		"svg":svg_tag,
		"my_overview":new_overview,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		var rec_num=data['rec_numb'];
console.log('**Ajax Returned result=',data,'rec_numb=',rec_num);
		make_url(rec_num);
//        svg_now='svg_00';
//        set_svg(svg_now);
        });
   }

/*  Copy新規レコードの作成　　　　*/
    copy_new.onclick = function() {
	if(under_con=='no') {
		alert('Copy新規 is not allowed this version');
		return;
		}
console.log('*** Copy newrecord to server ***');
	
	my_confirm(8);

	overview_term[7]='Copy新規:'+overview_term[7];
	my_overview=compose_overview(overview_term[0],overview_term[1],overview_term[2],overview_term[3],overview_term);

        $.ajax({
            url: "/db_serv/copynew/",
            async:true,
            data: {
		"description":tex_to_serv,
		"my_header":my_header,
		"my_overview":my_overview,
		"svg":svg_tag,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		var rec_num=data['rec_numb'];
console.log('**Ajax Returned result=',data,'rec_numb=',rec_num);
		make_url(rec_num);
//        svg_now='svg_00';
//        set_svg(svg_now);
        });
   }

//
//Text Edit モードでのSingleクリック時の処理（Imageの移動など）
function move_image_func(e){
console.log('**Single clicked ');
console.log('Image　Selectモード');
		var xp=e.clientX;
		var yp=e.clientY;
		var area = document.getElementById('texx');
		//var text_area=area.querySelectorAll('div');
		var text_area=area.querySelectorAll('img');

console.log('text_area=',text_area);
		var leng=text_area.length;
console.log('****Catch_image of Tvis area child_leng=',leng);
		var result=false;
    		for (var i=0 ;i<leng ;i++){
			tagn=text_area[i];
			var fig_id=tagn.getAttribute('id');
			var fig=tagn.getAttribute('fig');
console.log('**nodename= ',tagn.nodeName,'fig=',fig,' id= ',fig_id);
			if(fig=='img'){
				result=catch_image(tagn,xp,yp);
				}
			if(result==true) break;
			}
		if(result==true) {
			//Draggerbleの設定
//			Drag_elem = document.getElementById(fig_id);
			Drag_elem = tagn;
			drag.target=Drag_elem;
//			Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
//			document.getElementById('image_dsgn').click();
/*
			//Draggerbleの設定
			Drag_elem = document.getElementById(fig_id);
			Drag_elem.style.position = "absolute";
			drag.target=Drag_elem;
			Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
			Draw_mode='Text';
			drag.break=false;
			draggable(Drag_elem);
*/
			return;
			}
	}　//End of move_image_func

    E_clear.onclick = function() {
	var result = window.confirm('HTML文書全体を本当に削除しますか？');
	if(result==true){
		len=first_container.childNodes.length;
console.log('Enter E_clear child_len=',len,first_container);
		//firstChild=top_svgを残してすべての要素を削除する
		for(var k=len-1;k>0;k--){
			var tagn=first_container.childNodes[k];
console.log('k= ',k,tagn,' Node=',tagn.nodeName,'class=',tagn.className);
			if(tagn.nodeName=='svg'){
				}
			else if(tagn.nodeName=='DIV'){
				var tag_id=tagn.getAttribute('id');
				if(tag_id.slice(0,6)=='divsvg') {
					while( tagn.firstChild ){
  						tagn.removeChild( tagn.firstChild );
						}
    					var first_node = document.createElement('p');
    					first_node.setAttribute('fig', '段落');
    					first_node.innerHTML='これは新規レコードです。     ';
    					tagn.appendChild(first_node);
					}
				else {
					first_container.removeChild(tagn);
					}
				}
			else {
				first_container.removeChild(tagn);
				}
			}

        	svg_now='svg_00';
        	set_svg(svg_now);
		}
	}
//
//⑤SVG　drawing　
//Draw_mode=""の場合のSingleクリック時(Step 2)の処理を入れる
//
function click_func2(e){
console.log('**Single clicked Svg_mode=',Svg_mode);
	if((Svg_mode!="")&&(Svg_mode!="Draw")){
		if(Svg_mode=='Svg_drag' || (Svg_mode=='Svg_updown' && svg_step_flag==0)) {       //SVG図形の選択mode
console.log('SVG　Selectモード');
			var xp=e.clientX;
			var yp=e.clientY;
    			var leng=container.children.length;
console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
				var result=catch_figure(tagn,xp,yp);
				if(result==true) break;
				}
			if(result==true) {
				//Draggerbleの設定
				Drag_elem = document.getElementById(fig_id);
				drag.target=Drag_elem;
				if(Svg_mode=='Svg_updown') {
					svg_step_flag=1;
					return;
					}
				Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
				Draw_mode='Drag';
				drag.break=false;
				draggable(Drag_elem);
				/*
				var tag_elem=[];
				tag_elem.push(Drag_elem);
				DraggableItem.create('', tag_elem,'group');
				*/
				return;
				}
			}  //End SVG Selectモード
		if(Svg_mode=='Svg_reshape') {       //SVG図形の選択mode
console.log('SVG　Reshapeモード');
			var xp=e.clientX;
			var yp=e.clientY;
			var leng=container.children.length;
console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
				result=catch_reshape(tagn,xp,yp);
				if(result==1) {
						break;
						}
					else {
						if(result>10) return;
						}
				}
			if(result==1) {
				//矩形の描画とDraggerbleの設定
				//createRectFig(x,y,w,h)
				Drag_elem = document.getElementById(fig_id);
console.log('**reshape fig= ',Drag_elem,'id= ',fig_id);
				drag.s_para=Drag_elem.getAttribute('smooth');
				drag.c_para=Drag_elem.getAttribute('close');
				Svg_mode='Svg_reshape_pending';
				//var reshape = document.getElementById(fig_id)
				Drag_elem.addEventListener('click',elem_callback,false);
				return;
				}
			}  //End SVG Reshapeモード
		if(Svg_mode=='Svg_scale' || Svg_mode=='Svg_rotate') {       //SVG図形の選択mode
console.log('SVG　Scaleモード');
			var xp=e.clientX;
			var yp=e.clientY;
			var leng=container.children.length;
console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
				result=catch_scale(tagn,xp,yp);
console.log('result=',result);
				if(result!=false) break;
				}
			if(result!=false) {
console.log('**scale rotate mode');
				catch_scale_fig(result);
				//矩形の描画とDraggerbleの設定
				//createRectFig(x,y,w,h)
				Drag_elem = document.getElementById(fig_id);
				Svg_mode='Svg_scale_pending';
				//var reshape = document.getElementById(fig_id)
				Drag_elem.addEventListener('click',scale_callback,false);
				return;
				}
			}  //End SVG scaleモード
		}  //End Svg_mode!=Draw モード
	}
//
//⑤SVG　drawing　
//Draw_mode="Draw"（描画）の場合のSingleクリック時(Step 2)の処理を入れる
//
function click_func3(e) {
     if((Svg_mode=="Draw")){
console.log('Singleクリック',control.value,'Step=',Step);
	Oper=3;
	if (Step==0) {
		//free lineなどの残骸を消して開始する
		isDrawing=0;
		if (drawingPath) {
			drawingPath=null;
			}
        	drawingPoints = [];
		first_point=null;
console.log("****Initialized");
		}
	Step+=1;
	var x0=e.clientX;
	var y0=e.clientY;
	if(mesh_draw && mesh_integer) {
		x0=Math.round(x0/10)*10;
		y0=Math.round(y0/10)*10;
		}
	else {
		x0=Math.round(x0*10)/10;
		y0=Math.round(y0*10)/10;
		}
        drawingPoints.push({x: x0,y: y0});
	if((key_shift)&&(drawingPoints.length>1)) {
console.log('x0,y0=',x0,y0);
		mend_points();
		}
	if ((control.value== 'simp_line')||(control.value== 'seri_line')||(control.value== 'close_line')||(control.value== 'smooth')||(control.value== 'close_smooth')){
		line_seq();
		}
	if (control.value== 'quad_bezier'){
		quad_bezier_seq(Step);
		}
	if (control.value== 'cubic_bezier'){
		cubic_bezier_seq(Step);
		}
	if(temp_snap_flag==1) temp_snap_fix();
	if(Step==0) temp_snap_flag=0;
console.log('temp_snap Step=',Step);

	}
    }

function elem_callback(e) {
	//e.stopPropagation();
	Draw_mode='Drag';
	drag.break=false;
	if(drag.target) {
console.log('prev tag=',drag.target.id,' tag_no=',drag.id_num);
		drag.target.setAttribute('class', 'movable');
		}
	var tag = e.target;
console.log('mouseover:' + tag.id);
	drag.id_num=Number(tag.id.slice( -2 ))-1;
console.log('new tag=' + tag.id,' tag_no=',drag.id_num);
	drag.target = document.getElementById(tag.id);
	drag.target.setAttribute('class', 'draggable');
	draggable(drag.target);
	}

function scale_callback(e) {
	//e.stopPropagation();
	Draw_mode='Drag';
	drag.break=false;
	if(drag.target) {
console.log('prev tag=',drag.target.id,' tag_no=',drag.id_num);
		drag.target.setAttribute('class', 'movable');
		}
	var tag = e.target;
//console.log('mouseover:' + tag.id);
	drag.id_num=Number(tag.id.slice( -2 ));
console.log('new tag=' + tag.id,' tag_no=',drag.id_num);
	drag.target = document.getElementById(tag.id);
    	switch (drag.id_num){
      		case 1:
			drag.fixpnt='pn03';
			drag.target.setAttribute('class', 'wecross');
			break;			
      		case 3:
			drag.fixpnt='pn01';
			drag.target.setAttribute('class', 'wecross');
			break;
      		case 2:
			drag.fixpnt='pn04';
			drag.target.setAttribute('class', 'ewcross');
			break;
      		case 4:
			drag.fixpnt='pn02';
			drag.target.setAttribute('class', 'ewcross');
			break;
      		case 5:
			drag.fixpnt='pn07';
			drag.target.setAttribute('class', 'height');
			break;
      		case 7:
			drag.fixpnt='pn05';
			drag.target.setAttribute('class', 'height');
			break;
      		case 6:
			drag.fixpnt='pn08';
			drag.target.setAttribute('class', 'wide');
			break;
      		case 8:
			drag.fixpnt='pn06';
			drag.target.setAttribute('class', 'wide');
			break;
      		case 10:
			drag.fixpnt='pn10';
			drag.target.setAttribute('class', 'wide');
			break;
      		case 11:
			drag.fixpnt='pn11';
			drag.target.setAttribute('class', 'height');
			break;
　　　		default:
			return;
			break;
		}	
	draggable(drag.target);
	}

function draw_basic(e){
console.log('**draw_basic clicked');
/* 注意：拡大縮小の変換は左上の座標値が倍率の値に変換されるので基本図は（0,0)のものが必要　*/
	var sx,sy,scx,scy;
	var rect_a=draw_op.target.getBoundingClientRect();
console.log('**rect_a=',rect_a);
/*
	scx=1;
	scy=1;
	scx=draw_op.scx;
	scy=draw_op.scy;
	var parm=`${scx},${scy}`;
console.log('Posxy=',draw_op.posx,draw_op.posy);
	first_point=createFirstPoint([{x:draw_op.posx,y:draw_op.posy}]);
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point);
*/
	scx=draw_op.scx;
	scy=draw_op.scy;
console.log('scalexy=',scx,scy);

	if(draw_op.aux_line) draw_op.posx=draw_op.aux_pos;
    switch (draw_op.align){
      case 'left':
		sx= draw_op.posx;
		sy= draw_op.posy;
		break;
      case 'center':
		sx= draw_op.posx-Math.ceil((rect_a['right']-rect_a['left'])*scx/2);
		sy= draw_op.posy;
		break;
      case 'right':
		sx= draw_op.posx-Math.ceil((rect_a['right']-rect_a['left'])*scx);
		sy= draw_op.posy;
		break;
　　　default:
		sx=e.clientX;
		sy=e.clientY;
		break;
	}
console.log('align=',draw_op.align,'  scale=',scx,scy,' translate=',sx,sy);

	var parm=`${scx},${scy}`;
        var tr_parm=`${sx},${sy}`;
	var dumy=(draw_op.target).cloneNode(true);
	if(draw_op.fig=='text')	{
		dumy.setAttribute("transform", "translate("+tr_parm+")");
		dumy.setAttribute('fill',defaultCharStyle.fill);
		}
	else {
		dumy.setAttribute("transform", "translate("+tr_parm+")"+"scale("+parm+")");
		//dumy.setAttribute('stroke',defaultPathStyle.stroke);
		}
console.log('**basic fig=',draw_op.fig);

	if(draw_op.fig=='basic'){
		var fig_id='b'+(Date.now()).toString();
		dumy.setAttribute('id', fig_id);
		dumy.setAttribute('fig', 'basic');

        			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				var fig_id2='g'+(Date.now()).toString();
				wgroup.setAttribute('id', fig_id2);
				wgroup.setAttribute('fig', 'group');
				var g_temp=container.appendChild(wgroup);
			simple_fig(g_temp,dumy);              //transform matrixを適用して図形simple化
			var close=dumy.getAttribute('close');
			if(close) g_temp.setAttribute('close', close);
			var smooth=dumy.getAttribute('smooth');
			if(smooth) g_temp.setAttribute('smooth', smooth);
		}
	else {
		if(draw_op.fig=='text'){
			var fig_id='t'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'text');
			container.appendChild(dumy);
			}
	     	else {
			var fig_id='g'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'group');
			container.appendChild(dumy);
			}
		}
//	container.removeChild(basic_rect.rect);
//	basic_rect.rect=null;
	}  //end of draw_basic

function getAbsPosition(x,y){
  const {left: bleft, top: btop} = document.body.getBoundingClientRect();
  return {
    x: x - bleft,y: y - btop
  };
}

function line_seq(){
	if (first_point){
		container.removeChild(first_point);
		first_point=null;
		}
	first_point=createFirstPoint([drawingPoints[drawingPoints.length-1]])
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point)
console.log('Firstpont=',container,'point=',[drawingPoints[drawingPoints.length-1]]);

       if (drawingPath) {
       		container.removeChild(drawingPath);
                drawingPath=null;
            	}
	if(drawingPoints.length>1){
        	drawingPath = createPath(drawingPoints,0,null,null);
        	Object.assign(drawingPath.style, defaultPathStyle);
        	container.appendChild(drawingPath);
		if(control.value=='simp_line'){
			if (first_point){
				container.removeChild(first_point);
				first_point=null;
				}
			var {group,fig_id}=make_group('line');
			drawingPoints = [];
			Step=0;
			if(tempArrowStyle || defaultArrowStyle) {
				if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
console.log('arrowstyle=',tempArrowStyle);
				remake_group(group,drawingPath,tempArrowStyle);
				tempArrowStyle='';
				}
			group.appendChild(drawingPath);
console.log('make_group=',group,fig_id,'Step=',Step);
			}
		}
//console.log('Path=',drawingPath);
	}  //end of line_seq

function remake_group(group,path,arrow) {
console.log('Enter remake_group arrow_style=',arrow,'path_style=',defaultPathStyle);
	var v_color=defaultPathStyle.stroke;
console.log('path=',path,'color=',v_color);
    switch (arrow){
      case 'start':
		var s_arw=document.getElementById('start_arw').cloneNode(true);
		var fig_id='m'+(Date.now()).toString();
		s_arw.setAttribute('id', fig_id);
		s_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+fig_id+')';
        	path.setAttribute('marker-start', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		group.insertBefore(s_arw, group.firstChild);
        	group.setAttribute('color', v_color);
		break;
      case 'end':
		var e_arw=document.getElementById('end_arw').cloneNode(true);
		var fig_id='m'+(Date.now()).toString();
		e_arw.setAttribute('id', fig_id);
		e_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+fig_id+')';
        	path.setAttribute('marker-end', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		group.insertBefore(e_arw, group.firstChild);
        	group.setAttribute('color', v_color);		              
		break;
      case 'both':
		var s_arw=document.getElementById('start_arw').cloneNode(true);;
		var fig_id='m'+(Date.now()).toString();
		s_arw.setAttribute('id', fig_id);
		s_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+fig_id+')';
        	path.setAttribute('marker-start', url_id);
		group.insertBefore(s_arw, group.firstChild);
		var e_arw=document.getElementById('end_arw').cloneNode(true);;
		var fig_id='m'+(Date.now()).toString();
		e_arw.setAttribute('id', fig_id);
		e_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+fig_id+')';
        	path.setAttribute('marker-end', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		group.insertBefore(e_arw, group.firstChild);
        	group.setAttribute('color', v_color);	
//        	path.setAttribute('marker-start', "url(#start_arw)");
//        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
       default:
		path.setAttribute('marker-end', '');
		path.setAttribute('marker-start', '');
		Object.assign(path.style, defaultPathStyle);
		break;
		}
	defaultPathStyle.stroke=v_color;
console.log('old_style=',defaultPathStyle);
	}

function quad_bezier_seq(Step){
console.log('Step=',Step);
	mStep=Step%3;
	if(mStep==1){	
		first_point=createFirstPoint([drawingPoints[drawingPoints.length-1]]);
	        Object.assign(first_point.style, defaultPointStyle);
        	container.appendChild(first_point)
		}
console.log('Bezier',Step,'length=',drawingPoints.length);
	if (mStep==2) {
//console.log(' last line= ',drawingPoints,[drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]]);
		bezier_line=createPath([drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]],0,null,null)
	        Object.assign(bezier_line.style, tempoPathStyle);
        	container.appendChild(bezier_line);

		if (first_point){
			container.removeChild(first_point);
			first_point=null;
			}
		}
	if(mStep==0) {
		if (drawingPath) {
       			container.removeChild(drawingPath);
                	drawingPath=null;
            		}
                drawingPath = createQuadBezier(drawingPoints);
            	Object.assign(drawingPath.style, defaultPathStyle);
            	container.appendChild(drawingPath);

		if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
console.log('cubic bezier dummy removed length=',drawingPoints.length);
			}
		}
console.log('append bezier');
	}  //End of quad_bezier_seq

function cubic_bezier_seq(Step){
console.log('Step=',Step);
	mStep=Step%4;
	if(mStep==1){	
		first_point=createFirstPoint([drawingPoints[drawingPoints.length-1]]);
	        Object.assign(first_point.style, defaultPointStyle);
        	container.appendChild(first_point)
		}
//console.log('Cubic Bezier',Step,'length=',drawingPoints.length);
	if(mStep==2){
console.log('Cubic Bezier line');
		bezier_line=createPath([drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]],0,null,null)
	        Object.assign(bezier_line.style, tempoPathStyle);
       		container.appendChild(bezier_line)

		if (first_point){
			container.removeChild(first_point);
			first_point=null;
			}
		}
	if(mStep==3){
console.log('Cubic Bezier line');
		bezier_line1=createPath([drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]],0,null,null)
	        Object.assign(bezier_line1.style, tempoPathStyle);
       		container.appendChild(bezier_line1)
		}
	if(mStep==0) {
		if (drawingPath) {
       			container.removeChild(drawingPath);
                	drawingPath=null;
            		}
                drawingPath = createCubicBezier(drawingPoints,0);
            	Object.assign(drawingPath.style, defaultPathStyle);
            	container.appendChild(drawingPath);

		if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
			}
		if (bezier_line1){
			container.removeChild(bezier_line1);
			bezier_line1=null;
			}
		}
console.log('Cubic Bezier line',drawingPoints);
	}//End of cubic_bezier_seq


//
//⑦Utility
//

//
//⑥SVG　edit
//
    clear.onclick = function() {
	var area=svg_now;
	var result = window.confirm(svg_now+'元に戻せません。本当に削除しますか？');
	if(result==true){
		if(svg_now=='svg_00') {
        		while (container.lastElementChild) {
console.log('**lastChild nodename= ',container.lastElementChild.nodeName);
				if(container.lastElementChild.nodeName!='defs'){
            				container.removeChild(container.lastElementChild);
					}
				}
			}
		else {
//chain_SVG図形関連の削除　svgの次の要素（<div>）と<svg>とを削除する	
console.log('svg=',org_container,'div_elem=',org_container.nextElementSibling);
			org_container.nextElementSibling.remove();
			org_container.remove();
//メニュー部svg_tag_menuのoptionの削除
			var menu_elem = $('select[name=svg_tag_menu]');
//console.log('select=',menu_elem);
			var param='option[value='+svg_now+']';
			menu_elem.children(param).remove();
//タグを削除する場合はchain_svgのデータ側(レコード構造とchain_svgデータ）の削除も必要
console.log('cnsvg tags=',cnsvg_tags);
			cnsvg_tags = cnsvg_tags.filter((cnsvg_tags) => {
				return (cnsvg_tags.name != svg_now);
				});
			cnsvg_nums=cnsvg_nums-1;
console.log('result=',cnsvg_tags);
			}
        	svg_now='svg_00';
        	set_svg(svg_now);
    		}
	}

    function clear_allchild(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }
////
/*  resolv_svg ボタンは削除した。当面不要
  resolv_svg.onclick = function() {
    //htmlのSVG
　　const svgtag = document.getElementById(svg_now);    //  document.querySelector('#svg_00');
	var level=0;
	svg_list(svgtag,level);	
    }
*/
////
  function svg_list(svgtag,level){
    var leng=svgtag.children.length;
console.log('svg_list level= ',level,'child leng= ',svgtag.children.length,svgtag);
    for (var i=0 ;i<leng ;i++){
	tagn=svgtag.children[i];
console.log('**nodename= ',tagn.nodeName);
	if(tagn.children.length) {
		level=level+1;
		svg_list(tagn,level);
		}
	else {
                var path_p=resolv_figure(tagn);
		var error=path_to_circle(tagn,path_p);

		}
	}  //end for
     }    //end function svg_list

   function resolv_figure(tagn){
console.log('Svg text=',tagn.nodeName,tagn.outerHTML);
		attr_char=tagn.getAttribute("d"); 
		var path_p=[];
console.log('**attr= ',attr_char);
		if(attr_char){
			replaced = attr_char.replace(/-/g, ',-');
//console.log(replaced);
//			var result = replaced.split(/,|M|T|Q|q|S|s|C|c|L|l|Z/);     // '-'を分割文字にするとマイナス符号と見做さないのでまずい
			var replace2 = replaced.replace(/,|M|T|Q|q|S|s|C|c|L|l|Z/g,' ');
			var result = replace2.split(' ');
console.log('leng=',result.length,result);
//(x,y)のペアを作りさらに形式を変えて（作図用）保存
			r_val=[];
			for ( var i = 0 ; i < result.length ; i++ ){
				if (result[i]!="") {
					val=Number(result[i]);
					r_val.push(val);
					}
				}
console.log('r_val=',r_val);
			path_p=[];
			result=splitArray(r_val,2);
console.log('Result=',result,'r_val=',r_val);
			for(var k=0; k<result.length;k++){
				path_p.push({x: result[k][0],y: result[k][1]});
				}
console.log('path_p= ',path_p);
			}    //end if(attr_char)
		return path_p;
	}  // end function

function path_to_circle(tagn,path_p) {
console.log('tag=',tagn,'parent=',tagn.parentNode);

//円を描いてみる
	var close=tagn.parentNode.getAttribute("close"); 
	var res=tagn.parentNode.getAttribute("smooth");
console.log('close and smooth=',close,res,tagn.parentNode,Drag_elem);
if(close==null || res==null) {
alert("this figure can't reshape(not close/smooth)");
		document.getElementById("fig_sel_end").click();
//		return 1000;
		}
	var result = res.split(' ');
	var smooth =result[0];
console.log('close=',close,' smooth=',smooth,result);
	if(smooth=='trim'){
		drawingPoints=[];
		drawingPoints.push(path_p[0]);
		for(var k=0; k<path_p.length;k+=5){
			if((k+3)<path_p.length) {
				drawingPoints.push(path_p[k+3]);
				}
			}
		if(close=='close'){
			drawingPoints[0]=drawingPoints[drawingPoints.length-1];
			}
		else {
			drawingPoints.push(path_p[path_p.length-1]);
			}
console.log('trim path=',drawingPoints);
		}
	else {
		var int_v=1;
		if(smooth=='smooth') {
			int_v=3;
			}
		drawingPoints=[];
		for(var k=0; k<path_p.length;k+=int_v){
			drawingPoints.push(path_p[k]);
console.log(path_p[k]);
			}

		}

	var id=0;
	for(var k=0; k<drawingPoints.length;k+=1){
		id=id+1;
		first_point=createFirstPoint([drawingPoints[k]]);
		Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (id)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttributeNS(null,'class', 'movable');
		first_point.setAttribute('fig', 'temp');
		tagn.parentNode.appendChild(first_point);
		}
	if(close=='close') {
		len=tagn.parentNode.children.length;
		let tag=tagn.parentNode.children[len-1];
		tagn.parentNode.removeChild(tag);
		}
console.log('points=',drawingPoints);
	return 1;
	}  // end function

//新規Chain_SVGレコードの作成
function save_cnsvg(cn_header,svg_tag) {
console.log('*** Chain_Svg Save Entered  ***');
console.log('header=',cn_header,'svg=',svg_tag);

	var svg_tag=escapeHtml(escape(svg_tag));
console.log('svg_tag',svg_tag);
        $.ajax({
            url: "/db_serv/save_cnsvg/",
            async:false,
            data: {
		"cn_header":cn_header,
		"svg":svg_tag,
		},
            dataType: 'json'
        })
        .done((data) => {
		wfcn_header=data['header'];
		var cnsvg_header=data['header'].split(',');
		cnsvg_new_pk=cnsvg_header[0];
            //結果が帰ってきたら、表示します。
console.log('**Ajax Returned result =',cnsvg_header,data);
        });
   }

//My_DataレコードのChain_SVG関連フィールドの変更
/*
function update_head(my_data_pk,cn_nums,cn_header) {
console.log('*** Update Chain_Svg part Entered  ***');
console.log('data_pk=',my_data_pk,'cnsvg_nums=',cn_nums,'cn_header=',cn_header);

        $.ajax({
            url: "/db_serv/update_head/",
            async:false,
            data: {
		"my_data_pk":my_data_pk,
		"cnsvg_nums":cnsvg_nums,
		"cnsvg_header":cn_header,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		my_cnsheader=data['header'];
console.log('**Ajax Returned result=',data,my_cnsheader);
        });
   }
*/

//My_CnSvgレコードのget
function get_cnsvg(cnsvg_pk) {
console.log('*** Get Chain_Svg part Entered  ***');
console.log('cnsvg_pk=',cnsvg_pk);

        $.ajax({
            url: "/db_serv/get_cnsvg/",
            async:false,
            data: {
		"rec_number":cnsvg_pk,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		wfcn_header=data['header'];
		cnsvg_field=data['svg_field'];
console.log('**Ajax Returned result=',data);
        });
   }

//外部SVGfileの読み込み
　　var svg_read = document.getElementById("svgfile");
　　//ダイアログでファイルが選択された時
　　svg_read.addEventListener('change',function(evt){

        var file = evt.target.files;
　　	//FileReaderの作成
  　	var reader = new FileReader();
  　	//テキスト形式で読み込む
  　	reader.readAsText(file[0]);
//console.log('file=',file[0]);

  　	//読込終了後の処理
  　	reader.onload = function(ev){
　　		svgText = reader.result;
//console.log('load text=',svgText)
　　		const domParser = new DOMParser();
　　		var testSVGDoc = domParser.parseFromString(svgText, 'image/svg+xml');
　　		var testparsedSVG = testSVGDoc.childNodes[0];
console.log('length=',testparsedSVG.children.length,testparsedSVG,' Node=',testparsedSVG.nodeName);

		if(testparsedSVG.nodeName!='svg') {
			svgText = '<svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 256px; height: 256px; opacity: 1;" xml:space="preserve">'
			+svgText+'</svg>';
			}

　　		const parsedSVGDoc = domParser.parseFromString(svgText, 'image/svg+xml');
　　		var parsedSVG = parsedSVGDoc.childNodes[0];   //解釈svgはすべてchildNodes[0]にある
		var gname=parsedSVG.getAttribute('class');
		if(gname='') {
    			var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    			var fig_id='g'+(Date.now()).toString();
    			group.setAttribute('id', fig_id);
    			group.setAttribute('class', 'outgroup');
    			container.appendChild(group);
    			for (nn = 0; nn < parsedSVG.children.length; nn++) {
console.log('**nodename= ',parsedSVG.children[nn].nodeName,parsedSVG.children[nn]);
　　				group.appendChild(parsedSVG.children[nn].cloneNode(true));
				}
			}
		else {
console.log('length=',parsedSVG.children.length,parsedSVG,' Node=',parsedSVG.nodeName);
			for (var nn = 0; nn < parsedSVG.children.length; nn++) {
console.log('**nodename nn=',nn,parsedSVG.children[nn].nodeName,parsedSVG.children[nn]);
　　				container.appendChild(parsedSVG.children[nn].cloneNode(true));
				}
			}
  　　  	}
　　	}  ,false);　//外部SVGfileの読み込み終了

//外部htmlfileの読み込み
　　var html_read = document.getElementById("htmlfile");
　　//ダイアログでファイルが選択された時
　　html_read.addEventListener('change',function(evt){

        var file = evt.target.files;
　　	//FileReaderの作成
  　	var reader = new FileReader();
  　	//テキスト形式で読み込む
  　	reader.readAsText(file[0]);
console.log('file=',file[0],file[0].name);

  　	//読込終了後の処理
  　	reader.onload = function(ev){
　　		htmlText = reader.result;
//console.log('load text=',htmlText)
　　		const domParser = new DOMParser();
　　		var testDoc = domParser.parseFromString(htmlText, 'text/html');
//console.log('html=',testDoc);
		var tags=testDoc.querySelector('#texx')
//console.log('html=',tags);
		var set_tag=document.getElementById('tab1');
		var del_tag=document.getElementById('texx');
		set_tag.removeChild(del_tag);
		set_tag.appendChild(tags);

		svg_tag_del();
		first_container = document.getElementById('texx');
		var svg_tags=first_container.querySelectorAll('svg');
console.log(svg_tags);
		var rect=createRectFig(0,0,20,20);
		rect.setAttribute('class', 'chain_svg_mark');
		rect.setAttribute('stroke', 'blue');
		rect.setAttribute('stroke-width', '1');
		rect.setAttribute('fill', 'blue');
		svg_tags[0].prepend(rect);
		for(var k=1; k<svg_tags.length;k+=1){
//console.log(svg_tags[k]);
			var name=svg_tags[k].id;
			svg_tag_add(name);
//console.log('chain svg=',name);
			var rect=createRectFig(0,0,20,20);
			rect.setAttribute('class', 'chain_svg_mark');
			rect.setAttribute('stroke', 'blue');
			rect.setAttribute('stroke-width', '1');
			rect.setAttribute('fill', 'blue');
			svg_tags[k].prepend(rect);
			}
		fgedit.selectedIndex=2;
		chng_mode();
		org_container = document.getElementById('svg_00');
		svg_now='svg_00';
		set_svg(svg_now);
		save_from="html";
		}
	});

////
   function catch_image(tagn,xp,yp){
	var result=false;
console.log('xy=',xp,yp);
	var rect_a=tagn.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	let w=rect_a.right-rect_a.left;
	let h=rect_a.bottom-rect_a.top;			

//	var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

	if(((rect_a.left-xp)*(rect_a.left+w-xp)<0) && ((rect_a.top-yp)*(rect_a.top+h-yp)<0)) {
console.log('Catch Image');

		result=true;
		}
	return result;
	}

////
   function catch_figure(tagn,xp,yp){
console.log('Catch_fig=',tagn.outerHTML);
/*
	if((tagn.nodeName=='g') && (tagn.children.length==1)) {
console.log('tagn=',tagn.nodeName,'child_len=',tagn.children.length,'child_node=',tagn.children[0].nodeName);
		if(tagn.children[0].nodeName=='path') {
*/
//	if(tagn.nodeName=='g') {
				var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('tag=',tagn,'xy=',xp,yp,' point=',pnt);

			
//				var rect_a=tagn.children[0].getBoundingClientRect();
				var rect_a=tagn.getBoundingClientRect();
//				var rect_a=tagn.getClientRects();  //getBoundingClientRectと同じ値を返す
//				var rect_a=tagn.getBBox();   getBBoxはオリジナル図形の（x,y,w,h)を返す
console.log('**rect_a=',rect_a);

				let w=rect_a.right-rect_a.left;
				let h=rect_a.bottom-rect_a.top;			

				var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

				if(((pnt2.x-pnt.x)*(pnt2.x+w-pnt.x)<0) && ((pnt2.y-pnt.y)*(pnt2.y+h-pnt.y)<0)) {
console.log('Got Catch Figure');
					if(Svg_mode!='Selected' && Svg_mode!='Svg_updown') Svg_mode="Svg_drag_pending";
/*
					first_point=createFirstPoint([pnt]);
	        			Object.assign(first_point.style, defaultPointStyle);
					tagn.appendChild(first_point);
*/
					rect01=createRectFig(pnt2.x,pnt2.y,w,h);
					rect01.setAttribute('id', 'rect01');
					rect01.setAttribute('fig', 'temp');
					tagn.appendChild(rect01);

					drag.center_x=pnt2.x+w/2;
					drag.center_y=pnt2.y+h/2;
					drag.hf_width=w/2;
					drag.hf_height=h/2;

					return true;
					}
//			}
	}
/*
////
   function catch_reshape(tagn,xp,yp){
console.log('Catch_fig=',tagn.outerHTML);
	var error=0;
	if((tagn.nodeName=='g') && (tagn.children.length==1)) {
console.log('tagn=',tagn.nodeName,'child_len=',tagn.children.length,'child_node=',tagn.children[0].nodeName);
		if(tagn.children[0].nodeName=='path') 	{
				var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('xy=',xp,yp,' point=',pnt);
				var rect_a=tagn.getBoundingClientRect();
console.log('**rect_a=',rect_a);
				let bboxRect = tagn.getBBox();
console.log('**bbox=',bboxRect);

				let w=bboxRect.width;
				let h=bboxRect.height;				

				var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

				if(((pnt2.x-pnt.x)*(pnt2.x+w-pnt.x)<0) && ((pnt2.y-pnt.y)*(pnt2.y+h-pnt.y)<0)) {
console.log('Catch reshape Figure');
					error=1;
					var path_p=resolv_figure(tagn.children[0]);
					error=path_to_circle(tagn.children[0],path_p);
					if(error>10) {
console.log('path_to_circle error occured');
						}
					}
			}
		}
console.log('catch reshape result=',error);
	return error;
	}
*/

   function reshape_figure(tagn){
console.log('Reshape_fig=',tagn);
	var error=0;
	if((tagn.nodeName=='g') && (tagn.children.length==1)) {
console.log('tagn=',tagn.nodeName,'child_len=',tagn.children.length,'child_node=',tagn.children[0].nodeName);
		if(tagn.children[0].nodeName=='path') 	{
			error=1;
			var path_p=resolv_figure(tagn.children[0]);
			error=path_to_circle(tagn.children[0],path_p);
			if(error>10) {
console.log('path_to_circle error occured');
				}
			}
		}
console.log('reshape result=',error);
	return error;
	}

/*
////
   function catch_scale(tagn,xp,yp){
console.log('Catch_fig=',tagn.outerHTML);
	result=false;
	if((tagn.nodeName=='g') && (tagn.children.length==1)) {
console.log('tagn=',tagn.nodeName,'child_len=',tagn.children.length,'child_node=',tagn.children[0].nodeName);
		if(tagn.children[0].nodeName=='path') {
				var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('xy=',xp,yp,' point=',pnt);
//				var rect_a=tagn.children[0].getBoundingClientRect();
				var rect_a=tagn.getBoundingClientRect();
//				let w=rect_a.right-rect_a.left;
//				let h=rect_a.bottom-rect_a.top;
console.log('**rect_a=',rect_a);

				let bboxRect = tagn.getBBox();
console.log('**bbox=',bboxRect);
				let w=bboxRect.width;
				let h=bboxRect.height;				

				var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);
				if(((pnt2.x-pnt.x)*(pnt2.x+w-pnt.x)<0) && ((pnt2.y-pnt.y)*(pnt2.y+h-pnt.y)<0)) {
console.log('Catch scale Figure');
//選択SVGのtransformをcheckし、既にtrandformがあればtransform　matrixを適用してsimple図形に変換する
					console.log('baseVal number=',tagn.transform.baseVal.numberOfItems)
					if(tagn.transform.baseVal.numberOfItems>0) {
						console.log('To simple SVG');
						var dumy=tagn.cloneNode(true);
						simple_fig(dumy);                // simple_figの使い方間違い要検討
						dumy.setAttribute("transform", "translate(0,0)");
						container.appendChild(dumy);
						container.removeChild(tagn);
						result=dumy;
						}
					else {
						result=tagn;
						}

					return result;
					}
			}
		}
		return result;
	} //End of catch_scale
*/

   function catch_scale_fig(tagn) {

	temp_delete(tagn);
	simple_fig(dumy_group,tagn);              //transform matrixを適用して図形simple化
//    org_container.appendChild(dumy_group);
	copy_svgtag(tagn,dumy_group);
console.log('After simple=',tagn,dumy_group);

	var rect_a=tagn.getBoundingClientRect();
console.log('**rect_a=',rect_a,tagn);
	let w=rect_a.width;
	let h=rect_a.height;		

	var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

	rect01=createRectFig(pnt2.x,pnt2.y,w,h);
	rect01.setAttribute('id', 'rect01');
	rect01.setAttribute('fig', 'temp');
	tagn.appendChild(rect01);

	if(fig_scale_witch=="scale"){
console.log('witch scale=',fig_scale_witch);
		k=1
		first_point=createFirstPoint([{x:pnt2.x,y:pnt2.y}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=2
		first_point=createFirstPoint([{x:pnt2.x+w,y:pnt2.y}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=3
		first_point=createFirstPoint([{x:pnt2.x+w,y:pnt2.y+h}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=4
		first_point=createFirstPoint([{x:pnt2.x,y:pnt2.y+h}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=5
		first_point=createFirstPoint([{x:pnt2.x+w/2,y:pnt2.y}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=6
		first_point=createFirstPoint([{x:pnt2.x+w,y:pnt2.y+h/2}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=7
		first_point=createFirstPoint([{x:pnt2.x+w/2,y:pnt2.y+h}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=8
		first_point=createFirstPoint([{x:pnt2.x,y:pnt2.y+h/2}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		}

	if(fig_scale_witch=="rotate"){
console.log('witch rotate=',fig_scale_witch);
		var drawPoint=[];
		drawPoint.push({x:pnt2.x+w/2,y:pnt2.y+h/2});
		drawPoint.push({x:pnt2.x+w/2,y:pnt2.y-h/4});
		bezier_line=createPath(drawPoint,0);
		Object.assign(bezier_line.style, tempoPathStyle);
		bezier_line.setAttribute('fig', 'temp');
		tagn.appendChild(bezier_line);
					
		k=10
		first_point=createFirstPoint([{x:pnt2.x+w/2,y:pnt2.y-h/4}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);

		var drawPoint=[];
		drawPoint.push({x:pnt2.x+w/2,y:pnt2.y+h/2});
		drawPoint.push({x:pnt2.x+w+w/4,y:pnt2.y+h/2});
		bezier_line=createPath(drawPoint,0);
		Object.assign(bezier_line.style, tempoPathStyle);
		bezier_line.setAttribute('fig', 'temp');
		tagn.appendChild(bezier_line);

		k=11
		first_point=createFirstPoint([{x:pnt2.x+w+w/4,y:pnt2.y+h/2}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		}

		drag.center_x=pnt2.x+w/2;
		drag.center_y=pnt2.y+h/2;
		drag.hf_width=w/2;
		drag.hf_height=h/2;
	} //End of function
////
   function catch_updown_fig(tagn) {

	temp_delete(tagn);
	var px1=drag.center_x-drag.hf_width-20;
	var px2=drag.center_x+drag.hf_width+20;
console.log('first_line point=',drag.center_x,drag.center_y,drag.hf_width,drag.hf_height,px1,px2);
	var drawPoint=[];
	drawPoint.push({x:px1,y:drag.center_y});
	drawPoint.push({x:px2,y:drag.center_y});;
	bezier_line=createPath(drawPoint,0);
	Object.assign(bezier_line.style, tempoPathStyle);
	bezier_line.setAttribute('fig', 'temp');
	tagn.appendChild(bezier_line);

	var pnty1=drag.center_y-drag.hf_height-20;
	var pnty2=drag.center_y+drag.hf_height+20;
console.log('second_line');
	var drawPoint=[];
	drawPoint.push({x:drag.center_x,y:pnty1});
	drawPoint.push({x:drag.center_x,y:pnty2});;
	bezier_line=createPath(drawPoint,0);
	Object.assign(bezier_line.style, tempoPathStyle);
	bezier_line.setAttribute('fig', 'temp');
	tagn.appendChild(bezier_line);
					
	} //End of function
////

   function catch_adddel_point(tagn,xp,yp){
console.log('Add or Delete Point path=',tagn.outerHTML);

	var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('xy=',xp,yp,' point=',pnt);

	var near;
	len=drawingPoints.length;

	result=false;
	for(var k=0; k<len-1;k+=1){
		near=Math.pow(drawingPoints[k].x-pnt.x,2)+Math.pow(drawingPoints[k].y-pnt.y,2);
		near=Math.sqrt(near);
console.log('point near=',near);
		if(near<5) {
			var tag_id='pn'+("00" + (k+1)).slice( -2 );
			var del_target = document.getElementById(tag_id);
			del_target.setAttribute('style', style="stroke-width: 1px; stroke: red; fill: pink;");
			var result = window.confirm('Pointを削除しますか？');
			if((result==true)&&(len>=4)){
				drawingPoints.splice(k, 1);
				tagn.removeChild(del_target);
				var c_para=tagn.getAttribute("close"); 
				if(c_para=='close'){
					nlen=drawingPoints.length;
					drawingPoints[nlen-1]=drawingPoints[0];
					}
				var s_para=tagn.getAttribute("smooth"); 
console.log('s_para,c_para=',s_para,c_para);
				var new_path = set_line_group(tagn,c_para,s_para);
				tagn.removeChild(tagn.firstChild);
				tagn.insertBefore(new_path, tagn.firstChild);
				}
			break;
			}
		}
	if(result==false) {
		for(var k=0; k<len-1;k+=1){
			var bunbo=Math.sqrt(Math.pow(drawingPoints[k].x-drawingPoints[k+1].x,2)+Math.pow(drawingPoints[k].y-drawingPoints[k+1].y,2));
			var bunsh=Math.abs((drawingPoints[k+1].y-drawingPoints[k].y)*pnt.x-(drawingPoints[k+1].x-drawingPoints[k].x)*pnt.y+drawingPoints[k+1].x*drawingPoints[k].y-drawingPoints[k+1].y*drawingPoints[k].x);
			var near=bunsh/bunbo;
			var flag=1.0;
			if((Math.abs(drawingPoints[k+1].x-pnt.x)+Math.abs(drawingPoints[k].x-pnt.x))<10) flag=0.;
			var naib_x=flag*(drawingPoints[k+1].x-pnt.x)*(drawingPoints[k].x-pnt.x);
			flag=1.0;
			if((Math.abs(drawingPoints[k+1].y-pnt.y)+Math.abs(drawingPoints[k].y-pnt.y))<10) flag=0.;
			var naib_y=flag*(drawingPoints[k+1].y-pnt.y)*(drawingPoints[k].y-pnt.y);
console.log('p1,p2,line near=',drawingPoints[k],drawingPoints[k+1],pnt,near,'naib=',naib_x,naib_y);
			if(near<30 && naib_x<=0 && naib_y<=0) {
				nn=k+1;
				first_point=createFirstPoint([{x:pnt.x,y:pnt.y}]);
	        		Object.assign(first_point.style, defaultPointStyle);
				//var fig_id='pn'+("00" + (id)).slice( -2 );
				//first_point.setAttributeNS(null,'id', fig_id);
				//first_point.setAttributeNS(null,'class', 'movable');
				first_point.setAttribute('style', style="stroke-width: 1px; stroke: red; fill: pink;");
				first_point.setAttribute('fig', 'temp');
				tagn.appendChild(first_point);
				var result = window.confirm('Pointを追加しますか？');
				if(result==true){
					drawingPoints.splice(k+1, 0,{x:pnt.x,y:pnt.y});
					var c_para=tagn.getAttribute("close"); 
					var s_para=tagn.getAttribute("smooth"); 
console.log('s_para,c_para=',s_para,c_para);
					var new_path = set_line_group(tagn,c_para,s_para);
					tagn.removeChild(tagn.firstChild);
					tagn.insertBefore(new_path, tagn.firstChild);

					len=tagn.children.length;
					for(var k=len-1;k>0;k--){
						var tag=Drag_elem.children[k];
						tagn.removeChild(tag);
						}
					path_p=resolv_figure(new_path);
					var error=path_to_circle(new_path,path_p);
					}
				break;
				}
			}
		}
console.log(drawingPoints);
	}

// translate page to SVG co-ordinate
function svgPoint(element, x, y) {
  var pt = org_container.createSVGPoint();

  pt.x = x;
  pt.y = y;

  return pt.matrixTransform(element.getScreenCTM().inverse());
}


    function draw_move(e) {
	if(Move_mode){
console.log('Svg_mode=',Svg_mode);
		if(Svg_mode=='Svg_drag_pending') {
			//startDrag(e);
			Svg_mode='Svg_drag';
			return;
			}
		if(Svg_mode=='Svg_drag'){
			//handleMove(e);
			draw_basic_moving(e);
			return;
			}
		if(Draw_mode=="Basic") {
			draw_basic_moving(e);
			return;
			}
		if(Draw_mode=="Draw") {
			draw_origin_move(e);
			return;
			}
		}
	} //End of function draw_move

function draw_origin_move(e) {
	if(!isDrawing && Svg_mode!="") {
console.log('mouse move',control.value,'Step=',Step);
		if (control.value== 'free_line'){
			isDrawing=true;
			mv_flag=0;
			drawingPoints=[];
			Step=1;
console.log('Free_line Reset isDraw Step:1')
			}
		if ((control.value== 'quad_bezier') &&(Step==2)){
			isDrawing=true;
			mv_flag=1;
console.log('quad_bezier Step:',Step)
			}
		if ((control.value== 'cubic_bezier') &&(Step==3)){
			isDrawing=true;
			mv_flag=2;
console.log('cubic_bezier Step:',Step)
			}
console.log('move_flag=',mv_flag,'Oper=',Oper);
		}
	switch(mv_flag){
		case 0:
//console.log('free line');
			var len=drawingPoints.length;
			var near=20;
			if(len>2){
			near=Math.pow(drawingPoints[len-1].x-e.clientX,2)+Math.pow(drawingPoints[len-1].y-e.clientY,2);
console.log('len=',len,' near=',near);
				}
			else {
				drawingPoints.push({x: e.clientX,y: e.clientY});
				}
			if(near>10) {
            			drawingPoints.push({x: e.clientX,y: e.clientY});
            			if (drawingPath) {
                			container.removeChild(drawingPath);
					drawingPath=null;
console.log('remove old');
            				}
                		drawingPath = createPath(drawingPoints,0,null,null);
            			Object.assign(drawingPath.style, defaultPathStyle);
            			container.appendChild(drawingPath);
console.log('free line append point leng=',drawingPoints.length);
				}
			break;
		case 1:
			if(drawingPoints.length==3) {
				drawingPoints.pop();
				}
            		drawingPoints.push({x: e.clientX,y: e.clientY});
            		if (drawingPath) {
                		container.removeChild(drawingPath);
				drawingPath=null;
            			}
                	drawingPath = createQuadBezier(drawingPoints);
            		Object.assign(drawingPath.style, defaultPathStyle);
            		container.appendChild(drawingPath);
console.log('append bezier');
			break;
		case 2:
			if(drawingPoints.length==4) {
				drawingPoints.pop();
				}
            		drawingPoints.push({x: e.clientX,y: e.clientY});
            		if (drawingPath) {
                		container.removeChild(drawingPath);
				drawingPath=null;
            			}
                	drawingPath = createCubicBezier(drawingPoints,0);
            		Object.assign(drawingPath.style, defaultPathStyle);
            		container.appendChild(drawingPath);
console.log('append cubic bezier');
			break;
		}
    }  //End of function draw_origin_move

var basic_rect= {
	rect:null,
	x0:0,
	y0:0,
	w:10,
	h:10,
	}

function draw_basic_moving(e){
console.log('**draw_basic moving Step=',Step);

	if(Step==0) {
		basic_rect.x0=e.clientX;
		basic_rect.y0=e.clientY;
		Step=1;

		}
	else {
		basic_rect.w=Math.abs(e.clientX-basic_rect.x0);
		basic_rect.h=Math.abs(e.clientY-basic_rect.y0);
		if(basic_rect.rect) {
			container.removeChild(basic_rect.rect);
			basic_rect.rect=null;
			}
		basic_rect.rect=createRectFig(basic_rect.x0,basic_rect.y0,basic_rect.w,basic_rect.h);
		//rect01.setAttribute('id', 'rect01');
		container.appendChild(basic_rect.rect);
		}
	}  //end of draw_basic_moving

    function createPath(points,close,rect,def_points) {
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = '';
        points.forEach((point, index) => {
            if (index === 0) {
                attribute += `M${point.x}, ${point.y}`;
            } else {
                attribute += `L${point.x}, ${point.y}`;
            }
        });
	if(close=="close"){
		attribute += ` Z`;
		}
        path.setAttributeNS(null, 'd', attribute);
	if(tempArrowStyle || defaultArrowStyle) {
		if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
		}
//console.log('**path arrow=',tempArrowStyle);
    switch (tempArrowStyle){
      case 'start':
        	path.setAttribute('marker-start', "url(#start_arw)");
		break;
      case 'end':		              
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
      case 'both':               
        	path.setAttribute('marker-start', "url(#start_arw)");
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
	default:
		break;
		}
//console.log('**path Lstyle=',defaultLineStyle);
    switch (defaultLineStyle){
      case 'none':               
		break;
      case 'dash':               
        	path.setAttribute('stroke-dasharray', "4 4");
		break;
      case '1_dash':  
        	path.setAttribute('stroke-dasharray', "24 3 2 3");             
		defaultLineStyle="1_dash";
		break;
      case '2_dash':
        	path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
		break;
		}
//console.log('**createPath=',path);
        return path;
    }

    function createQuadBezier(points) {
console.log('quad bezier','length=',points.length);
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = '';
	var nx=2;
        points.forEach((point, index) => {
	    nx=nx+1;
	    mod3_nx=nx % 3;
console.log('nx=',nx,' mod3=',mod3_nx);
            if (mod3_nx== 0) {
		if(nx<4){
                	attribute += `M${point.x}, ${point.y}`;
            		} 
		else {
			attribute += `T${point.x}, ${point.y}`;
			}
		}
	    else if (mod3_nx==1) {
                attribute += `Q${point.x}, ${point.y}`;
            	}
	    else {
		attribute += ` ${point.x}, ${point.y}`;
		}
        });
        path.setAttributeNS(null, 'd', attribute);

//console.log('**path arrow=',defaultArrowStyle);
    switch (defaultArrowStyle){
      case 'none':               
		break;
      case 'start':
        	path.setAttribute('marker-start', "url(#start_arw)");
		break;
      case 'end':		              
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
      case 'both':               
        	path.setAttribute('marker-start', "url(#start_arw)");
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
		}
//console.log('**path Lstyle=',defaultLineStyle);
    switch (defaultLineStyle){
      case 'none':               
		break;
      case 'dash':               
        	path.setAttribute('stroke-dasharray', "4 4");
		break;
      case '1_dash':  
        	path.setAttribute('stroke-dasharray', "24 3 2 3");             
		defaultLineStyle="1_dash";
		break;
      case '2_dash':
        	path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
		break;
		}

console.log(path)
        return path;
    }

    function createCubicBezier(points,close) {
console.log('cubic bezier','length=',points.length);
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = '';
	var nx=2;
        points.forEach((point, index) => {
	    nx=nx+1;
	    mod3_nx=nx % 3;
console.log('nx=',nx,' mod3=',mod3_nx);
            if (mod3_nx== 0) {
		if(nx<4){
                	attribute += `M${point.x}, ${point.y}`;
            		} 
		else {
			attribute += ` ${point.x}, ${point.y}`;
			}
		}
	    else if (mod3_nx==1) {
                attribute += `C${point.x}, ${point.y}`;
            	}
	    else {
		attribute += ` ${point.x}, ${point.y}`;
		}
        });
	if(close=="close"){
		attribute += ` Z`;
		}
        path.setAttributeNS(null, 'd', attribute);

//console.log('**path arrow=',defaultArrowStyle);
    switch (defaultArrowStyle){
      case 'none':               
		break;
      case 'start':
        	path.setAttribute('marker-start', "url(#start_arw)");
		break;
      case 'end':		              
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
      case 'both':               
        	path.setAttribute('marker-start', "url(#start_arw)");
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
		}
//console.log('**path Lstyle=',defaultLineStyle);
    switch (defaultLineStyle){
      case 'none':               
		break;
      case 'dash':               
        	path.setAttribute('stroke-dasharray', "4 4");
		break;
      case '1_dash':  
        	path.setAttribute('stroke-dasharray', "24 3 2 3");             
		defaultLineStyle="1_dash";
		break;
      case '2_dash':
        	path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
		break;
		}
console.log(path)
        return path;
    }

    function draw_up(e) {
	if(mouse_Error) {
		mouse_Error=false;
		Up_count=0;
		}
	else if (Move_mode) {
console.log('canceled Move_mode');
		if(Draw_mode=="Basic") {
			draw_op.posx=e.clientX;
			draw_basic_moveup();
			}
		else if(Svg_mode=="Svg_drag") {   //領域選択の場合 この条件は不備
			tagn=container;
			var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
			var g_list=area_catch_figure(tagn);
console.log('select tags=',g_list);
			Svg_mode="Selected";
			drag.group=g_list;
			drag.target=tagn;
			}
		else if(Draw_mode=="Drag") {
console.log('***Move or Reshape drag end Svg_mode=',Svg_mode);
	    		if(Svg_mode=="Svg_reshape_pending") {      //Path変形の場合
console.log('length=',drawingPoints.length,drawingPoints);
				var offx=Number(drag.target.getAttributeNS(null, "cx"));
				var offy=Number(drag.target.getAttributeNS(null, "cy"));
				var point = org_container.createSVGPoint();
				point.x=offx;
				point.y=offy;
				var localMatrix = drag.target.getCTM();
				var localPoint = point.matrixTransform(localMatrix); 
//				drawingPoints[drag.id_num]={x:drag.offsetx,y:drag.offsety};
//				drawingPoints[drag.id_num]=localPoint;

				var point=svgPoint(drag.target.parentNode, localPoint.x, localPoint.y);
				drawingPoints[drag.id_num]={x:point.x,y:point.y};

console.log('modified=',drag.id_num,' length=',drawingPoints.length,drawingPoints);
				if(drag.c_para=='close') {
					drawingPoints[drawingPoints.length-1]=drawingPoints[0];
					}
console.log('length=',drawingPoints.length,drawingPoints);
				var new_path = set_line_group(Drag_elem,drag.c_para,drag.s_para);
				Drag_elem.removeChild(Drag_elem.firstChild);
				Drag_elem.insertBefore(new_path, Drag_elem.firstChild);
				Svg_mode=="Svg_reshape_pending"
				}
	    		if(Svg_mode=="Svg_scale_pending") {      //拡大縮小の場合
//拡大縮小の基準点はDrag点とは反対側の点とする。　scale_callback関数で決めている。
				var offx=Number(drag.target.getAttributeNS(null, "cx"));
				var offy=Number(drag.target.getAttributeNS(null, "cy"));

				var point = org_container.createSVGPoint();
				point.x=offx;
				point.y=offy;
				var localMatrix = drag.target.getCTM();
				var localPoint = point.matrixTransform(localMatrix); 

				var point=svgPoint(drag.target.parentNode, localPoint.x, localPoint.y);

console.log('center=',drag.center_x,drag.center_y,' width height=',drag.hf_width,drag.hf_height);
console.log('point=',offx,offy,'group point=',point.x,point.y);
				var sx=0;
				var sy=0;
				var angle=vMove=hMove=0;
				//	svgにSVGTransformを生成する
				var Transform = org_container.createSVGTransform();
console.log(Transform);
				//	生成されたTransform内のmatrixオブジェクトをMatrixに参照
				var Matrix = Transform.matrix;
				var target_group=drag.target.parentNode;

    				switch (drag.id_num){
      					case 1:
					case 2:
      					case 3:
					case 4:
						var tag=document.getElementById(drag.fixpnt);
						var x0=Number(tag.getAttributeNS(null, "cx"));
						var y0=Number(tag.getAttributeNS(null, "cy"));
						var parm1=`${x0},${y0}`;
						var parm2=`${-x0},${-y0}`;
						sx=Math.abs(point.x-drag.center_x)/drag.hf_width;
						sy=Math.abs(point.y-drag.center_y)/drag.hf_height;
						sx=sy=Math.max(sx,sy);
						var sc_parm=`${sx},${sy}`;
						transform="translate("+parm1+")"+"scale("+sc_parm+")"+"translate("+parm2+")";
console.log('transform=',transform);
						drag.target.parentNode.setAttribute('transform', transform);
						break;
					case 5:
					case 6:
					case 7:
					case 8:
						var tag=document.getElementById(drag.fixpnt);
						var x0=Number(tag.getAttributeNS(null, "cx"));
						var y0=Number(tag.getAttributeNS(null, "cy"));
						var parm1=`${x0},${y0}`;
						var parm2=`${-x0},${-y0}`;
						sx=Math.abs(point.x-drag.center_x)/drag.hf_width;
						sy=Math.abs(point.y-drag.center_y)/drag.hf_height;
						if(sx>sy) sy=1;
						else sx=1;
						var sc_parm=`${sx},${sy}`;
						transform="translate("+parm1+")"+"scale("+sc_parm+")"+"translate("+parm2+")";
console.log('transform=',transform);
						drag.target.parentNode.setAttribute('transform', transform);
						break;
      					case 10:   //rotateの場合　angle　0～360
					case 11:   //a=cos(angle) b=sin(angle) c=-sin(angle) d=cos(angle)
console.log('rotate');
						var tag=document.getElementById(drag.fixpnt);
						var p1 = org_container.createSVGPoint();
						p1.x=Number(tag.getAttributeNS(null, "cx"));
						p1.y=Number(tag.getAttributeNS(null, "cy"));
						var cnt = org_container.createSVGPoint();
						cnt.x=drag.center_x;
						cnt.y=drag.center_y;
						angle = angle_between_points(p1, cnt,point);
console.log('****angle=',angle);
						var rol_parm=`${angle},${cnt.x},${cnt.y}`;
console.log('rotate transform=',rol_parm);
						drag.target.parentNode.setAttribute('transform',"rotate("+rol_parm+")");
						break;
　　　					default:
						return;
						break;
					}	
console.log('redraw');
				catch_scale_fig(drag.target.parentNode);
//console.log('scalexy=',scalex,scaley,'rotate=',angle);
			}
		}
	else {
		draw_up_origin(e);
		}
	Move_mode=0;
	temp_snap_flag=0;
	} //End of function draw_up

// p1 is the center point; result is in degrees
function angle_between_points( p0, p1, p2 ) {
  var a = p2.x-p0.x;
  var b = p2.y-p0.y;
  if(Math.abs(a)>Math.abs(b)) {
	var dx=a/Math.sqrt((p1.x-p0.x)**2 + (p1.y-p0.y)**2)
	var ang=Math.asin(dx)
	}
   else {
	var dy=b/Math.sqrt((p1.x-p0.x)**2 + (p1.y-p0.y)**2)
	var ang=Math.asin(dy)
	}
  return ang*180/Math.PI;
  }

    function draw_up_origin(e) {
        	if ((control.value === 'quad_bezier') && (Step==2)){
console.log('bezier mouseup');
            		if (bezier_line){
				container.removeChild(bezier_line);
				bezier_line=null;
				}
				if (drawingPath) {
                			container.removeChild(drawingPath);
					drawingPath=null;
            				}
            			var path = createQuadBezier(drawingPoints);
	        		Object.assign(path.style, defaultPathStyle);
	        		container.appendChild(path);
				var {group,fig_id}=make_group('quad');
				group.appendChild(path);
				if(tempArrowStyle || defaultArrowStyle) {
					if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
console.log('arrowstyle=',tempArrowStyle);
					remake_group(group,path,tempArrowStyle);
					tempArrowStyle='';
					}
				Step=3;
console.log('quad line=',group);
		        }
        	else if ((control.value === 'cubic_bezier') && (Step==3)){
console.log('cubic bezier mouseup');
            		if (bezier_line){
				container.removeChild(bezier_line);
				bezier_line=null;
				}
			if (bezier_line1){
				container.removeChild(bezier_line1);
				bezier_line1=null;
				}
				if (drawingPath) {
                			container.removeChild(drawingPath);
					drawingPath=null;
            				}
            			var path = createCubicBezier(drawingPoints,0);
	        		Object.assign(path.style, defaultPathStyle);
	        		container.appendChild(path);
				var {group,fig_id}=make_group('cubic');
				group.appendChild(path);
				if(tempArrowStyle) {
console.log('arrowstyle=',tempArrowStyle);
					remake_group(group,path,tempArrowStyle);
					tempArrowStyle='';
					}
				Step=4;
console.log('cubic line=',group);
		        }
		else {
			if(Step==1) {
				if (drawingPath) {
					container.removeChild(drawingPath);
					drawingPath=null;
            				}
            			var path = createPath(drawingPoints,0,null,null);
	        		Object.assign(path.style, defaultPathStyle);
	        		container.appendChild(path);
				var {group,fig_id}=make_group('free');
				group.appendChild(path);
				tempArrowStyle='';
				remake_group(group,path,tempArrowStyle);
console.log('free line=',group);
				}
        		}
            	if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
			}
		isDrawing=false;
		Oper=0;
		mv_flag=10;
		Step=0;
		first_point='';
		drawingPoints = [];
	}
    }  //End of function draw_up_origin

function draw_basic_moveup(){
console.log('**draw_basic move end');
/* 注意：拡大縮小の変換は左上の座標値が倍率の値に変換されるので基本図は（0,0)のものが必要　*/
	var rect_a=draw_op.target.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	var rect_b=basic_rect.rect.getBoundingClientRect();
console.log('**rect_b=',rect_b);

        var scx=Math.ceil(100*(rect_b['right']-rect_b['left'])/(rect_a['right']-rect_a['left']))/100;
        var scy=Math.ceil(100*(rect_b['bottom']-rect_b['top'])/(rect_a['bottom']-rect_a['top']))/100;
	var parm=`${scx},${scy}`;

	var sx= Math.ceil(rect_b['left']-rect_a['left']);
	var sy= Math.ceil(rect_b['top']-rect_a['top']);
        var tr_parm=`${sx},${sy}`;
	var dumy=(draw_op.target).cloneNode(true);
	dumy.setAttribute("transform", "translate("+tr_parm+")"+"scale("+parm+")");

console.log('**basic fig=',draw_op.fig);
	if(draw_op.fig=='basic'){
		var fig_id='b'+(Date.now()).toString();
		dumy.setAttribute('id', fig_id);
		dumy.setAttribute('fig', 'basic');

        			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				var fig_id2='g'+(Date.now()).toString();
				wgroup.setAttribute('id', fig_id2);
				wgroup.setAttribute('fig', 'group');
				var g_temp=container.appendChild(wgroup);
			simple_fig(g_temp,dumy);              //transform matrixを適用して図形simple化
		}
	else {
		if(draw_op.fig=='text'){
			var fig_id='t'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'text');
			container.appendChild(dumy);
			}
	     	else {
			var fig_id='g'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'group');
			container.appendChild(dumy);
			}
		}

	container.removeChild(basic_rect.rect);
	basic_rect.rect=null;
console.log('scale=',scx,scy,' translate=',sx,sy);
	Step=0;
	}  //end of draw_basic_moveup

function area_catch_figure(tagn){
console.log('**area_catch figure start area=',tagn);
/* tagn 領域内で指定区画内にあるg要素を探す　*/
	var rect_a=basic_rect.rect.getBoundingClientRect();
console.log('**rect_a=',rect_a);

	let w=rect_a.right-rect_a.left;
	let h=rect_a.bottom-rect_a.top;			
	var pnt1=svgPoint(tagn, rect_a.left, rect_a.top);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す

	var g_list=[];
	var len=tagn.children.length;
	for(let i=0;i<len;i++) {
		var temp=tagn.children[i];
console.log('area tag no= ',i,temp.nodeName,temp);
		if(temp.nodeName=='g') {
			var rect_b=temp.getBoundingClientRect();
			var yes=temp_include(tagn,rect_b,pnt1,w,h);
			
			if(yes) {
				if(((rect_b.right-rect_b.left)<5)||((rect_b.bottom-rect_b.top)<5)){
					if((rect_b.right-rect_b.left)<5) {
						var rect_cright=rect_b.right+2;
						var rect_cleft=rect_b.left-2;
						rect01=createRectFig(rect_cleft,rect_b.top,rect_cright-rect_cleft,rect_b.bottom-rect_b.top);
					}
					if((rect_b.bottom-rect_b.top)<5) {
						var rect_cbottom=rect_b.bottom+2;
						var rect_ctop=rect_b.top-2;
						rect01=createRectFig(rect_b.left,rect_ctop,rect_b.right-rect_b.left,rect_cbottom-rect_ctop);
						}
					}
				else {
					rect01=createRectFig(rect_b.left,rect_b.top,rect_b.right-rect_b.left,rect_b.bottom-rect_b.top);
					}
				tagn.appendChild(rect01);
				g_list.push({temp,rect01});
				rect01.setAttribute('class', 'draggable');
				}
			}
		}
	container.removeChild(basic_rect.rect);
	basic_rect.rect=null;
	if(g_list.length==1) g_list=g_list[0];
	return g_list;
	}  //end of area_catch_figure

function temp_include(tagn,rect_a,pnt,w,h) {
console.log('Enter temp_include pnt,w,h=',pnt,w,h);
	let w2=rect_a.right-rect_a.left;
	let h2=rect_a.bottom-rect_a.top;			
	var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

	var ptary=[];
	ptary.push({x: pnt2.x,y: pnt2.y});
	ptary.push({x: pnt2.x+w2,y: pnt2.y});
	ptary.push({x: pnt2.x+w2,y: pnt2.y+h2});
	ptary.push({x: pnt2.x,y: pnt2.y+h2});
console.log('each pont=',ptary);
	result=false;
	for(let k=0;k<ptary.length;k++) {
		if(((ptary[k].x-pnt.x)*(ptary[k].x-pnt.x-w)<0) && ((ptary[k].y-pnt.y)*(ptary[k].y-pnt.y-h)<0)) {
console.log('Catch Figure');
			result=true;
			break;
			}
		}
	return result;
   }

function getAbsoluteRectPosition(elm){
  const {left, top,width,height} = elm.getBoundingClientRect();
  const {left: bleft, top: btop} = document.body.getBoundingClientRect();
  return {
    left: left - bleft,top: top - btop,right:left-bleft+width,bottom:top-btop+height
  };
}

  var RAD2DEG = 180 / Math.PI;

  function angleBetweenPoints(p1, p2) {
    var angle = null;
    if (p1.x == p2.x && p1.y == p2.y)
      angle = Math.PI / 2;
    else
      angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
    return (angle * RAD2DEG) + -90;
  }

   function chng_arrow()　{
console.log('**Enter change arrow start/end**',Editmode);
　　let select = document.getElementById('arrow');
    //選択したf_editによって分岐
    switch (select.selectedIndex){
      case 0:               
		defaultArrowStyle="";
		break;
      case 1:               
		defaultArrowStyle="start";
		break;
      case 2:               
		defaultArrowStyle="end";
		break;
      case 3:               
		defaultArrowStyle="both";
		break;
		}
	}

   function chng_Lstyle()　{
console.log('**Enter change Line style**',Editmode);
　　let select = document.getElementById('Lstyle');
    //選択したf_editによって分岐
    switch (select.selectedIndex){
      case 0:               
		defaultLineStyle="none";
		break;
      case 1:               
		defaultLineStyle="dash";
		break;
      case 2:               
		defaultLineStyle="1_dash";
		break;
      case 3:               
		defaultLineStyle="2_dash";
		break;
		}
	}

function mail_to(){
		//class=Tivの複製
  var data=get_common(7);
//console.log('data=',data);

    const parser = new DOMParser();
    const html_dat = parser.parseFromString(data, "text/html");

    var tagn=document.getElementById('texx');
    var dumy=tagn.cloneNode(true);

	dlist=dumy.querySelectorAll('svg');
	dlist.forEach(function (element) {
		element.children[0].remove();
		element.setAttribute('style','display;block');
		element.setAttribute('class','canv point_none');
//console.log(element);
		});

	var btag=html_dat.querySelector('body');
//console.log(btag);
	btag.appendChild(dumy);
	var title='my first mail test';
console.log(html_dat);

	const serializer = new XMLSerializer();
	const es_html = serializer.serializeToString(html_dat);
//	var es_html=escapeHtml(escape(xmlStr));
//console.log('Escape=',es_html,'leng=',es_html.length);

        $.ajax({
            url: "/db_serv/mail_to/",
            async:true,
	    type: "GET",
  	    traditional:true,
            data: {
		"type":'html',
		"title":title,
		"html_dat":es_html,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
console.log('**Ajax Returned result=',data);
        });
alert('mail sennd');
    }  //End of mail_to

    fig_copy.onclick = function(){
console.log("Enter fig_copy　Editmode=",Editmode);
//	if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")){
	if(Drag_elem){
		// 選択要素の複製
		var group = Drag_elem.cloneNode(true);
		var fig_id='g'+(Date.now()).toString();
		group.setAttribute('id', fig_id);
		container.appendChild(group);
		Drag_elem.copy=group;
		//選択要素の選択解除
		//document.getElementById("fig_sel_end").click();
		//複製要素のX成分の10px移動
		//複製要素の選択
		//Drag_elem = document.getElementById(fig_id);
		//drag.target=Drag_elem;
		var random = String(Math.floor( Math.random() * 45 ) + 5);   //最大値50から最小値5を引いた「45」を使う
		group.setAttribute("transform", "translate("+random+",10)");
		//Drag_elem.setAttribute('class', 'draggable');
		//Draw_mode='Drag';
		//drag.break=false;
		//draggable(Drag_elem);
		//Svg_mode='Svg_drag_pending';
		}
    }

    fig_updown.onclick = function(){
	if(Svg_mode!='Svg_updown') {
		if(!Drag_elem) {
alert('figure not selected');
			return;
			}
		prev_Draw_mode=Draw_mode;
		pre_Svg_mode=Svg_mode;
		Draw_mode="";
		Svg_mode="Svg_updown";
		svg_step_flag=0;
		document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
console.log("Updown figure=",Drag_elem);
		catch_updown_fig(Drag_elem);
		return;
		}
	else {	//Svg_updownの2step目ならば以下の処理を実施する
		if(svg_step_flag<1) return;
		var pnt=svgPoint(Drag_elem, drag.offsetx, drag.offsety);
		}
	temp_delete(Drag_elem);
	simple_fig(dumy_group,Drag_elem);              //transform matrixを適用して図形simple化
	copy_svgtag(Drag_elem,dumy_group);
//console.log('After simple=',tagn,dumy_group);

	if(Math.abs(drag.center_x-pnt.x)>Math.abs(drag.center_y-pnt.y)) {
		upsidedown_fig(dumy_group,Drag_elem,drag.center_x,'x');
		}
	else {
		upsidedown_fig(dumy_group,Drag_elem,drag.center_y,'y');
		}
		copy_svgtag(Drag_elem,dumy_group);
	Svg_mode="";
	svg_step_flag=0;
    }

/*
    fig_updown.onclick = function(){
console.log("Enter fig_upsidedown　Editmode=",Editmode);
	if(Svg_mode!='Svg_updown') {
		document.getElementById("fig_sel_end").click();
		prev_Draw_mode=Draw_mode;
		pre_Svg_mode=Svg_mode;
		Draw_mode="";
		Svg_mode="Svg_updown";
		svg_step_flag=0;
		document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//		document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
console.log("Enter Figure updown Mode Svg_mode=",Svg_mode);
		return;
		}
	else {	//Svg_updownの2step目ならば以下の処理を実施する
		if(svg_step_flag<2) return;
		var pnt=svgPoint(Drag_elem, drag.offsetx, drag.offsety);
//	first_point=createFirstPoint([{x:drag.offsetx,y:drag.offsety}]);
//	Object.assign(first_point.style, defaultPointStyle);
//        org_container.appendChild(first_point);
		}
//click pointが中心からx方向又はｙ方向に離れているかでｘ方向ならば左右にｙ方向ならば上下に反転する
console.log('fig_center=',drag.center_x,drag.center_y);

		temp_delete(Drag_elem);
		simple_fig(dumy_group,Drag_elem);              //transform matrixを適用して図形simple化
		copy_svgtag(Drag_elem,dumy_group);
//console.log('After simple=',tagn,dumy_group);

		var rect_a=Drag_elem.getBoundingClientRect();
console.log('**rect_a=',rect_a,Drag_elem);
		let w=rect_a.width;
		let h=rect_a.height;

		var pnt2=svgPoint(Drag_elem, rect_a.left, rect_a.top);
		drag.center_x=pnt2.x+w/2;
		drag.center_y=pnt2.y+h/2;

console.log('fig_center=',drag.center_x,drag.center_y);
//	first_point=createFirstPoint([{x:drag.center_x,y:drag.center_y}]);
//	Object.assign(first_point.style, defaultPointStyle);
//        org_container.appendChild(first_point);
		
		if(Math.abs(drag.center_x-pnt.x)>Math.abs(drag.center_y-pnt.y)) {
			upsidedown_fig(dumy_group,Drag_elem,drag.center_x,'x');
			}
		else {
			upsidedown_fig(dumy_group,Drag_elem,drag.center_y,'y');
			}
		copy_svgtag(Drag_elem,dumy_group);
	Svg_mode="";
	svg_step_flag=0;
    }
*/

    function upsidedown_fig(g_temp,g_group,cnt_xy,xory) {  //g_groupのpathを上下又は左右に反転し、g_tempに作成する
console.log('**simple fig Node=',g_group.nodeName);
	if(g_group.nodeName!='g' || g_temp.nodeName!='g') {
//		console.log('cant simplify this element');
alert('cant upsidedown');
		return;
		}
//console.log('child node leng=',g_group.childElementCount);
	for (var k = 0; k < g_group.childElementCount; k++) {
		tag=g_group.children[k];
//console.log('child k=',k,tag);
		if(tag.nodeName=="path") {
			var target=tag.cloneNode(true);
			var path_p=resolv_figure(target);
//console.log(path_p);
			var path_nw=cord_upside(path_p,cnt_xy,xory);
console.log('new_path=',path_nw);
			var new_pathd=set_phrase(target,path_nw);
        		target.setAttributeNS(null,'d', new_pathd);
			Object.assign(target.style, defaultPathStyle);   //Basic図を指定のカラーで描画
			g_temp.appendChild(target);
			}
		else if(tag.nodeName=="g") {
			var target=tag.children[0].cloneNode(true);
			var path_p=resolv_figure(target);
//console.log(path_p);
			var path_nw=cord_upside(path_p,cnt_xy,xory);
//console.log(path_nw);
			var new_pathd=set_phrase(target,path_nw);
        		target.setAttributeNS(null,'d', new_pathd);
			g_temp.appendChild(target);
			}
		}
	} //End function

function cord_upside(path_p,cnt_xy,xory) {
console.log('Points=',path_p);
	var pnx,pny;
	var nw_path=[];
	for ( var i = 0;  i < path_p.length ; i++ ){
		var pt=path_p[i];
		if(xory=='x') {
			pnx=2*cnt_xy-pt.x;
			pny=pt.y;
			}
		else {
			pnx=pt.x
			pny=2*cnt_xy-pt.y;
			}
		nw_path.push({x:pnx,y:pny});
		}
	return nw_path;
	} //End of function


    fig_delete.onclick = function() {
console.log("Enter fig_delete at Svg_mode=",Svg_mode);
	if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")){
	    var result=check_hist(container,Drag_elem,'del');
	    if(result) container.removeChild(Drag_elem);
        }
    //Svg_mode="Draw";
    //Draw_mode="Draw";
    }

function export_mode() {

    switch (Exp.selectedIndex){
      case 0:               
		break;
      case 1:               //onlty svg
		export_svg();
		break;

      case 2:               //To html
		my_confirm(9);
//		export_html();
		break;
	}
    }

//    export_svg.onclick = function(){
function export_svg() {
console.log("***Enter export");
	mesh_draw=false;
	svg_tag='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">'
console.log('outerHTML=',svg_tag);
console.log('**container nodename= ',container.nodeName,'id= ',fig_id);
console.log('**container child length=',container.childElementCount);
	for (nn = 0; nn < container.childElementCount; nn++) {
		if(container.children[nn].nodeName!='defs'){
			svg_tag=svg_tag+container.children[nn].outerHTML;
			}
console.log('***list n =',nn,' length = ', svg_tag.length);
		}
	svg_tag=svg_tag+'</svg>';

let blob = new Blob([svg_tag],{type:"svg"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'testfile.svg';
link.click();
	}

    function createFirstPoint(points) {
	var svg = document.getElementById(svg_now),
  	NS = svg.getAttribute('xmlns');
	circ1=document.createElementNS(NS,'circle');
	circ1.setAttributeNS(null,'cx',points[0].x);
	circ1.setAttributeNS(null,'cy',points[0].y);
	circ1.setAttributeNS(null,'r',5);
//	circ1.setAttributeNS(null,'fill','red');
//	circ1.setAttributeNS(null,'stroke','black');
//	svg.appendChild(circ1);
//console.log(circ1)
        return circ1;
    }

    function createRectFig(x,y,w,h) {
	rect1=document.createElementNS('http://www.w3.org/2000/svg','rect');
	rect1.setAttribute('x',x);
	rect1.setAttribute('y',y);
	rect1.setAttribute('width',w);
	rect1.setAttribute('height',h);
	rect1.setAttribute('stroke','blue');
	rect1.setAttribute('fill','none');
        rect1.setAttribute('strokeWidth','1px');
//	container.appendChild(rect1);
//console.log(rect1)
        return rect1;
    }

// ビジーwaitを使う方法
function sleep(waitMsec) {
  var startMsec = new Date();
 
  // 指定ミリ秒間だけループさせる（CPUは常にビジー状態）
  while (new Date() - startMsec < waitMsec);
}

function escapeHtml(convertString) {
    if (typeof convertString !== 'string') return convertString;
 
    var patterns = {
        '<'  : '&lt;',
        '>'  : '&gt;',
        '&'  : '&amp;',
        '"'  : '&quot;',
        '\'' : '&#x27;',
        '`'  : '&#x60;'
    };
 
    return convertString.replace(/[<>&"'`]/g, function(match) {
        return patterns[match];
    });
};
function unescapeHtml(target) {
    if (typeof target !== 'string') return target;
 
    var patterns = {
        '&lt;'   : '<',
        '&gt;'   : '>',
        '&amp;'  : '&',
        '&quot;' : '"',
        '&#x27;' : '\'',
        '&#x60;' : '`'
    };
 
    return target.replace(/&(lt|gt|amp|quot|#x27|#x60);/g, function(match) {
        return patterns[match];
    });
};

function cutescape(convertString) {
    if (typeof convertString !== 'string') return convertString;
 
    return convertString.replace(/[<>&"'`,]/g,'.');
   };

/*
function catmullRom2bezier(pts){
    var cubics = [];
    for ( var i = 0, iLen = pts.length; i < iLen ; i++ ){
        var p = [
            pts[i - 1],
            pts[i],
            pts[i + 1],
            pts[i + 2]
        ];
        if( i === 0 ){
            p[0] = {
                x: pts[ 0 ].x,
                y: pts[ 0 ].y
            }
        }
        if( i === iLen - 2 ){
            p[3] = {
                x: pts[iLen - 2].x,
                y: pts[iLen - 2].y
            };
        }
        if ( i === iLen - 1 ) {
            p[2] = {
                x: pts[iLen - 1].x, 
                y: pts[iLen - 1].y
            };
            p[3] = {
                x: pts[iLen - 1].x, 
                y: pts[iLen - 1].y
            };
        }
      const val = 6;
        cubics.push([
            (-p[0].x + val * p[1].x + p[2].x) / val,
            (-p[0].y + val * p[1].y + p[2].y) / val,
            (p[1].x + val * p[2].x - p[3].x) / val,
            (p[1].y + val * p[2].y - p[3].y) / val,
            p[2].x,
            p[2].y
        ]);
    }
    return cubics;
}
*/


function splitArray(array, part) {
    var tmp = [];
    for(var i = 0; i < array.length; i += part) {
        tmp.push(array.slice(i, i + part));
    }
    return tmp;
}

var Inter_Line = function(line1, line2) {
    var x0 = line1.start.x,
        y0 = line1.start.y,
        x1 = line1.end.x,
        y1 = line1.end.y,
        x2 = line2.start.x,
        y2 = line2.start.y,
        x3 = line2.end.x,
        y3 = line2.end.y;
//console.log(line1,line2);
    var at = (x1-x0)*(y3-y2)-(x3-x2)*(y1-y0),
        as = -(y1-y0)*(x3-x2)+(y3-y2)*(x1-x0);

console.log(' at,as=',at,as);
	if (at==0 || as==0) return false;
//	if(Math.abs(at)<0.001) at=0.01;
//	if(Math.abs(as)<0.001) as=0.01;
 
    var t = ((x2-x0)*(y3-y2)-(y2-y0)*(x3-x2))/at,
        s = ((x2-x0)*(y1-y0)-(y2-y0)*(x1-x0))/as;

    var x = x0+(x1-x0)*t,
        y = y0+(y1-y0)*t;
 
    return { x : x, y : y };
};

/*
    image_sel.onclick = function(){
	Svg_mode="Text_drag";
console.log("Enter Image_Select_start　Editmode=",Editmode,' Svg_mode=',Svg_mode);
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
    }
*/

    fig_sel_st.onclick = function(){
	prev_Draw_mode=Draw_mode;
	pre_Svg_mode=Svg_mode;
	Draw_mode="";
	Svg_mode="Svg_drag";
//	change_css("Svg");
//	stop(false,false);
//	finish();
console.log("Enter fig_sel start　SVG_mode=",Svg_mode);
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
//alert('fig_sel start');
    }

    fig_sel_end.onclick = function(){
	if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")||(Svg_mode=="Svg_reshape")||(Svg_mode=="Svg_reshape_pending")
					||(Svg_mode=="Svg_scale")||(Svg_mode=="Svg_scale_pending"))
	{
           //SVG 補助図形の削除
		if(Drag_elem) {
//console.log('SVG　Quitモード tag= ',Drag_elem,'len=',Drag_elem.children.length);
			len=Drag_elem.children.length;
			//firstChildを残して補助用として追加した要素を削除する

			for(var k=len-1;k>0;k--){
				var tagn=Drag_elem.children[k];
//console.log('k= ',k,tagn);
				var fig=tagn.getAttribute('fig');
				if(fig=='temp') {
					Drag_elem.removeChild(tagn);
					}
				Drag_elem.setAttribute('class', 'none');
				}
			if(Svg_mode=="Svg_drag_pending") {
//onmousemoveを無効にする
	    			document.documentElement.setAttributeNS(null, "onmousemove",null)
				}
    			Drag_elem.removeEventListener('click', elem_callback ,false);
    			Drag_elem.removeEventListener('click', scale_callback ,false);
    			Drag_elem=null;
			}
		}
//Duit draw
	var tagnn=container;
	var fig_grp=tagnn.getAttribute('fig');
	if( fig_grp=='top'){
		var len=tagnn.childElementCount;
		for(var k=len-1; k>=0 ;k--) {
			var childtag=tagnn.children[k];
//console.log('nodeName=',childtag.nodeName);
			if(childtag.nodeName!='g') {
//console.log('deleted nodeName=',childtag.nodeName);
				tagnn.removeChild(childtag);
				}
			}
		}

    Step=0;
    //container.addEventListener( 'mousedown', draw_down,false);
    //container.addEventListener('mouseup', draw_up,false);
    drag.target=null;
    document.getElementById('contextmenu_a').style.display="none";
    document.getElementById('contextmenu_b').style.display="none";

    Svg_mode=pre_Svg_mode;
    Draw_mode=prev_Draw_mode;
    Move_mode=0;
    temp_snap_flag=0;
console.log('mode Reset Svg_mode=',Svg_mode,' Draw_mde=',Draw_mode);
    } //End of fig_sel_end

function temp_delete(elem) {
	if(elem) {
//console.log('elem= ',elem,'len=',elem.children.length);
		len=elem.children.length;
		//firstChildを残して補助用として追加した要素を削除する
		for(var k=len-1;k>0;k--){
			var tagn=elem.children[k];
//console.log('k= ',k,tagn);
			var fig=tagn.getAttribute('fig');
			if(fig=='temp') {
				elem.removeChild(tagn);
				}
			}
		if(bezier_line){
			bezier_line=null;
			}
		}
	}
function temp_fixed(elem) {
	if(elem) {
//console.log('elem= ',elem,'len=',elem.children.length);
		len=elem.children.length;
		//firstChildを残して補助用として追加した要素を削除する
		for(var k=len-1;k>0;k--){
			var tagn=elem.children[k];
//console.log('k= ',k,tagn);
			var fig=tagn.getAttribute('fig');
			if(fig=='temp') {
				tagn.setAttribute('fig','fixed');
				tagn.removeAttribute('id');
				}
			}
		if(bezier_line){
			bezier_line=null;
			}
		}
	}

function temp_snap_fix() {
console.log('snap fix called');
	var {group,fig_id}=make_group('fixed');
	var rects=container.querySelectorAll('rect');
	var lines=container.querySelectorAll('line');

	if(drawingPath) {
		var paths=drawingPath.cloneNode(true);
		group.appendChild(paths);
		}
/*
	var lines=container.querySelectorAll('line');
	if(lines) {
console.log('line cloneed');
		var dm_lines=lines.cloneNode(true);
		group.appendChild(dm_lines);
		}
*/
	if(first_point) {
		var dm_points=first_point.cloneNode(true);
		group.appendChild(dm_points);
		}

	if(bezier_line) {
		var bez=bezier_line.cloneNode(true);
		group.appendChild(bez);
		}
	if(bezier_line1) {
		var bez1=bezier_line1.cloneNode(true);
		group.appendChild(bez1);
		}
	var randx = String(Math.floor( Math.random() * 45 ) + 5);   //最大値50から最小値5を引いた「45」を使う
	var randy = String(Math.floor( Math.random() * 45 ) + 5);
	group.setAttribute("transform", "translate("+randx+","+randy+")");
	

console.log('path=',paths,'rect=',rects,'line=',lines);
	}


    fig_reshape.onclick = function(){
//	document.getElementById("fig_sel_end").click();
	prev_Draw_mode=Draw_mode;
	pre_Svg_mode=Svg_mode;
	Draw_mode="";
	Svg_mode="Svg_reshape";
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
console.log('reshape figure=',Drag_elem)
	if(!Drag_elem) {
alert('figure not selected');
		return;
		}
	temp_delete(Drag_elem);
	error=reshape_figure(Drag_elem);
	if(error==1) {
		drag.s_para=Drag_elem.getAttribute('smooth');
		drag.c_para=Drag_elem.getAttribute('close');
		Svg_mode='Svg_reshape_pending';
		//var reshape = document.getElementById(fig_id)
		Drag_elem.addEventListener('click',elem_callback,false);
		}
	else Svg_mode="";
console.log("Enter Figure Reshape Mode Svg_mode=",Svg_mode);
    }

var fig_scale_witch;

    fig_scale.onclick = function(){
	fig_scale_witch="scale";
	fig_scale_rotate();
    }

    fig_rotate.onclick = function(){
	fig_scale_witch="rotate";
	fig_scale_rotate();
    }

    function fig_scale_rotate() {
	prev_Draw_mode=Draw_mode;
	pre_Svg_mode=Svg_mode;
	Draw_mode="";
	Svg_mode="Svg_scale";
//	document.getElementById("fig_sel_end").click();
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
	if(!Drag_elem) {
alert('figure not selected');
		return;
		}
console.log("Scale figure=",Drag_elem);
	catch_scale_fig(Drag_elem);
	//矩形の描画とDraggerbleの設定
	//createRectFig(x,y,w,h)
	//Drag_elem = document.getElementById(fig_id);
	Svg_mode='Svg_scale_pending';
	Drag_elem.addEventListener('click',scale_callback,false);
    }
//drag_drag_drag
var drag = {
	isMouseDown : false,
	target : null,
	group:null,
	elem:null,
	id_num:0,
	center_x:0,
	center_y:0,
	hf_width:1,
	hf_height:1,
	offsetx : 0,
	offsety : 0,
	c_para:null,
	s_para:null,
	break:false,
	selector:null,
	title:null,
	fixpnt:'',
}
var drag_elem = {
	target : null,
	id_num:0,
	c_para:null,
	s_para:null,
	copy:'',
}
/*
document.onmouseup = function () {
console.log('** element drag stop');
	drag.isMouseDown = false;
}
document.onmousemove = function( e ) {
console.log('** element drag moving');
        if (drag.isMouseDown == true) {
		drag.target.transform.baseVal[0].matrix.e=drag.target.transform.baseVal[0].matrix.e+e.clientX - drag.offsetx;
		drag.target.transform.baseVal[0].matrix.f=drag.target.transform.baseVal[0].matrix.f+e.clientY - drag.offsety;
		drag.offsetx = e.clientX; 
		drag.offsety = e.clientY; 
	}
}
*/
function draggable( element ) {
	drag.target=element;

	element.addEventListener('mousedown', function( e ) {
console.log('** element drag start');
//		Draw_mode='Aux';
//		e.stopPropagation();
//		e.preventDefault();
		var transform = element.getAttributeNS(null, "transform");
		if(transform==null) {
			element.setAttributeNS(null,'transform', 'translate(0,0)');
			}
    		drag.offsetx = e.clientX; 
    		drag.offsety = e.clientY; 
//console.log('trans_matrix=',element.transform.baseVal[0].matrix);
		drag.isMouseDown = true;
		return false;
	});
}

<!-- DB登録済のImage選択用のポップアップウィンドウ作成 Image_DB  -->
//   $("#image_db").on("click", function(){
function db_image(){
console.log('***image_db');
// db_serv/get_mylist/を使うことでuploadした日付け順（最新日付け）のdownloadが出来る
//	My_editorwind=window.open('/db_serv/image_down/', null, 'top=100,left=200,width=400,height=500');
	My_editorwind=window.open('/db_serv/get_mylist/', null, 'top=100,left=200,width=400,height=500');

	if( My_editorwind ) {
console.log('open My_editorwind');
		}
	else {
alert('Cloud not open window！');
		  My_editorwind.close();
		}
}

//My_editorwindがclose後に呼ばれる
function after_close_pop(param) {
console.log('***Return from My_editorwind param=',param);
	if(param=='error'){
		alert('image not selected');
		return
		}
	if(My_editorwind) My_editorwind.close();
	image_first_set(param);
}

function createhttprequest(){
	var request=null;

	if("XMLHttpRequest" in window){
		request= new XMLHttpRequest();
		}
	else if("ActiveXObject" in window){
		try{
		request=new ActiveXobject("Msxml2.XMLHTTP");
			}catch(e){
				try{
				request=new ActiveXObject("Microsoft.XMLHTTP");
					}catch(e){}
				}
		}
	return request;
	}

var html_responseText;

function sorceget(){
	html_responseText='';
	if (request.readyState == 4 && request.status == 200){
//		document.form1.sorce.value=request.responseText;
//console.log(request.responseText);
		html_responseText=request.responseText;
		}
	else {
alert('request Error');
		}
	}

function requestsource(url){
	request=createhttprequest();
	request.open("GET",url,true);
	request.onreadystatechange=sorceget();
	request.send(null);
	}

function import_mode(){

    switch (Imp.selectedIndex){
      case 0:               
		break;
      case 1:               
console.log('from Net selected');
    var newNode =document.createElement('a');
    var user = window.prompt("link先を入力してください", "");
console.log(user);
	requestsource(user);
console.log('got_html=',html_responseText);

//    newNode.href = user;
//    newNode.innerHTML = sel.toString();   //tag部分に<>を含むと変更出来ない。
		break;
      case 2:               
console.log('from File selected');
		document.getElementById("svgfile").click();
		//read_svg_file();
		break;
      case 3:               
console.log('from .html selected');
		document.getElementById("htmlfile").click();
/*
	$(function(){
	  $("#wClone").load("header.html");
	});
*/
		break;
      case 4:               
console.log('from me selected');
	len=first_container.childNodes.length;
console.log('child_len=',len,first_container);
	var dlist=first_container.querySelectorAll('svg');
console.log('svg tag numbers=',dlist.length);
	dlist.forEach(function (element) {
		element.setAttribute('style','display;block');
console.log(element);
		});
		break;
	}
   }

var temp_snap_flag=0;

function Utility(){

    switch (Util.selectedIndex){
      case 0:               
		break;
      case 1:               
console.log('fix called');
//Drag elemをCopyする
    		document.getElementById("fig_copy").click();
		temp_fixed(Drag_elem.copy)
		Drag_elem.copy='';
		document.getElementById("fig_sel_end").click();
		break;
      case 2:
console.log('snap fix set');
		temp_snap_flag=1;
		break;
      case 3:               
console.log('from basic selected');
	if(under_con=='no') {
		alert('basic is under construction');
		return;
		}
		document.getElementById("basic_fig").click();
		break;
      case 4:
console.log('from basic1 selected');
		alert('baisc1 is under construction');
		break;
      case 5:
console.log('from basic2 selected');
		alert('baisc2 is under construction');
		break;
      case 6:
console.log('Mail to selected');
	if(under_con=='no') {
		alert('Mail_To is under construction');
		return;
		}
		mail_to();
		break;
	}
   }             

</script>
<!-- //
//Context menuに関する部分
//    -->
  <div id="contextmenu_a">
    <ul>
      <li onClick="cont_a_menu1()"  class="contex">再描画</li>
      <li onClick="cont_a_menu2()"  class="contex">group化</li>
      <li onClick="cont_a_menu3()"  class="contex">削除</li>
    </ul>
  </div>
  <div id="contextmenu_b">
    <ul>
      <li onClick="cont_b_menu1()"  class="contex">再描画</li>
      <li onClick="cont_b_menu2()"  class="contex">paste</li>
      <li onClick="cont_b_menu3()"  class="contex">Copy</li>
      <li onClick="cont_b_menu4()"  class="contex">Animation</li>
    </ul>
  </div>
  <div id="contextmenu_c">
    <ul>
      <li onClick="cont_c_menu1()"  class="contex">from local</li>
      <li onClick="cont_c_menu2()"  class="contex">from My_Note</li>
    </ul>
  </div>
  <script class="minify">
function cont_a_menu1(){
	alert('Not implement');
	document.getElementById('contextmenu_b').style.display="none";
   }
function cont_a_menu2(){
       			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
			var fig_id='g'+(Date.now()).toString();
			wgroup.setAttribute('id', fig_id);
			wgroup.setAttribute('fig', 'group');
			var g_temp=drag.target.appendChild(wgroup);
			var error=plane_simple_fig(g_temp,drag.target,drag.group);
			if(error==0) {
				for(let i=0;i<drag.group.length;i++) {
					drag.target.removeChild(drag.group[i]);
					}
				}
			else {
				drag.target.removeChild(g_temp);
				}
			drag.target=null;
			drag.group=null;
			Svg_mode=="";
		        document.getElementById('contextmenu_a').style.display="none";
   }

function cont_a_menu3(){

	for(let i=0;i<drag.group.length;i++) {
console.log('Area sel tags=',drag.group[i].temp);
		container.removeChild(drag.group[i].temp);
		}
	drag.group=null;
	Svg_mode=="";
	document.getElementById("fig_sel_end").click();
	document.getElementById('contextmenu_a').style.display="none";
   }

function cont_b_menu1(){

		var len=Drag_elem.children.length;
		for(let n=0;n<len;n++) {
			var tagn=Drag_elem.children[n];
console.log('child n=',n,tagn);
			if(tagn.nodeName=='path') {
				Object.assign(tagn.style, defaultPathStyle);
console.log('再描画');
				}
			}
		        document.getElementById('contextmenu_b').style.display="none";
   }

function cont_b_menu2(){
//	alert('Not implement');

 navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
                navigator.clipboard.readText()
                    .then(text => {
console.log('clipbaard text=',text);
                        //my code to handle paste
			elem_from_clip(text);
                    })
                    .catch(err => {
                        console.error('Failed to read clipboard contents: ', err);
                    });
		}
	   });
/*
	if(navigator.clipboard){
    		navigator.clipboard.readText()
    		.then(function(text){
			setTimeout(function(){
    				elem_from_clip(text); }, 100);
    			});
		}
*/
/*
	var pasteArea = document.getElementById("area_To");
	if(navigator.clipboard){
    		navigator.clipboard.readText()
    		.then(function(text){
    	    		pasteArea.textContent = text;
    			});
		}
console.log('pasted=',pasteArea);
*/
	document.getElementById('contextmenu_b').style.display="none";
   }

function cont_b_menu3(){
//	alert('Copy called');
console.log('copy Drag_elem=',Drag_elem);
	var group = Drag_elem.cloneNode(true);
	var fig_id='g'+(Date.now()).toString();
	group.setAttribute('id', fig_id);
	container.appendChild(group);
	del_add_fig(group);
	copyTextToClipboard(group.outerHTML);
	document.execCommand("copy");
	container.removeChild(group);
/*
	var textarea = document.getElementById("area_From");
	copyTextToClipboard(textarea.value);
	document.execCommand("copy");
*/
	document.getElementById('contextmenu_b').style.display="none";
   }

function cont_b_menu4(){
//	alert('Amimation called');
	figure_anime();
	document.getElementById('contextmenu_b').style.display="none";
   }

function cont_c_menu1(){
//	alert('context c1 called');
	local_image();
	document.getElementById('contextmenu_c').style.display="none";
	return;
   }
function cont_c_menu2(){
//	alert('context c2 called');
	db_image();
	document.getElementById('contextmenu_c').style.display="none";
	return;
   }

function elem_from_clip(text) {
console.log('text=',text);
　　		svgText = '<svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 256px; height: 256px; opacity: 1;" xml:space="preserve">'
			  +text+'</svg>';
　　		const domParser = new DOMParser();
　　		const parsedSVGDoc = domParser.parseFromString(svgText, 'image/svg+xml');
　　		const parsedSVG = parsedSVGDoc.childNodes[0];
console.log('length=',parsedSVG.children.length,parsedSVG);

    		var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    		var fig_id='g'+(Date.now()).toString();
    		group.setAttribute('id', fig_id);
    		group.setAttribute('class', 'group');
    		container.appendChild(group);

    		for (nn = 0; nn < parsedSVG.children.length; nn++) {
console.log('**nodename= ',parsedSVG.children[nn].nodeName,parsedSVG.children[nn]);
　　			group.appendChild(parsedSVG.children[nn].cloneNode(true));
			}
  　　  }

function del_add_fig(Drag_elem) {
           //SVG 補助図形の削除
		if(Drag_elem) {
//console.log('SVG　Quitモード tag= ',Drag_elem,'len=',Drag_elem.children.length);
			len=Drag_elem.children.length;
			//firstChildを残して補助用として追加した要素を削除する

			for(var k=len-1;k>0;k--){
				var tagn=Drag_elem.children[k];
//console.log('k= ',k,tagn);
				var fig=tagn.getAttribute('fig');
				if(fig=='temp') {
					Drag_elem.removeChild(tagn);
					}
				Drag_elem.setAttribute('class', 'none');
				}
		}
	}

function copyTextToClipboard(textVal){
  // テキストエリアを用意する
  var copyFrom = document.createElement("textarea");
  // テキストエリアへ値をセット
  copyFrom.textContent = textVal;
 
  // bodyタグの要素を取得
  var bodyElm = document.getElementsByTagName("body")[0];
  // 子要素にテキストエリアを配置
  bodyElm.appendChild(copyFrom);
 
  // テキストエリアの値を選択
  copyFrom.select();
  // コピーコマンド発行
  var retVal = document.execCommand('copy');
  // 追加テキストエリアを削除
  bodyElm.removeChild(copyFrom);
  // 処理結果を返却
  return retVal;
}
/*
      function menu1(){
        open( "https://www.google.com/", "_blank" ) ;
      }
      function menu2(){
        open( "https://www.yahoo.co.jp/", "_blank" ) ;
      }
      function menu3(){
        open( "https://www.amazon.co.jp/", "_blank" ) ;
      }
*/
// スクロール禁止
function no_scroll() {
    // PCでのスクロール禁止
    document.addEventListener("mousewheel", scroll_control, { passive: false });
    // スマホでのタッチ操作でのスクロール禁止
    document.addEventListener("touchmove", scroll_control, { passive: false });
　　document.body.style.overflow = "hidden";
    //var scr_bar = document.getElementById('texx');
    //scr_bar.style.overflow = "hidden";
    //scr_bar.setAttribute( 'style','overflow-y:hidden;');

}
// スクロール禁止解除
function return_scroll() {
    // PCでのスクロール禁止解除
    document.removeEventListener("mousewheel", scroll_control, { passive: false });
    // スマホでのタッチ操作でのスクロール禁止解除
    document.removeEventListener('touchmove', scroll_control, { passive: false });
    document.body.style.overflow = "auto";
    //var scr_bar = document.getElementById('texx');
    //scr_bar.style.overflow = "auto";
    //scr_bar.setAttribute( 'style','overflow-y:auto;');
}

// スクロール関連メソッド
function scroll_control(event) {
    event.preventDefault();
}
</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート）Figure Animation -->
<div class="dialog" id="fig_anime" title="Fig Anime">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	<label>fig off_X:<input type="text" id="fg_offx" value="0" style="width:60px;"></label><label>sec &nbsp;</label>
	<label>fig off_Y:<input type="text" id="fg_offy" value="0" style="width:60px;"></label><label>sec &nbsp;</label><br>
	<button class="btn" id="fig_offxy">set</button><label><br>
	<br>
   	<button class="btn" id="get_figPath">getPath</button><label> id:<input type="text" id="figPath" style="width:150px;"></label><br>
	<br>
	<label>anime時間:<input type="text" id="time_figanime" value="0" style="width:60px;"></label><label>sec &nbsp;</label>
　　　　<label>begin時間:<input type="text" id="time_figbegin" value="0" style="width:60px;"></label><label>sec &nbsp;</label><br>
	<br>
   	<button class="btn" id="set_fig_anime">OK</button>
  </div>
</div>
<script class="minify">
function figure_anime() {
console.log('***figure animation');
	var theDialog=$( '#fig_anime' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:300, width: 400,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	font.path='';
	font.old_elem=Drag_elem;
	theDialog.dialog("open");
	}

        fig_offxy.onclick = function(){
console.log('fig_pathが押されました');
//		drag.target.transform.baseVal[0].matrix.e=drag.target.transform.baseVal[0].matrix.e+e.clientX - drag.offsetx;
//		drag.target.transform.baseVal[0].matrix.f=drag.target.transform.baseVal[0].matrix.f+e.clientY - drag.offsety;
		}

        get_figPath.onclick = function(){
console.log('fig_pathが押されました');
	if(Drag_elem) {
		var tags=Drag_elem.querySelector('path');
console.log('path_tags=',tags);
		var deltag=Drag_elem.querySelector('rect');
		deltag.remove();
		if(!tags) {
			alert('not selected textPath Element');
			return;
			}
		else {
			var fig_id=tags.getAttribute('id');
console.log('old fig_id=',fig_id);
			if(!fig_id) {
				fig_id='p'+(Date.now()).toString();
				tags.setAttribute('id', fig_id);
console.log('new fig_id=',fig_id);
				}
			font.path=fig_id;
			document.getElementById('figPath').value=font.path;
console.log('path id=',font.path);
			}
		}
	else {
		alert('not selected textPath Element');
		return;
		}
	}

    $(document).on('click', '#set_fig_anime', function(){

console.log('set_fig_animeが押されました');
	var anim_durtime=$("#time_figanime").val();
	var anim_start=$("#time_figbegin").val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);
	if(!font.path) {
		alert('animation path not specify');
		return;
		}
	if(anim_durtime<=0.1) {
		alert('set animate time not right');
		return;
		}
	Drag_elem=font.old_elem;
//figureタグのidを取得する
	var fig_id='';
console.log('Drag_elem=',Drag_elem.nodeName,Drag_elem);
	if(Drag_elem.nodeName=='g') {
		fig_id=Drag_elem.getAttribute('id');
		}
	if(!fig_id) {
		alert('selected figure is not <group> or not have id.');
		return;
		}
	document.getElementById("fig_sel_end").click();

/* Figの直下に<animateMotion>タグを置く場合　この方法でも動く
	var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
	anime_node.setAttribute('xlink:href','#'+fig_id);	
	anime_node.setAttribute('repeatCount', "indefinite");
	anime_node.setAttribute('rotate', "auto");
	anime_node.setAttribute('dur', String(anim_durtime)+"s");
	anime_node.setAttribute('begin', String(anim_start)+"s");
	var mpath_node = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
	mpath_node.setAttribute('xlink:href','#'+font.path);
	anime_node.appendChild(mpath_node);
	Drag_elem.appendChild(anime_node);
*/

//useタグを作る場合
	var my_anime=document.getElementById('my_animation');
	if(!my_anime){
		my_anime = document.createElementNS('http://www.w3.org/2000/svg', 'g');
		my_anime.setAttribute('id','my_animation');
		container.appendChild(my_anime);
console.log('my_animation tag newly added');
		}
	var use_node = document.createElementNS('http://www.w3.org/2000/svg', 'use');
	use_node.setAttribute('xlink:href','#'+fig_id);
	var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
	anime_node.setAttribute('repeatCount', "indefinite");
	anime_node.setAttribute('rotate', "auto");
	anime_node.setAttribute('dur', String(anim_durtime)+"s");
	anime_node.setAttribute('begin', String(anim_start)+"s");
	var mpath_node = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
	mpath_node.setAttribute('xlink:href','#'+font.path);
	anime_node.appendChild(mpath_node);
	use_node.appendChild(anime_node);
	my_anime.appendChild(use_node);

//Dialogを強制的に消す
	$('#fig_anime').dialog("close");
	});

</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート） -->
<div class="dialog" id="image_upload" title="写真をアップロード">
        <div class="card shadow rounded">
            <div class="card-header"></div>
            <div class="card-body" style="background-color:slategrey;">
		<div class="canvas-container text-center" style="vertical-align: middle;">
		<!-- img id="preview" width="200px" height="200px" -->
		<canvas id="preview" width="200px" height="200px"></canvas -->
		</div>
	    </div>
		<!-- ファイル選択ボタン -->
		<input type="file" id="myImage" accept="image/*">
		   <!-- form id="send_image" method="post" enctype="multipart/form-data">
            		{% csrf_token %}
                     <input class="form-control btn btn-default" type="file" name="from_client_file" id="myImage" accept="image/*"><br>
                    </form -->
        	<!-- form method="post" id="send_image" enctype="multipart/form-data">
            		{% csrf_token %}
            	<button type="submit">Upload</button>
        	</form -->
            <div class="text-center">
                <button id="getURLResult" value="認識" class="btn btn-primary">確認</button>
            </div>
        </div>
</div>
<script class="minify">

//   $("#image_place").on("click", function(){
function local_image() {
console.log('***image_place');
	Draw_mode="";
	var theDialog=$( '#image_upload' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:380, width: 250,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	}

var To_formfile;
var To_formname;
const THUMBNAIL_MAX_WIDTH = 300; // 画像がヨコ長の場合、横サイズがこの値になるように縮小される
const THUMBNAIL_MAX_HEIGHT = 300; // 画像がタテ長の場合、縦サイズがこの値になるように縮小される

$('#myImage').on('change', function (e) {
    var image = new Image();
    var reader = new FileReader();
    reader.onload = function (e) {
        //$("#preview").attr('src', e.target.result);
//image縮小の為の修正挿入（はじめ）
      image.onload = function() {

        // 縮小後のサイズを計算する
console.log('onload image=',image.width, image.height);
//console.log('image=',image.name,file.name);
        var width, height;
        if(image.width > image.height){
          // ヨコ長の画像は横サイズを定数にあわせる
          var ratio = image.height/image.width;
          width = THUMBNAIL_MAX_WIDTH;
          height = THUMBNAIL_MAX_WIDTH * ratio;
        } else {
          // タテ長の画像は縦のサイズを定数にあわせる
          var ratio = image.width/image.height;
          width = THUMBNAIL_MAX_HEIGHT * ratio;
          height = THUMBNAIL_MAX_HEIGHT;
        }
console.log('new size=',width,height,' ratio=',ratio);
        // 縮小画像を描画するcanvasのサイズを上で算出した値に変更する
        var canvas = $('#preview')
                     .attr('width', width)
                     .attr('height', height);

        var ctx = canvas[0].getContext('2d');

        // canvasに既に描画されている画像があればそれを消す
        ctx.clearRect(0,0,width,height);

        // canvasに縮小画像を描画する
        ctx.drawImage(image,
          0, 0, image.width, image.height,
          0, 0, width, height
        );

        // canvasから画像をbase64として取得する
        var base64 = canvas.get(0).toDataURL('image/jpeg');
	To_formfile=createJpegFile4Base64(base64,To_formname);
console.log('base64=',base64.length);
console.log('To_formfile=',To_formfile);
      }
      image.src = e.target.result;
console.log('get image=',image.src.length);
//image縮小の為の修正挿入（おわり）
    }
    reader.readAsDataURL(e.target.files[0]);
    To_formname=e.target.files[0].name;
console.log('file=',e.target.files[0],To_formname)
});

$('#getURLResult').on('click', function(){
console.log('*** Direct to server ***');

    var fd = new FormData();
//    var filetype = e.target.files[0].type;

//console.log(To_formfile);
    fd.append('photo', To_formfile);
//    fd.append('image_data', To_formfile);
console.log('file data=',fd);

        $.ajax({
            url: "/db_serv/imageupload/",
            type: "POST",
            data: fd,
            processData: false,
            contentType: false,
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
console.log('URL=',data);
	image_first_set(data.url);
	});
});  //End function getURLResult


//引数はbase64形式の文字列と作成するファイルオブジェクトのファイル名
var createJpegFile4Base64 = function (base64, name) {
    // base64のデコード
    var bin = atob(base64.replace(/^.*,/, ''));
    // バイナリデータ化
    var buffer = new Uint8Array(bin.length);
    for (var i = 0; i < bin.length; i++) {
        buffer[i] = bin.charCodeAt(i);
    }
    // ファイルオブジェクト生成(この例ではjpegファイル)
    return new File([buffer.buffer], name, {type: "image/jpeg"});
};

function getCookie(name) {
    var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        	var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    	}
        	    }
    		}
    return cookieValue;
    }

var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

$.ajaxSetup({
    beforeSend: function (xhr, settings) {
         if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
               xhr.setRequestHeader("X-CSRFToken", csrftoken);
               }
        }
    });


html_outer.onclick= function() {
console.log('Copy Entered');

//	html_from_clipboard();
	text=get_all_text();
	document.getElementById("divsvg_00").innerHTML='';
	document.getElementById("divsvg_00").innerHTML=add_html_from_outer(text);
   }

function get_all_text() {
	var html_str=document.getElementById("divsvg_00").innerHTML;
console.log('html_str=',html_str);
	return html_str;
    }

function html_from_clipboard(){
 navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
                navigator.clipboard.readText()
                    .then(text => {
console.log('clipbaard text=',text);
		add_html_from_outer(text);
                    })
                    .catch(err => {
                        console.error('Failed to read clipboard contents: ', err);
                    });
		}
	   });
   }

function add_html_from_outer(text) {
　　	const domParser = new DOMParser();
　　	var htmldoc = domParser.parseFromString(text, 'text/html');
console.log('htmldoc=',htmldoc);
	return htmldoc.body.innerHTML;

/*
		var level=tag_trees[doc_deep_level].level;
		if(level<=0) {
		var result = window.confirm('先頭への追加となります。追加しますか？');
		if(result==true){
			doc_add_first=true;
			}
			else return;
		}
		if(doc_add_first){
			doc_edit_node.insertBefore(node, doc_edit_node.firstChild)
console.log('add First child');
			}
		else {
			$(node).insertAfter(doc_edit_node);
console.log('not first');
			}
		doc_add_first=false;

    	tag_trees=[];
    	tag_trees=get_tagStruct(node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=node;
	doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
alert('paste node');
	//set_parms();
	display_current_tag(doc_edit_node);
*/
	}
</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート）SVG文字 -->
<div class="dialog" id="text_draw" title="SVG文字">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	<label>表示文字： <br><textarea id="text_title" cols="32" rows=5 maxlength="150" style="line-height: 1em"></textarea></label>
	<br>
	<label>font-size:<input type="text" id="font_size" value="20" style="width:60px;"></label><label>  縁取-size:<input type="text" id="stroke_wd" value="0" style="width:60px;"></label>
	<label>font-color:<input type="text" id="font_color" value="" style="width:60px;"></label><label>  縁取-color:<input type="text" id="fill_color" value="" style="width:60px;"></label>
	<br>
        <label>rotate:<input type="text" id="svg_rotate" value="0" style="width:120px;"></label>
	<label>font-weight:
   	<select id="font" onchange="font_weight()" style="width:60px; height:25px;" ></p>
    		<option value="s000">normal</option>
    		<option value="s001" selected>bold</option>
    		<option value="s002">bolder</option>
		<option value="s003">lighter</option>
   	</select>
	<label>font-family:
   	<select id="font" onchange="font_family()" style="width:60px; height:25px;" ></p>
    		<option value="s000">HG丸ゴシックM-PRO</option>
    		<option value="s001" selected>游ゴシック</option>
    		<option value="s002">游明朝</option>
		<option value="s003">メイリオ</option>
   	</select>
	</label>
	<br>
	<label>anchor:
   	<select id="anchor" onchange="set_anchor()" style="width:60px; height:25px;" ></p>
    		<option value="s000">middle</option>
    		<option value="s001">start</option>
    		<option value="s002">end</option>
   	</select>
	</label>
	<br>
   	<button class="btn" id="get_textPath">getPath</button><label> id:<input type="text" id="textPath" style="width:150px;"></label><br>
	<br>
	<label>anime時間:<input type="text" id="time_anime" value="0" style="width:60px;"></label><label>sec &nbsp;</label>
　　　　<label>begin時間:<input type="text" id="time_begin" value="0" style="width:60px;"></label><label>sec &nbsp;</label><br>
	<br>
   	<button class="btn" id="set_text">OK</button><label>&nbsp; &nbsp;</label><button class="btn" id="reset_anime">Anime Clear</button>
  </div>
</div>
<script class="minify">
var font= {
	title:'',
	size:14,
	weight:'bold',
	stroke_wd:0,
	font:'sans-serif',
	rotate:0,
	anchor:'start',
	stroke:'',
	fill:'',
	path:'',
	old_elem:'',
	}

function text_dialog() {
	var theDialog=$( '#text_draw' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:450, width: 400,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
	
	font.old_elem=Drag_elem;
	var atex=decompose_text(Drag_elem);
	set_fonts(Drag_elem);
	document.getElementById('text_title').value=atex;
	document.getElementById('font_size').value=String(font.size);
	document.getElementById('stroke_wd').value=String(font.stroke_wd);
	document.getElementById('svg_rotate').value=String(font.rotate);
	document.getElementById('textPath').value=font.path;
	document.getElementById('font_color').value=font.fill;
	document.getElementById('fill_color').value=font.stroke;
	theDialog.dialog("open");
   }

   $('#text_draw').on('dialogclose', function(event) {
console.log('Dialog closed');
	});

        get_textPath.onclick = function(){
console.log('get_pathが押されました');
	if(Drag_elem) {
		var tags=Drag_elem.querySelector('path');
console.log('path_tags=',tags);
		var deltag=Drag_elem.querySelector('rect');
		deltag.remove();
		if(!tags) {
			alert('not selected textPath Element');
			return;
			}
		else {
			var fig_id=tags.getAttribute('id');
console.log('old fig_id=',fig_id);
			if(!fig_id) {
				fig_id='p'+(Date.now()).toString();
				tags.setAttribute('id', fig_id);
console.log('new fig_id=',fig_id);
				}
			font.path=fig_id;
			document.getElementById('textPath').value=font.path;
console.log('path id=',font.path);
			}
		}
	else {
		alert('not selected textPath Element');
		return;
		}
	}

    function set_fonts(tag) {
	var tagn=tag.querySelector('text');
	if(tagn) {
		font.anchor=tagn.getAttribute('text-anchor');
		font.size=tagn.getAttribute('font-size');
		font.font=tagn.getAttribute('font-family');
		font.stroke_wd=tagn.getAttribute('stroke-width');
		if(font.stroke_wd==null) font.stroke_wd="0";
		font.rotate=tagn.getAttribute('rotate');
		if(font.rotate==null) font.rotate="0";
		font.stroke=tagn.getAttribute('stroke');
		font.fill=tagn.getAttribute('fill');
		font.weight=tagn.getAttribute('font-weight');
		if(font.weight==null) font.weight='bold';
		}
	}

    function font_weight() {
	let select = document.getElementById('font');
	let defaultweight;
    	//選択したfontによって分岐
    	switch (select.selectedIndex){
      		case 0:               
			defaultweight="normal";
			break;
      		case 1:               
			defaultweight="bold";
			break;
      		case 2:               
			defaultweight="bolder";
			break;
      		case 3:               
			defaultweight="lighter";
			break;
		}
	font.weight=defaultweight;
	}

    function font_family() {
	let select = document.getElementById('font');
	let defaultfont;
    	//選択したfontによって分岐
    	switch (select.selectedIndex){
      		case 0:               
			defaultfont="Arial";
			break;
      		case 1:               
			defaultfont="游ゴシック";
			break;
      		case 2:               
			defaultfont="游明朝";
			break;
      		case 3:               
			defaultfont="Broadway";
			break;
		}
	font.font=defaultfont;
	}

    function set_anchor() {
	let select = document.getElementById('anchor');
	let anchor;
    	//選択したfontによって分岐
    	switch (select.selectedIndex){
      		case 0:               
			anchor="middle";
			break;
      		case 1:               
			anchor="start";
			break;
      		case 2:               
			anchor="end";
			break;
		}
	font.anchor=anchor;
	}

    $(document).on('click', '#set_text', function(){
console.log('set_textが押されました');
	font.title=$("#text_title").val();
	var size=$("#font_size").val();
	font.stroke_wd=$("#stroke_wd").val();
	font.rotate=$("#svg_rotate").val();
	font.fill=$("#font_color").val();
	font.stroke=$("#font_fill").val();
	font.size=Math.min(150,Math.max(5,Math.round(Number(size)*10)/10));
	Drag_elem=font.old_elem;
	// 入力内容があった場合
	if(font.title != "" && font.title != null){
		compose_text(font.title,Drag_elem);
		}
	if(font.path) {
		set_animation();
		}
//Dialogを強制的に消す
	$('#text_draw').dialog("close");
	});

//    $(document).on('click', '#set_animation', function(){
function set_animation() {
console.log('set_Animeが押されました');
	var anim_durtime=$("#time_anime").val();
	var anim_start=$("#time_begin").val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);

	var txpath=Drag_elem.querySelector('textPath');
console.log('textPath=',txpath);
	var mv_node=(txpath.parentNode).parentNode;
console.log('move_node=',mv_node);

	if(anim_durtime>0) {
		var my_anime=document.getElementById('my_animation');
		if(!my_anime){
			my_anime = document.createElementNS('http://www.w3.org/2000/svg', 'g');
			my_anime.setAttribute('id','my_animation');
			container.appendChild(my_anime);
console.log('added to container=',container);
			}
		var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
		anime_node.setAttribute('attributeName', "startOffset");
		anime_node.setAttribute('from', "0%");
		anime_node.setAttribute('to', "100%");
		anime_node.setAttribute('repeatCount', "indefinite");
		anime_node.setAttribute('calcMode', "linear");
		anime_node.setAttribute('dur', String(anim_durtime)+"s");
		anime_node.setAttribute('begin', String(anim_start)+"s");
//親要素.appendChild(追加要素)
		txpath.appendChild(anime_node);
		my_anime.appendChild(mv_node);
		}
	}

    reset_anime.onclick = function(){
console.log('Clear_animeが押されました');
	stop(true);
	//$("texx").finish();
	var anime=container.querySelectorAll('animate');
console.log(anime);
	var target=null;
	for(i=0;i<anime.length;i++) {
		if(anime[i].nodeName=='animate') {
console.log('parent=',anime[i].parentNode);
			if(anime[i].parentNode.nodeName=='textPath') {
				var txpath=anime[i].parentNode;
				target=txpath.parentNode;
				var tspan=target.querySelector('tspan');
console.log(target.parentNode);
				target.removeChild(txpath)
				target.appendChild(tspan);
				container.appendChild(target.parentNode);
				(target.parentNode).setAttribute("transform", "translate(100,100)");
				}
			}
		}
	var top_anime=document.getElementById('my_animation');
console.log('top=',top_anime);
	var anime=top_anime.querySelectorAll('use');
	for(i=0;i<anime.length;i++) {
		var fig_id=anime[i].getAttribute('xlink:href');
		fig_id=fig_id.slice( 1 ) ;
		var fig_tag=document.getElementById(fig_id);
		fig_tag.setAttribute("transform", "translate(10,10)");
		top_anime.removeChild(anime[i]);
		}
	}//End of reset anime

    function compose_text(atext,tagn) {
console.log('**compose_text atext,tagn ',atext,tagn);
	var txpath='';
	var text_tag='';
	for(i=0;i<tagn.children.length;i++) {
		if(tagn.children[i].nodeName=='text') {
			text_tag=tagn.children[i];
console.log('text_tag_0=',text_tag);
			if(text_tag.childNodes[0].nodeName=='textPath') {
				txpath=text_tag.children[0];
				text_tag=text_tag.children[0];
console.log('text_tag_1=',text_tag);
				}
			break;
			}
		}
console.log('text tag=',text_tag);
	if(text_tag) {
		clear_allchild(text_tag);
		var vtext=atext.split('<br>');
		textpathNode=txpath;
		if(font.path&&(!txpath)) {
			var textpathNode = document.createElementNS('http://www.w3.org/2000/svg', 'textPath');
			textpathNode.setAttributeNS(null,'href', '#'+font.path);
			textpathNode.setAttributeNS(null,'startOffset', '10%');		
console.log(textpathNode);
//			my_anime.appendChild(textpathNode);
		}

console.log('vtext=',vtext);
		var setsz=Math.min(80,Math.max(5,Math.round(Number(font.size)*12)/10));

		for (nn = 0; nn < vtext.length ; nn++) {
			if(vtext[nn]!=''){
				var newNode = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
				newNode.innerHTML =  vtext[nn];
console.log('text_node=',newNode);
				if(font.path) {
					newNode.setAttributeNS(null,'x', '0');
					newNode.setAttributeNS(null,'y', '0');		
					textpathNode.appendChild(newNode);
					}
				else {
					newNode.setAttributeNS(null,'x', '20');
					var yp=String(setsz+setsz*nn);
					newNode.setAttributeNS(null,'y', yp);		
    					text_tag.appendChild(newNode);
					}
				}
			}
	if(font.path) {
		text_tag.appendChild(textpathNode);
		}
		text_tag.setAttribute('font-size',font.size);
		if(font.font) {
			text_tag.setAttribute('font-family',font.font);
			}
		if(font.anchor) {
			text_tag.setAttribute('text-anchor',font.anchor);
			}
		if(font.weight) {
			text_tag.setAttribute('font-weight',font.weight);
			}
console.log('fill color default=',defaultCharStyle.fill,'font.fill=',font.fill);
		text_tag.setAttribute('fill',defaultCharStyle.fill);
//		text_tag.setAttribute('fill',defaultPathStyle.fill);
		if(font.fill) {
			text_tag.setAttribute('fill',font.fill);
			}
var att=text_tag.getAttribute('fill');
console.log('setted fill=',att);
//		text_tag.setAttribute('stroke',defaultCharStyle.stroke);
		text_tag.setAttribute('stroke',defaultPathStyle.stroke);
		if(font.stroke) {
			text_tag.setAttribute('stroke',font.stroke);
			}
		if(font.stroke_wd) {
			text_tag.setAttribute('stroke-width',String(font.stroke_wd));
			}
		if(font.rotate) {
			text_tag.setAttribute('rotate',String(font.rotate));
			}
		text_tag.setAttribute('paint-order','stroke');
		text_tag.setAttribute('stroke-linejoin','round');
		}
	if(font.path) {
		let oya = text_tag.parentNode; // 親要素を取得
		oya.setAttribute("transform", "");
		var rect=Drag_elem.querySelector('rect');
		if(rect) {
			rect.remove();
			}
//console.log(oya.transform);
		}
   	}

    function decompose_text(tagn) {
	var text_tag='';
	var atext='';
	for(i=0;i<tagn.children.length;i++) {
		if(tagn.children[i].nodeName=='text') {
			text_tag=tagn.children[i];
			if(text_tag.childNodes[0].nodeName=='textPath') {
				font.path=text_tag.childNodes[0].getAttribute('href');
				font.path=font.path.slice( 1 ) ;
				text_tag=text_tag.children[0];
				$("#textPath").value=font.path;
console.log('text_tag=',text_tag,' path=',font.path);
				}
			break;
			}
		}
	if(text_tag) {
		for (nn = 0; nn < text_tag.children.length ; nn++) {
			var tx=text_tag.children[nn].innerHTML;
			if(tx!='') {
				atext=atext+tx+'<br>';
				}

			}
		}
	return atext;
   }

</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート）順次選択用 -->
<div class="dialog" id="select_next" title="順次選択">
  <!-- div class="dialog-content" -->
	<p id="select_next_val" val=""></p>
	<br>
   	<button class="btn" id="select_next_ok">OK</button><label>&nbsp;　　&nbsp;</label><button class="btn" id="select_next_back">Back</button><label>&nbsp;　　&nbsp;</label><button class="btn" id="select_next_next">Next</button><br>
  <!-- /div -->
</div>
<script class="minify">
   var select_pointer=0;
   var select_target;
   $("#check_anime").on("click", function(){
	var theDialog=$( '#select_next' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:150, width: 400,  position: {my: "right bottom", at: "right bottom-60", of: window}});
	
	select_yes_no();

	//ダイアログを表示する
	theDialog.dialog("open");
	});

   function select_yes_no(){
console.log('Check tags Tags No.=',select_pointer);
	var tags=container.children;
	var max_num=tags.length;
	var nn=select_pointer;

	select_target=tags[nn];
console.log('target=',select_target);
	node=select_target.getAttribute('id');
	if(select_target && !(node=='my_animation')) {
		var rect_a=select_target.getBoundingClientRect();
		let w=rect_a.right-rect_a.left;
		let h=rect_a.bottom-rect_a.top;

		var pnt2=svgPoint(select_target, rect_a.left, rect_a.top);
		rect01=createRectFig(pnt2.x,pnt2.y,w,h);
		rect01.setAttribute('id', 'rect01');
		rect01.setAttribute('fig', 'temp');
		select_target.appendChild(rect01);
			
		fig=select_target.getAttribute('fig');
		var val=select_target.nodeName+' fig='+fig+' No.'+String(select_pointer);
console.log('val=',val);
		document.getElementById('select_next_val').innerHTML='選択しますか？ node='+val;
//		document.getElementById('select_next_val').val='これを選択しますか？ node='+val;
		}
	}

    select_next_next.onclick = function(){
console.log('Nextが押されました');
	var tags=container.children;
	var max_num=tags.length;

	var nn=select_pointer+1;
	if(nn<max_num) {
		node=tags[nn].getAttribute('id');
		if(node=='my_animation'){
			if((nn+1)<max_nam) nn=nn+1;
			else nn-1;
			}
		select_pointer=nn;
		}
	var rect01=select_target.querySelector('rect');
console.log('next rect=',rect01);
	if(rect01) {
		select_target.removeChild(rect01);
		}
	select_yes_no();
	}

    select_next_back.onclick = function(){
console.log('Backが押されました');
	var tags=container.children;
	var max_num=tags.length;

	var nn=select_pointer-1;
	if(nn>=0) {
		node=tags[nn].getAttribute('id');
		if(node=='my_animation') {
			if((nn-1)>=0) nn=nn-11;
			else nn+1;
			}
		select_pointer=nn;
		}
	var rect01=select_target.querySelector('rect');
console.log('back rect=',rect01);
	if(rect01) {
		select_target.removeChild(rect01);
		}
	select_yes_no();
	}

    select_next_ok.onclick = function(){
console.log('OKが押されました');
	var tags=container.children;
	var max_num=tags.length;
	
	var rect01=select_target.querySelector('rect');
console.log('ok rect=',rect01);
	if(rect01) {
		select_target.removeChild(rect01);
		}
	select_yes_no();
	Drag_elem = select_target;
	drag.target=Drag_elem;
	Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
	Draw_mode='Drag';
	drag.break=false;
	Svg_mode="Svg_drag_pending";
	draggable(Drag_elem);

//Dialogを強制的に消す
	$('#select_next').dialog("close");
	}

</script>
<!-- ポップアップウィンドウ用make_navi（テンプレート） Texx領域先頭位置に配置　-->
<div class="dialog" id="make-navi" title="Navi設置">
  <div class="dialog-content">
	<label>&nbsp;start-X:&nbsp;<input type="text" id="nav_size1" value="50" style="width:40px;"></label><label>px&nbsp;</label>
	<label>&nbsp;start-Y:&nbsp;<input type="text" id="nav_size2" value="50" style="width:40px;"></label><label>px&nbsp;</label></br>
	<label>&nbsp;width:&nbsp;<input type="text" id="nav_size3" value="100" style="width:40px;"></label><label>px&nbsp;</label>
        <label>&nbsp;Navi個数:&nbsp;<input type="text" id="nav_size4" value="0" style="width:40px;"></label><br>
	<button class="btn" id="nav_add">追加</button>&nbsp;<button class="btn" id="nav_del">削除</button></br>
    　　<p>  -------------------------------------  </p>
	<label>&nbsp;No.&nbsp;<input type="text" id="nav_param3" value="" style="width:40px;"></label>
	<label>&nbsp;&nbsp;</label><button class="btn" id="nav_next"> → </button>&nbsp;<button class="btn" id="nav_back"> ← </button><button class="btn" id="nav_set">set</button></br>
	<label>&nbsp;Title:&nbsp;<input type="text" id="nav_param4" value="Google" style="width:100px;"></label></br>
	<label>&nbsp;href:&nbsp;<input type="text" id="nav_param5" value="http://abc" style="width:200px;"></label></br>
	</br>
	<button class="btn" id="make_navigation">Set Navi</button></br>
  </div>
</div>
<script class="minify">
   var nav_pointer=0;
   $("#set_navi").on("click", function(){
	Editmode="Edit";
	Draw_mode='';
	var theDialog=$( '#make-navi' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:340, width: 360,  position: {my: "right bottom", at: "right bottom", of: window}} );
	set_navnow();
	//ダイアログを表示する
	theDialog.dialog("open");
	});

  function set_navnow() {
/*
	var hd=document.querySelector('#navheader');
console.log('header=',hd);
	if(hd) {
		var sty=hd.getAttribute('style');
		var elem=sty.split(';');
		var value=elem[1].split(':');
console.log('style=',sty,'height=',value[1]);
		var h=value[1].slice(0,-2);
		document.getElementById('nav_param1').value=String(h);
//		first_container.removeChild(hd);
		}
*/
	var nv=document.querySelector('#navheader');
	if(nv) {
		var nv_a=nv.querySelectorAll('a');
console.log('a tag=',nv_a);
		nav_links=[];
		var len=nv_a.length;
		for(var i=0;i<len;i++){
			let ta = {title:"google", link:"https://www.google.com/"};
			nav_links.push(ta);
    			nav_links[i].title=nv_a[i].children[0].innerHTML
			nav_links[i].link=nv_a[i].href;
			}
		document.getElementById('nav_size4').value=String(len);
console.log('nav=',nav_links);
		}
    }

    make_navigation.onclick = function(){
console.log("***Make navigation start");
	var hd=document.querySelector('#navheader');
	if(hd) {
		first_container.removeChild(hd);
		}
/*
	var nv=document.querySelector('div.navheader');
	if(nv) {
		first_container.removeChild(nv);
		}
*/
	var left=Number($("#nav_size1").val());
	var top=Number($("#nav_size2").val());
	var width=Number($("#nav_size3").val());
	set_header(left,top,width);
//		set_links(left,top);
	}

  function set_header(left,top,width) {
	var len=nav_links.length;
	if(len>0) {

		//var nv_hd= document.createElement('div');
		//nv_hd.setAttribute('class','navheader');
		//nv_hd.setAttribute('id', 'header');
		//$(nv_hd).insertAfter('#svg_00');
		//var str= ' left:'+String(left)+'px;'+' top:'+String(top)+'px;';
		//nv_hd.setAttribute('style', style=str);

    		var pNode = document.createElement('p');
		pNode.setAttribute('id', 'navheader');
		$(pNode).insertAfter('#svg_00');

    		var newNode = document.createElement('span');
    		newNode.setAttribute('style','font-size:'+' 14px;');
    		newNode.innerHTML =  '<br><br>&nbsp; &nbsp;';
    		pNode.appendChild(newNode);

		for(var i=0;i<len;i++){
//<a>タグを作成場合
    			var newNode =document.createElement('a');
//Titleはbutton側に書く    			newNode.innerHTML = nav_links[i].title;
			newNode.href= nav_links[i].link;
			//newNode.setAttribute('onclick', "location.href="+" '"+nav_links[i].link+"' ");
			//newNode.setAttribute('class', 'my_button');
			newNode.setAttribute('target', '_blank');
//			var str= ' left:'+String(left)+'px;'+' top:'+String(top)+'px;';
//			newNode.setAttribute('style', style=str);
			pNode.appendChild(newNode);

//<button>タグの場合
    			var btnNode =document.createElement('button');
    			btnNode.innerHTML = nav_links[i].title;
			//btnNode.setAttribute('onclick', "location.href="+" '"+nav_links[i].link+"' ");
			btnNode.setAttribute('class', 'my_button');
			var str='';
			if(width>0) {
				str= str+' width:'+String(width)+'px;';
				}
			if(i==0) {
				str= str+' margin-left:'+String(left)+'px;';
				}
			btnNode.setAttribute('style', str);
			newNode.appendChild(btnNode);
			}
		}
/*
		var hd=document.querySelector('div#header');
console.log('nav=',nv_hd,'header=',hd)
		if(hd){
			$(nv_hd).insertAfter(hd);
			}
		else {
			$(nv_hd).insertAfter('#svg_00');
			}
*/
	change_css(Editmode);
    }

  $("#nav_add").on("click", function(){
	let ta = {title:"google", link:"https://www.google.com/"};
	nav_links.push(ta);
	var len=nav_links.length;
	document.getElementById('nav_size4').value=String(len);
console.log(nav_links);
    });

  $("#nav_del").on("click", function(){
    	nav_links.pop();
	var len=nav_links.length;
	document.getElementById('nav_size4').value=String(len);
console.log(nav_links);
    });

  $("#nav_next").on("click", function(){
	len=nav_links.length;
	if(nav_pointer<len) {
		nav_pointer=nav_pointer+1;
		}
	document.getElementById('nav_param3').value=String(nav_pointer);
	document.getElementById('nav_param4').value=nav_links[nav_pointer-1].title;
	document.getElementById('nav_param5').value=nav_links[nav_pointer-1].link;
    });

  $("#nav_back").on("click", function(){
	len=nav_links.length;
	if(nav_pointer>1) {
		nav_pointer=nav_pointer-1;
		}
	document.getElementById('nav_param3').value=String(nav_pointer);
	document.getElementById('nav_param4').value=nav_links[nav_pointer-1].title;
	document.getElementById('nav_param5').value=nav_links[nav_pointer-1].link;
    });

  $("#nav_set").on("click", function(){
	var nv=document.querySelector('#navheader');
	var nv_a=nv.querySelectorAll('a');
console.log('a tag=',nv_a);
	nav_links[nav_pointer-1].title=document.getElementById('nav_param4').value;
	nv_a[nav_pointer-1].children[0].innerHTML=nav_links[nav_pointer-1].title;
	nav_links[nav_pointer-1].link=document.getElementById('nav_param5').value;
	nv_a[nav_pointer-1].href= nav_links[nav_pointer-1].link;
    });

</script>
<!-- ポップアップウィンドウ用 design html（テンプレート） -->
<div class="dialog" id="my_html_design" title="Html_Design">
  <div class="dialog-content">
	<label>Tag:&nbsp;<input type="text" id="hm_tag" value="" style="width:60px;" ></label><label>&nbsp;Level:&nbsp;<input type="text" id="hm_level" value="" style="width:30px;"></label><label>&nbsp;fig:&nbsp;<input type="text" id="hm_fig" value="" style="width:50px;">&nbsp;</label></br>
        <label>&nbsp;　&nbsp;</label><button class="btn" id="copy_tag">copy</button><label>&nbsp;　&nbsp;</label><button class="btn" id="paste_tag">paste</button><label>&nbsp;　&nbsp;</label><button class="btn" id="del_tag">削除</button></br>
	<p>  -------------------------------------------------  </p>
	<label>挿入tag:</label>
    	  <select id="sel_add_tag" onchange="tag_change()" style="width:60px;">
        	<option value="none"  selected="selected"></option>
        	<option value="div">大枠</option>
        	<option value="flex">横小枠</option>
        	<option value="colm_flex">縦小枠</option>
        	<option value="ul">箇条書</option>
        	<option value="ol">数列挙</option>
        	<option value="title">見出し</option>
        	<option value="photo">絵写真</option>
        	<option value="p_tag">段落</option>
        	<option value="span">強調</option>
        	<option value="header">大表題</option>
        	<option value="nav_menu">メニュー</option>
        	<option value="button">ボタン</option>
        	<option value="link">リンク</option>
		<option value="I_con">Icon</option>
    	  </select><!-- label id='Label_01'>&nbsp;分割数:&nbsp;<input type="text" id="hm_numb" value="3" style="width:30px;"></label><label>&nbsp;左右margin:<input type="text" id="lr_margin" value="0px 0px" style="width:50px;"></label><br -->
		<label id='Label_01'></label><br>
		<!-- label id='Label_02' style="display:none;">
			<label>justyfy:<select id="flex_just" style="width:80px;" >
    				<option value="s000"></option>
    				<option value="s001">center</option>
    				<option value="s002"  selected="selected">around</option>
				<option value="s003">between</option>
    				<option value="s004">start</option>
    				<option value="s005">end</option>
				</select></label>
			<label>align:<select id="flex_align" style="width:80px;" >
    				<option value="s000"></option>
    				<option value="s001">stretch</option>
    				<option value="s002"  selected="selected">start</option>
				<option value="s003">end</option>
    				<option value="s004">center</option>
				</select></label>
				</label>
			</label><br -->
	  <label>&nbsp;&nbsp;</label><button class="btn" id="tag_up"> ↑ </button>&nbsp;<button class="btn" id="tag_back"> ← </btn>&nbsp;<button class="btn" id="tag_next"> → </button>&nbsp;<button class="btn" id="tag_down"> ↓ </button>  <button class="btn" id="add_tag">追加</button><label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label><button class="btn" onclick="typ_next()">style画面変更</button><br>
    　　<p>  ----------------style画面-----------------------</p>
        <div class="submenu">
           <div id="submenu01" style="display:block;">
		<label>&nbsp;margin-L:&nbsp;<input type="text" id="hm_mar1" value="" style="width:40px;"></label><label>&nbsp;margin-R:&nbsp;<input type="text" id="hm_mar2" value="" style="width:40px;"></label>
		<label>&nbsp;indent:&nbsp;<input type="text" id="hm_parm7" value="" style="width:40px;"></label><br>
		<label>&nbsp;margin:&nbsp;<input type="text" id="hm_parm3" value="" style="width:60px;"></label><label>&nbsp;padding:&nbsp;<input type="text" id="hm_parm4" value="" style="width:60px;"></label><br>
		<label>&nbsp;color:&nbsp;<input type="text" id="hm_parm1" value="" style="width:60px;"></label><label>&nbsp;back-color:&nbsp;<input type="text" id="hm_parm2" value="" style="width:60px;"></label><br>
		<label>&nbsp;width:&nbsp;<input type="text" id="hm_parm8" value="" style="width:60px;"></label><label>&nbsp;height:&nbsp;<input type="text" id="hm_parm9" value="" style="width:60px;"></label><br>
		<label>&nbsp;border:&nbsp;<input type="text" id="hm_parm5" value="" style="width:150px;"></label><label>&nbsp;border-radius:&nbsp;<input type="text" id="hm_parm6" value="" style="width:40px;"></label>
		<label>&nbsp;others:&nbsp;<input type="text" id="hm_parm10" value="" style="width:220px;"><br>
	   	<button class="btn" id="submenu_01" onclick="set_hm_parms1()">Set</button></br>
	   </div>
           <div id="submenu02" style="display:none;">
		<label>&nbsp;color:&nbsp;<input type="text" id="hm_parm11" value="" style="width:60px;"></label><label>&nbsp;back-color:&nbsp;<input type="text" id="hm_parm12" value="" style="width:60px;"></label>
		<label>&nbsp;font_size:&nbsp;<input type="text" id="hm_parm13" value="" style="width:40px;"></label><br>
	 	<label>font-style:
    	  		<select id="hm_parm14" class="input">
			<option value="none" selected="selected"></option>
        		<option value="bold">bold</option>
        		<option value="italic">italic</option>
        		<option value="underline">underline</option>
    	  		</select>
  		</label>
		<label>font-family:
    	  		<select id="hm_parm15" class="input">
			<option value="none" selected="selected"></option>
        		<option value="Times New Roman">Times New Roman</option>
        		<option value="Arial">Arial</option>
        		<option value="fantasy">Fantasy</option>
        		<option value="cursive">cursive</option>
        		<option value="meirio">ヒラギノ角ゴシック</option>
        		<option value="goshick">Yu Gothic UI</option>
        		<option value="georgia">HGS創英角ﾎﾟｯﾌﾟ体</option>
    	  		</select>
  		</label>
		<label>others:&nbsp;<input type="text" id="hm_parm16" value="" style="width:220px;"><br>
		<button class="btn" id="submenu_02" onclick="set_hm_parms2()">Set</button></br>
	   </div>
           <div id="submenu03" style="display:none;">
		<label>タグ選択:<select id="tit_size" style="width:40px;" >
    		<option value="none" selected="selected"></option>
    		<option value="H1">h1</option>
    		<option value="H2">h2</option>
		<option value="H3">h3</option>
    		<option value="H4">h4</option>
    		<option value="H5">h5</option>
		<option value="H6">h6</option>
		<option value="SPAN">span</option>
		<option value="P">p</option>
		</select></label>
		<label>&nbsp;id:&nbsp;<input type="text" id="tit_id" value="" style="width:60px;"></label>
		<label>justyfy:<select id="flex_just" style="width:60px;" >
    				<option value="none"  selected="selected"></option>
    				<option value="center">center</option>
    				<option value="space-around">around</option>
				<option value="space-between">between</option>
    				<option value="flex-start">start</option>
    				<option value="flex-end">end</option>
				</select></label>
		<label>align:<select id="flex_align" style="width:60px;" >
    				<option value="none"  selected="selected"></option>
    				<option value="strech">stretch</option>
    				<option value="flex-start">start</option>
				<option value="flex-end">end</option>
    				<option value="center">center</option>
				</select></label>
				</label>
		<label>&nbsp;title:&nbsp;<input type="text" id="tit_title" value="" style="width:220px;"></label><br>
		<label>top:&nbsp;<input type="text" id="tit_mar1" value="" style="width:220px;"></label><br>
		<label>bottom:&nbsp;<input type="text" id="tit_mar2" value="" style="width:220px;"></label><br>
		<label>left:&nbsp;<input type="text" id="tit_mar3" value="" style="width:220px;"></label><br>
		<label>right:&nbsp;<input type="text" id="tit_mar4" value="" style="width:220px;"></label><br>
		<label>padding:&nbsp;<input type="text" id="tit_mar5" value="" style="width:80px;"></label><label>&nbsp;back-color:&nbsp;<input type="text" id="tit_mar0" value="" style="width:50px;"></label><br>
		<label>&nbsp;others:&nbsp;<input type="text" id="tit_mar6" value="" style="width:220px;"><br>
		<button class="btn" id="submenu_03" onclick="set_hm_parms3()" style="display:none;">Set</button></br>
	   </div>
  	   <div id="submenu04"  style="display:none;">
		<!-- label>width:<input type="text" id="im_pam1" value="100" style="width:40px;"></label><label>&nbsp;&nbsp;height:<input type="text" id="im_pam2" value="100" style="width:40px;"></label></br -->
		<label>padding:<input type="text" id="im_pam3" value="10px" style="width:180px;"></label>
		<label>&nbsp;リンク/Font:&nbsp;<input type="text" id="link_targ" value="" style="width:220px;"></label><br>
		<label>Title:<input type="text" id="im_pam5" value="" style="width:220px;"></label><br>
        	<label>Title位置 :</label>
   		<select id="im_pos" style="width:80px;" >
			<option value="none" selected></option>
    			<option value="bottom">bottom</option>
    			<option value="top">top</option>
   		</select>
		<!-- label>position pos_x:<input type="text" id="im_pam11" value="100" style="width:40px;">px</label><label>&nbsp;&nbsp;pos_y:<input type="text" id="im_pam12" value="100" style="width:40px;">px</label></br -->
        	<label>画像配置:</label>
   		<select id="im_float" style="width:80px;" >
    			<option value="none"></option>
    			<option value="left" selected>left</option>
			<option value="right">right</option>
			<option value="overflow">overflow</option>
   		</select><br>
		<label>画像alt:<input type="text" id="im_pam4" value="" style="width:220px;"></label><br>
		<label>&nbsp;others:&nbsp;<input type="text" id="im_pam6" value="" style="width:220px;"><br>
		<button class="btn" id="submenu_04" onclick="set_hm_parms4()" style="display:none;">Set</button></br>
  	   </div>
	</div>
  </div>
</div>
<script class="minify">
var my_html_design_dialog=0;
var doc_deep_level=-1;
var doc_edit_node;
var prev_doc_edit_node='';
var prev_doc_edit_style=null;
var doc_origin_node;
var doc_top_node='';
var doc_origin_level;
var tag_trees=[];
var doc_prev_parms;
var doc_add_first=false;
var default_margin_L='100px';
var default_margin_R='100px';
var typ_chng_flg=0;
var tag_change_mode=0;
var photo_type;

   $("#design_html").on("click", function(){
console.log('Enter design_html');
	if(Editmode!="Edit") {
		alert('HTML design only allowed at Edit mode');
		return;
		}
	Draw_mode='';
	var theDialog=$( '#my_html_design' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:450, width: 480,  position: {my: "right bottom", at: "right bottom", of: window}} );
	place_to_tag();
	if(doc_deep_level<0) {       //直前のplace_to_tagで選択されていない場合
		document.getElementById('hm_level').value=String(0);
		doc_edit_node=document.getElementById('divsvg_00');
		document.getElementById('hm_tag').value=doc_edit_node.nodeName;
		//document.getElementById('hm_id').value='divsvg_00'
		document.getElementById('hm_fig').value=''
alert('text not selected');
		}
	display_current_tag(doc_edit_node);   //style parm表示のcheck_attrはdisplay_current_tag中にある
	//ダイアログを表示する
	my_html_design_dialog=1;
	tag_change();
	theDialog.dialog("open");
	});

   $("#my_html_design").on('dialogclose', function(event) {
	cancel_green_line();
	my_html_design_dialog=0;
console.log('Dialog closed');
	});

    function cancel_green_line() {
	if(prev_doc_edit_style==null) prev_doc_edit_style='';
	if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
		if(prev_doc_edit_style) prev_doc_edit_node.setAttribute('style',prev_doc_edit_style);
			else prev_doc_edit_node.removeAttribute('style');
		}
	prev_doc_edit_style=null;
	}

    function display_current_tag(edit_node) {
	if(prev_doc_edit_style==null) prev_doc_edit_style='';
	if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
		if(prev_doc_edit_style) prev_doc_edit_node.setAttribute('style',prev_doc_edit_style);
			else prev_doc_edit_node.removeAttribute('style');
		}
//console.log('display_current_tag=',edit_node.nodeName);
	doc_deep_level=get_tree_level(edit_node);
console.log('deep_level=',doc_deep_level,'tag_trees=',tag_trees);
console.log('display_current_tag=',edit_node,'deep level=',doc_deep_level,'level=',tag_trees[doc_deep_level].level);
	document.getElementById('hm_level').value=String(tag_trees[doc_deep_level].level);
	document.getElementById('hm_tag').value=tag_trees[doc_deep_level].tag;
	node_id="";
	if(edit_node.nodeName=='DIV') node_id=edit_node.getAttribute('id');
	//document.getElementById('hm_id').value=node_id;
	var fig=edit_node.getAttribute('fig');
	document.getElementById('hm_fig').value=fig;
	prev_doc_edit_node='';
	hm_tag_disp(edit_node);
	if(edit_node.nodeName!='#text') {
		prev_doc_edit_node=edit_node;
		prev_doc_edit_style=edit_node.getAttribute('style');
console.log('new node =',edit_node.nodeName,'level=',tag_trees[doc_deep_level].level,'deep level=',doc_deep_level,tag_trees);
		check_attr(edit_node,prev_doc_edit_style,typ_chng_flg);
		if(tag_trees[doc_deep_level].level==0) {
			var styl='border-top: solid 4px green; background-color:#f0f8ff;'
			if(prev_doc_edit_style!=null) styl=prev_doc_edit_style+styl;
			edit_node.setAttribute('style',styl);
			}
		else {
			var styl='border-bottom: solid 4px green; background-color:#f0f8ff;';
			if(prev_doc_edit_style!=null) styl=prev_doc_edit_style+styl;
			edit_node.setAttribute('style',styl);
			}
		}
	} //End of display_current_tag

    function check_attr(node,node_style,typ_chng_flg) {
console.log('Enter to check_attr type=',typ_chng_flg);
	clear_parms();
	switch (typ_chng_flg){
      		case 1:
			check_attr1(node,node_style);
			break;
      		case 2:
			check_attr2(node,node_style);
			break;
      		case 3:
			check_attr3(node,node_style);
			break;
      		case 4:
console.log('attr4');
			check_attr4(node,node_style);
			break;
		}
	}

    function check_attr1(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr1:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
console.log(splt,splt[0],splt[1]);
					styles.push(splt);
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'margin-left':
					document.getElementById('hm_mar1').value=styles[i][1];
					break;
				case 'margin-right':
					document.getElementById('hm_mar2').value=styles[i][1];
					break;
				case 'color':
					document.getElementById('hm_parm1').value=styles[i][1];
					break;
				case 'background-color':
					document.getElementById('hm_parm2').value=styles[i][1];
					break;
				case 'margin':
					document.getElementById('hm_parm3').value=styles[i][1];
					break;
				case 'padding':
					document.getElementById('hm_parm4').value=styles[i][1];
					break;
				case 'border':
					document.getElementById('hm_parm5').value=styles[i][1];
					break;
				case 'border-radius':
					document.getElementById('hm_parm6').value=styles[i][1];
					break;
				case 'text-indent':
					document.getElementById('hm_parm7').value=styles[i][1];
					break;
				case 'width':
					document.getElementById('hm_parm8').value=styles[i][1];
					break;
				case 'height':
					document.getElementById('hm_parm9').value=styles[i][1];
					break;
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('hm_parm10').value=others;
						}
					break;
				}
			}
		}
	} //End of check_attr1

    function check_attr2(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr2:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
//console.log(splt,splt[0],splt[1]);
					styles.push(splt);
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'color':
					document.getElementById('hm_parm11').value=styles[i][1];
					break;
				case 'background-color':
					document.getElementById('hm_parm12').value=styles[i][1];
					break;
				case 'font-size':
					document.getElementById('hm_parm13').value=styles[i][1];
					break;
				case 'font-weight':
					let select1 = document.getElementById('hm_parm14');
					select1.selectedIndex=1;
					break;
				case 'font-style':
					select1 = document.getElementById('hm_parm14');
					select1.selectedIndex=2;
					break;
				case 'text-decoration':
					select1 = document.getElementById('hm_parm14');
					select1.selectedIndex=3;
					break;
				case 'font-family':
					let select2 = document.getElementById('hm_parm15');
					let kind2=styles[i][1];
					switch(kind2) {
						case "'Times New Roman'":
							select2.selectedIndex=1;
							break;
        					case "'Arial'":
							select2.selectedIndex=2;
							break;
        					case "'Fantasy'":
							select2.selectedIndex=3;
							break;
        					case "'cursive'":
							select2.selectedIndex=4;
							break;
        					case "'ヒラギノ角ゴシック'":
							select2.selectedIndex=5;
							break;
        					case "'Yu Gothic UI'":
							select2.selectedIndex=6;
							break;
        					case "'HGS創英角ﾎﾟｯﾌﾟ体'":
							select2.selectedIndex=7;
console.log('font-family=',kind2,select2.selectedIndex);
							break;
						}
console.log('font-family=',kind2,select2.selectedIndex);
					break;	
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('hm_parm16').value=others;
						}
					break;
				}
			}
		}
	} //End of check_attr2

    function check_attr3(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr3:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
//console.log(splt,splt[0],splt[1]);
					styles.push(splt);
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'background-color':
					document.getElementById('tit_mar0').value=styles[i][1];
					break;
				case 'border-top':
					document.getElementById('tit_mar1').value=styles[i][1];
					break;
				case 'border-bottom':
					document.getElementById('tit_mar2').value=styles[i][1];
					break;
				case 'border-left':
					document.getElementById('tit_mar3').value=styles[i][1];
					break;
				case 'border-right':
					document.getElementById('tit_mar4').value=styles[i][1];
					break;
				case 'padding':
					document.getElementById('tit_mar5').value=styles[i][1];
					break;
				case 'justify-content':
					let select1=document.getElementById('flex_just');
					let kind1=styles[i][1];
console.log('justify=',kind1);
					switch(kind1) {
						case "center":
							select1.selectedIndex=1;
							break;
						case "space-around":
							select1.selectedIndex=2;
							break;
						case "space-between":
							select1.selectedIndex=3;
							break;
						case "flex_start":
							select1.selectedIndex=4;
							break;
						case "flex_end":
							select1.selectedIndex=5;
							break;
						}
					break;
				case 'align-items':
					let select2 = document.getElementById('flex_align');
					let kind2=styles[i][1];
console.log('align=',kind2);
					switch(kind2) {
						case "strech":
							select2.selectedIndex=1;
							break;
						case "flex-start":
							select2.selectedIndex=2;
							break;
						case "flex-end":
							select2.selectedIndex=3;
							break;
						case "center":
							select2.selectedIndex=4;
							break;
						}
					break;								
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('tit_mar6').value=others;
						}
					break;
				
				}
			}
		}
	var nodety=node.nodeName[0];
console.log('node type=',nodety);
	if(nodety=='H') {
console.log('Enter case <H>tag');
		var options=document.getElementById('tit_size').options;
		for(k=0;k<options.length;k++) {
console.log('optin=',options[k].value,k);
			if(node.nodeName==options[k].value) {
				document.getElementById('tit_size').selectedIndex=k;
				break;
				}

			}
		}
	var tit_id=node.getAttribute('id');
console.log('tit_id=',tit_id);
	if(tit_id) {
		document.getElementById('tit_id').value=tit_id;
		}
	if(nodety=='H') {
console.log('enter tit_title=',node.innerHTML);
		document.getElementById('tit_title').value=node.innerHTML;
		}
	} //End of check_attr3

    function check_attr4(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr4:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
//console.log(splt,splt[0],splt[1]);
					styles.push(splt);
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'padding':
					document.getElementById('im_pam3').value=styles[i][1];
					break;
				case 'im_pos':
					let select1 = document.getElementById('im_pos');
					let kind1=styles[i][1];
					switch(kind1) {
						case "bottom":
							select1.selectedIndex=1;
							break;
						case "top":
							select1.selectedIndex=2;
							break;
						}
					break;
				case 'im_float':
					let select2 = document.getElementById('im_float');
					let kind2=styles[i][1];
					switch(kind2) {
						case "left":
							select2.selectedIndex=1;
							break;
						case "right":
							select2.selectedIndex=2;
							break;
						case "overflow":
							select2.selectedIndex=3;
							break;
						}
					break;						
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('im_pam6').value=others;
						}
					break;
				
				}
			}
		}
	if(node.nodeName=='A') {
console.log('Enter case <A>tag');
		document.getElementById('link_targ').value=node.href;
		document.getElementById('im_pam5').value=node.innerHTML;
		}
	if(node.nodeName=='I') {
console.log('Enter case <I>tag');
		var font_code=node.getAttribute('class');
		document.getElementById('link_targ').value=font_code;
		}
	if(node.nodeName=='IMG') {
		document.getElementById('link_targ').value=node.src;
		var alt=node.getAttribute('alt');
		document.getElementById('im_pam4').value=node.alt;
		//document.getElementById('im_pam5').value=node.caption.innerHTML;
/*
		var width=node.getAttribute('width');
		if(width) {
			width=width+'px';
			document.getElementById('im_pam1').value=width;
			}
		var height=node.getAttribute('height');
		if(height) {
			height=height+'px';
			document.getElementById('im_pam2').value=height;
			}
*/
		}	
	} //End of check_attr4

    function set_parms() {
	switch (typ_chng_flg){
      		case 1:
			set_hm_parms1();
			break;
      		case 2:
			set_hm_parms2();
			break;
      		case 3:
			set_hm_parms3();
			break;
      		case 4:
			set_hm_parms4();
			break;
		}
	}

    function set_hm_parms1() {
console.log('Set parm1');
	var parms='';
	if(document.getElementById('hm_mar1').value) {
		parms=parms+'margin-left:'+document.getElementById('hm_mar1').value+';';
		}
	if(document.getElementById('hm_mar2').value) {
		parms=parms+'margin-right:'+document.getElementById('hm_mar2').value+';';
		}
	if(document.getElementById('hm_parm1').value) {
		parms=parms+'color:'+document.getElementById('hm_parm1').value+';';
		}
	if(document.getElementById('hm_parm2').value) {
		parms=parms+'background-color:'+document.getElementById('hm_parm2').value+';';
		}
	if(document.getElementById('hm_parm3').value) {
		parms=parms+'margin:'+document.getElementById('hm_parm3').value+';';
		}
	if(document.getElementById('hm_parm4').value) {
		parms=parms+'padding:'+document.getElementById('hm_parm4').value+';';
		}
	if(document.getElementById('hm_parm5').value) {
		parms=parms+'border:'+document.getElementById('hm_parm5').value+';';
		}
	if(document.getElementById('hm_parm6').value) {
		parms=parms+'border-radius:'+document.getElementById('hm_parm6').value+';';
		}
	if(document.getElementById('hm_parm7').value) {
		parms=parms+'text-indent:'+document.getElementById('hm_parm7').value+';';
		}
	if(document.getElementById('hm_parm8').value) {
		parms=parms+'width:'+document.getElementById('hm_parm8').value+';';
		}
	if(document.getElementById('hm_parm9').value) {
		parms=parms+'height:'+document.getElementById('hm_parm9').value+';';
		}
	if(document.getElementById('hm_parm10').value) {
		parms=parms+document.getElementById('hm_parm10').value;
console.log('other parms=',document.getElementById('hm_parm10').value);
		}
	if(parms) doc_edit_node.setAttribute('style',parms);
	else doc_edit_node.removeAttribute('style');
//	doc_edit_node.setAttribute('style',parms);
	doc_prev_parms=parms;
	if(!tag_change_mode) {
		prev_doc_edit_style=parms;
		display_current_tag(doc_edit_node);
		}
	} //End og set_hm_parms1

    function set_hm_parms2() {
console.log('Set parm2');
	var parms='';
	if(document.getElementById('hm_parm11').value) {
		parms=parms+'color:'+document.getElementById('hm_parm11').value+';';
		}
	if(document.getElementById('hm_parm12').value) {
		parms=parms+'background-color:'+document.getElementById('hm_parm12').value+';';
		}
	if(document.getElementById('hm_parm13').value) {
		parms=parms+'font-size:'+document.getElementById('hm_parm13').value+';';
		}
	if(document.getElementById('hm_parm14').selectedIndex==1) {
		parms=parms+'font-weight:bold;';
		}
	if(document.getElementById('hm_parm14').selectedIndex==2) {
		parms=parms+'font-style:italic;';
		}
	if(document.getElementById('hm_parm14').selectedIndex==3) {
		parms=parms+'text-decoration:underline;';
		}
	if(document.getElementById('hm_parm15').selectedIndex>0) {
		let kind=document.getElementById('hm_parm15').selectedIndex;
		let fname;
			switch(kind) {
				case 1:
					fname='Times New Roman';
					break;
        			case 2:
					fname='Arial';
					break;
        			case 3:
					fname='Fantasy';
					break;
     				case 4:
					fname='cursive';
					break;
        			case 5:
					fname='ヒラギノ角ゴシック';
					break;
      				case 6:
					fname='Yu Gothic UI';
					break;
        			case 7:
					fname='HGS創英角ﾎﾟｯﾌﾟ体';
					break;
				}
		parms=parms+'font-family:'+"'"+fname+"';";
		}
	if(document.getElementById('hm_parm16').value) {
		parms=parms+document.getElementById('hm_parm16').value;
console.log('other parms=',document.getElementById('hm_parm16').value);
		}
	if(parms) doc_edit_node.setAttribute('style',parms);
	else doc_edit_node.removeAttribute('style');
//	doc_edit_node.setAttribute('style',parms);
	doc_prev_parms=parms;
	if(!tag_change_mode) {
		prev_doc_edit_style=parms;
		display_current_tag(doc_edit_node);
		}
	} //End og set_hm_parms2

    function set_hm_parms3() {
console.log('Set parm3');
	var parms='';
	if(document.getElementById('tit_mar0').value) {
		parms=parms+'background-color:'+document.getElementById('tit_mar0').value+';';
		}
	if(document.getElementById('tit_mar1').value) {
		parms=parms+'border-top:'+document.getElementById('tit_mar1').value+';';
		}
	if(document.getElementById('tit_mar2').value) {
		parms=parms+'border-bottom:'+document.getElementById('tit_mar2').value+';';
		}
	if(document.getElementById('tit_mar3').value) {
		parms=parms+'border-left:'+document.getElementById('tit_mar3').value+';';
		}
	if(document.getElementById('tit_mar4').value) {
		parms=parms+'border-right:'+document.getElementById('tit_mar4').value+';';
		}
	if(document.getElementById('tit_mar5').value) {
		parms=parms+'padding:'+document.getElementById('tit_mar5').value+';';
		}
	let just = document.getElementById('flex_just');
console.log('flex_just sel=',flex_just.selectedIndex);
    			switch (flex_just.selectedIndex){
      				case 0:               
					var parm1="";
					break;
      				case 1:               
					var parm1="center;";
					break;
      				case 2:               
					var parm1="space-around;";
					break;
      				case 3:               
					var parm1="space-between;";
					break;
      				case 4:               
					var parm1="flex-start;";
					break;
      				case 5:               
					var parm1="flex-end;";
					break;
				}
	if(parm1!="") parms=parms+'justify-content:'+parm1;
	let align = document.getElementById('flex_align');
console.log('flex_align sel=',flex_align.selectedIndex);
    			switch (flex_align.selectedIndex){
      				case 0:               
					var parm2="";
					break;
      				case 1:               
					var parm2="stretch;";
					break;
      				case 2:               
					var parm2="flex-start;";
					break;
      				case 3:               
					var parm2="flex-end;";
					break;
      				case 4:               
					var parm2="center;";
					break;
				}
	if(parm2!="") parms=parms+'align-items:'+parm2;

	if(document.getElementById('tit_mar6').value) {
		parms=parms+document.getElementById('tit_mar6').value;
console.log('other parms=',document.getElementById('tit_mar6').value);
		}
	if(document.getElementById('tit_title').value) {
		doc_edit_node.innerHTML=document.getElementById('tit_title').value;
		}
	if(document.getElementById('tit_id').value) {
		doc_edit_node.setAttribute('id', document.getElementById('tit_id').value);
		}
	if(document.getElementById('tit_size').value!='none') {  //nodeNameは変更出来ないので作り直す
		var H_size=document.getElementById('tit_size').value;
		if(doc_edit_node.nodeName!=H_size) {
			//見出しの新規作成
			var par_tag= document.createElement(H_size);
			//par_tag.setAttribute('class', 'title');
			par_tag.setAttribute('fig', '見出し');
			par_tag.innerHTML=document.getElementById('tit_title').value;
			$(par_tag).insertAfter(doc_edit_node);
			doc_edit_node.remove();

			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			//set_parms();
			display_current_tag(doc_edit_node);
			}
		}
	if(parms) doc_edit_node.setAttribute('style',parms);
	else doc_edit_node.removeAttribute('style');
//	doc_edit_node.setAttribute('style',parms);
	doc_prev_parms=parms;
	if(!tag_change_mode) {
		prev_doc_edit_style=parms;
		display_current_tag(doc_edit_node);
		}
	} //End og set_hm_parms3

    function set_hm_parms4() {
console.log('Set parm4');
	var parms='';
/*
	if(document.getElementById('im_pam1').value) {
		parms=parms+'width:'+document.getElementById('im_pam1').value+';';
		}
	if(document.getElementById('im_pam2').value) {
		parms=parms+'height:'+document.getElementById('im_pam2').value+';';
		}
*/
	if(document.getElementById('im_pam3').value) {
		parms=parms+'padding:'+document.getElementById('im_pam3').value+';';
		}
	if(document.getElementById('im_pam6').value) {
		parms=parms+document.getElementById('im_pam6').value;
console.log('other parms=',document.getElementById('im_pam6').value);
		}

	if(doc_edit_node.nodeName=='A'){
console.log('Enter set_parm4 <A>tag',document.getElementById('im_pam5').value,doc_edit_node.innerHTML);
		if(document.getElementById('link_targ').value) {
			doc_edit_node.href=document.getElementById('link_targ').value;
			}
		if(document.getElementById('im_pam5').value) {
			doc_edit_node.innerHTML=document.getElementById('im_pam5').value;
			}		
		}
	if(doc_edit_node.nodeName=='IMG'){
console.log('Enter set_parm4 <IMG>tag');
		if(document.getElementById('link_targ').value) {  //src
			doc_edit_node.src=document.getElementById('link_targ').value;
			}
		if(document.getElementById('im_pam4').value) {  //画像alt
			var alt=document.getElementById('im_pam4').value;
			doc_edit_node.setAttribute('alt', alt);
			}
		if(document.getElementById('im_pam5').value) {  //画像説明
			doc_edit_node.caption.innerHTML=document.getElementById('im_pam5').value;
			}		
		}
	if(doc_edit_node.nodeName=='I'){
		if(document.getElementById('link_targ').value) {
			var font_code=document.getElementById('link_targ').value;
			doc_edit_node.setAttribute('class', font_code);
console.log('node=',doc_edit_node);
			doc_edit_node.innerHTML=' ';
			}
		}
	if(parms) doc_edit_node.setAttribute('style',parms);
	else doc_edit_node.removeAttribute('style');
//	doc_edit_node.setAttribute('style',parms);
	doc_prev_parms=parms;
	if(!tag_change_mode) {
		prev_doc_edit_style=parms;
		display_current_tag(doc_edit_node);
		}
	} //End og set_hm_parms4

   function clear_parms() {
	document.getElementById('hm_mar1').value="";
	document.getElementById('hm_mar2').value="";
	document.getElementById('hm_parm1').value="";
	document.getElementById('hm_parm2').value="";
	document.getElementById('hm_parm3').value="";
	document.getElementById('hm_parm4').value="";
	document.getElementById('hm_parm5').value="";
	document.getElementById('hm_parm6').value="";
	document.getElementById('hm_parm7').value="";
	document.getElementById('hm_parm8').value="";
	document.getElementById('hm_parm9').value="";
	document.getElementById('hm_parm10').value="";


	document.getElementById('hm_parm11').value="";
	document.getElementById('hm_parm12').value="";
	document.getElementById('hm_parm13').value="";
	document.getElementById('hm_parm14').selectedIndex=0;
	document.getElementById('hm_parm15').selectedIndex=0;
	document.getElementById('hm_parm16').value="";

	document.getElementById('tit_mar0').value="";
	document.getElementById('tit_mar1').value="";
	document.getElementById('tit_mar2').value="";
	document.getElementById('tit_mar3').value="";
	document.getElementById('tit_mar4').value="";
	document.getElementById('tit_mar5').value="";
	document.getElementById('tit_mar6').value="";
	document.getElementById('tit_title').value="";
	document.getElementById('tit_id').value="";
	document.getElementById('tit_size').selectedIndex=0;
	document.getElementById('flex_just').selectedIndex=0;
	document.getElementById('flex_align').selectedIndex=0;


//	document.getElementById('im_pam1').value="";
//	document.getElementById('im_pam2').value="";
	document.getElementById('im_pam3').value="";
	document.getElementById('im_pam4').value="";
	document.getElementById('im_pam5').value="";
	document.getElementById('im_pam6').value="";
	document.getElementById('link_targ').value="";
	document.getElementById('im_pos').selectedIndex=0;
	document.getElementById('im_float').selectedIndex=0
	}

    function place_to_tag() {
console.log('Enter place_to_tag');
    if(Drag_elem) {
	doc_edit_node=Drag_elem;
	Drag_elem=null;
	}
    else {
    	const selectedText = window.getSelection().toString();
console.log(selectedText);

    	var sel = window.getSelection();
console.log('selection=',sel);
    	if(!sel.rangeCount) {
		if(doc_deep_level>=0) {
			alert('Any text selection need');
			return; //範囲選択されている箇所がない場合は何もせず終了
			}
		return;
		}
    	if(sel.focusNode.nodeName!='#text') {
//console.log('select Node=',sel.focusNode);
//		alert('selection not text',sel.focusNode.nodeName);
		return;
		}
//    	doc_edit_node = sel.focusNode;　　//2022.2.14  tagのindexOfのベース
    	var par_n = sel.focusNode.parentNode;
	doc_edit_node=par_n;     //2022.2.14  tagのindexOfのベース
console.log('sel focus=',sel.focusNode,doc_edit_node,' parent=',par_n);
	}
    doc_origin_node=doc_edit_node;
    doc_origin_level=0;
    tag_trees=[];
    tag_trees=get_tagStruct(doc_origin_node,0);
console.log('origin origin node=',doc_origin_node);

    if(tag_trees.length>0) doc_deep_level=0;
console.log('*****tag tree=',tag_trees);
    if(tag_trees[0].tag=='#text') {
	doc_edit_node=par_n;
	doc_deep_level=1;
	doc_origin_node=doc_edit_node;
	doc_origin_level=1;
	}
console.log('set origin node=',doc_origin_node);
    } //End of place_to_tag

    function check_place_bs() {
console.log('Enter check');
   if(Editmode!="Edit") return false;
    else {
    	const selectedText = window.getSelection().toString();
//console.log(selectedText);
    	var sel = window.getSelection();
//console.log('selection=',sel);
//console.log('select Node=',sel.focusNode.nodeName,'offset=',sel.focusOffset,'leng=',sel.focusNode.wholeText.length);
    	if(sel.focusNode.nodeName!='#text' || (sel.focusNode.nodeName=='#text'&& sel.focusOffset<=0)) {
//		alert('selection not text',sel.focusNode.nodeName);
		return false;
		}
	return true;
	}
    } //End of check_place

    function check_place_del() {
console.log('Enter check');
   if(Editmode!="Edit") return false;
    else {
    	const selectedText = window.getSelection().toString();
//console.log(selectedText);
    	var sel = window.getSelection();
//console.log('selection=',sel);
	var leng=sel.focusNode.wholeText.length;
//console.log('select Node=',sel.focusNode.nodeName,'offset=',sel.focusOffset,'leng=',leng);
    	if(sel.focusNode.nodeName!='#text' || (sel.focusNode.nodeName=='#text'&& sel.focusOffset>=leng)) {
//		alert('selection not text',sel.focusNode.nodeName);
		return false;
		}
	return true;
	}
    } //End of check_place

  $("#add_tag").on("click", function(){
console.log('Enter add_tag');
	var add_tag;
	//let select = document.getElementById('sel_add_tag');
	var tag_name=document.getElementById('sel_add_tag').value;
	let new_tag;
	if(doc_deep_level<0) {
		alert('Not selected text');
		return;
		}
	var level=tag_trees[doc_deep_level].level;
console.log('doc_edit_node=',doc_edit_node,'deep level=',doc_deep_level,' level=',level);
	if(level<=0) {
		var result = window.confirm('先頭への追加となります。追加しますか？');
		if(result==true){
			doc_add_first=true;
			}
			else return;
		}
    	//選択したtagによって分岐
    	switch (tag_name) {
      		case 'div':               
			add_tag="<div> 大枠   typ_chng_flg=1 //基本配置 ";
console.log('select=',add_tag);
			var par_tag= document.createElement('div');
			//var parms="height:100px;";
			//par_tag.setAttribute('style', parms);
			var chd_tag = document.createElement('p');
			chd_tag.innerHTML='DIVタグ＆Pタグを挿入しました。';
			par_tag.setAttribute('fig', '大枠');
			par_tag.setAttribute('class', 'div');
			chd_tag.setAttribute('fig', '段落');
			chd_tag.setAttribute('class', 'p');
			par_tag.appendChild(chd_tag);
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'flex':               
			add_tag="<flex>　横小枠  typ_chng_flg=3 //並び・装飾　";
console.log('select=',add_tag);
			var par_tag= document.createElement('div');
			par_tag.setAttribute('class', 'flex_box');
			par_tag.setAttribute('fig', '横小枠');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			var parm_w=document.getElementById('flex_width').value;
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
console.log('width modified');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			for(let i=0;i<hm_numb;i++) {
				var chd_tag = document.createElement('div');
				chd_tag.setAttribute('fig', '小枠');
				chd_tag.setAttribute('class', 'flex_box');
				chd_tag.innerHTML='<p>コンテンツが入ります</p>';
				if(i<leng_wd) parms_1='width:'+parm_w[i]+';';
				else parms_1='width:'+parm_w.slice(-1)[0]+';';
				var parms_1=parms_1+"border-radius:5px; border: solid 1px #008080;";
				chd_tag.setAttribute('style', parms_1);
				par_tag.appendChild(chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'colm_flex':               
			add_tag="<flex>　縦小枠　　typ_chng_flg=1;　　//基本配置　";
console.log('select=',add_tag);
			var par_tag= document.createElement('div');
			par_tag.setAttribute('class', 'colm_box');
			//par_tag.setAttribute('flex-direction', 'column');
			par_tag.setAttribute('fig', '縦小枠');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			var parm_w=document.getElementById('flex_width').value;
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(height)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
console.log('width modified');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			for(let i=0;i<hm_numb;i++) {
				var chd_tag = document.createElement('div');
				chd_tag.setAttribute('fig', '小枠');
				chd_tag.setAttribute('class', 'colm_flex');
				chd_tag.innerHTML='<p>コンテンツが入ります</p>';
				if(i<leng_wd) parms_1='height:'+parm_w[i]+';';
				else parms_1='height:'+parm_w.slice(-1)[0]+';';
				var parms_1=parms_1+"border: solid 1px #008080;";
				chd_tag.setAttribute('style', parms_1);
				par_tag.appendChild(chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'ul':               
			add_tag="<div><ul>　箇条書　typ_chng_flg=1;　　//基本配置　";
			var chd_tag = document.createElement('ul');
			chd_tag.setAttribute('class', 'ul_list');
			//chd_tag.setAttribute('style','list-style-position:inside;');
			chd_tag.setAttribute('fig', '箇条書');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var dwidth=Number(100/hm_numb*10)/10;
			for(let i=0;i<hm_numb;i++) {
				var chd_chd_tag = document.createElement('li');
				chd_chd_tag.innerHTML='text';
				chd_chd_tag.setAttribute('fig', '項目');
				chd_tag.appendChild(chd_chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(chd_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(chd_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(chd_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=chd_tag;
			doc_origin_node=chd_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'ol':               
			add_tag="<div><ol>　数列挙　typ_chng_flg=1　　//基本配置";
			var chd_tag = document.createElement('ol');
			chd_tag.setAttribute('class', 'ol_list');
			//chd_tag.setAttribute('style','list-style-position:inside;');
			chd_tag.setAttribute('fig', '数列挙');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var dwidth=Number(100/hm_numb*10)/10;
			for(let i=0;i<hm_numb;i++) {
				var chd_chd_tag = document.createElement('li');
				chd_chd_tag.innerHTML='text';
				chd_chd_tag.setAttribute('fig', '項目');
				chd_tag.appendChild(chd_chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(chd_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(chd_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(chd_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(chd_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=chd_tag;
			doc_origin_node=chd_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'title':               
			add_tag="<title>　見出し　typ_chng_flg=3：　//並び・装飾　　";
			var H_size=document.getElementById("tit_size").value;
			if(H_size=='none') {
				alert('Title size not selected');
				return;
				}
			var par_tag= document.createElement(H_size);
			par_tag.setAttribute('class', 'title');
			par_tag.setAttribute('fig', '見出し');
			if(document.getElementById('tit_title').value) {
				par_tag.innerHTML=document.getElementById('tit_title').value;
				}
console.log('edit_node=',doc_edit_node);
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'photo':                        
			add_tag="<photo>　絵写真　　typ_chng_flg=4:  //画像・リンク　";
console.log('present=',doc_edit_node,'level=',doc_deep_level,'dog_tree=',tag_trees);
			var tempnode=doc_edit_node;
			if(doc_edit_node.nodeName!='P') {
alert('指定位置が違います textを選択下さい。');
				return;
				}
			tempnode= doc_edit_node.parentNode;
			photo_type='new';
			var type=tempnode.getAttribute('class');
			if(type=='flex') photo_type='flex';
//			else {
//alert('絵写真の配置は小枠内のみです。');
//				return;
//				}

console.log('photo type=',photo_type,'tempnode=',tempnode);
			var rect=tempnode.getBoundingClientRect();
console.log('context_pos=',rect.left,rect.top);

			document.getElementById('contextmenu_c').style.left=rect.left+20+"px";
                	document.getElementById('contextmenu_c').style.top=rect.top+20+"px";
		        document.getElementById('contextmenu_c').style.display="block";
console.log('Create photo tag End');
			break;
      		case 'p_tag':                        
			add_tag="<p>　段落　　typ_chng_flg=1:  //基本配置　";
			var par_tag= document.createElement('p');
			//var parms="background-color:#edf7ff;";
			par_tag.setAttribute('fig', '段落');
			set_parms();  //defaultのstyle parmsをどのように設定するか
			par_tag.innerHTML='text';
console.log('edit_node=',doc_edit_node);
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
      		case 'span':               
			add_tag="<span>　強調　　　　typ_chng_flg=2:  //文字書式　";
    			const selectedText = window.getSelection().toString();
console.log('Enter span sel=',selectedText);

			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
  			var span = document.createElement("span");
			span.setAttribute('fig', '強調');
			span.innerHTML=selectedText;
			if(selectedText.length>0){
    				range.deleteContents();    // 範囲選択箇所を一旦削除
    				range.insertNode(span);
				}
			else {
				span.innerHTML='span';
				$(span).insertAfter(doc_edit_node);
				}

    			tag_trees=[];
    			tag_trees=get_tagStruct(span,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=span;
			doc_origin_node=span;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
		case 'button':
			add_tag="<a>　ボタン　　typ_chng_flg=4:  //画像・リンク　";
    			//const selectedText = window.getSelection().toString();
console.log('Enter button');

			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
//<a>タグを作成
    			var newNode =document.createElement('a');
			newNode.setAttribute('fig', 'ボタン');
    			range.insertNode(newNode);
			if(document.getElementById('link_targ').value) {
				newNode.href=document.getElementById('link_targ').value;
				}
			if(document.getElementById('im_pam5').value) {
				newNode.innerHTML=document.getElementById('im_pam5').value;
				}
			newNode.setAttribute('target', '_blank');
			var parms='';
			if(document.getElementById('hm_parm1').value) {
				parms=parms+'color:'+document.getElementById('hm_parm1').value+';';
				}
			if(document.getElementById('hm_parm2').value) {
				parms=parms+'background-color:'+document.getElementById('hm_parm2').value+';';
				}
			if(document.getElementById('hm_parm14').value) {
				parms=parms+'font-weight:'+document.getElementById('hm_parm14').value+';';
				}
			newNode.setAttribute('style', parms);
/*
			if(document.getElementById('tit_title').value) {
				par_tag.innerHTML=document.getElementById('tit_title').value;
				}
*/
    			tag_trees=[];
    			tag_trees=get_tagStruct(newNode,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=newNode;
			doc_origin_node=newNode;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
		case 'link':
			add_tag="<a>　link　　typ_chng_flg=4:  //画像・リンク　";
    			//const selectedText = window.getSelection().toString();
console.log('Enter button');
			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
//<a>タグを作成
    			var newNode =document.createElement('a');
			newNode.setAttribute('fig', 'リンク');
    			range.insertNode(newNode);
			if(document.getElementById('link_targ').value) {
				newNode.href=document.getElementById('link_targ').value;
				}
			if(document.getElementById('im_pam5').value) {
				newNode.innerHTML=document.getElementById('im_pam5').value;
				}
			newNode.setAttribute('target', '_blank');
    			tag_trees=[];
    			tag_trees=get_tagStruct(newNode,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=newNode;
			doc_origin_node=newNode;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
		case 'nav_menu':
			add_tag="<nav>menu <ul>+ <li humburger>  typ_chng_flg=1：//基本配置 ";
console.log('select=',add_tag);
//<nav class="my_navi" style="color:white; background-color:blue;">
			var oya_tag= document.createElement('nav');
			oya_tag.setAttribute('fig', 'メニュー');
			oya_tag.setAttribute('class', 'my_navi')
//<ul id="my_resp_menu" >
			var par_tag= document.createElement('ul');
			par_tag.setAttribute('id', 'my_resp_menu');
			par_tag.setAttribute('style','color:white;background-color:black;font-weight:bold;list-style-type:none;');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
//<li class='my_nav'><a href="home.html" >Home</a></li>
			for(let i=0;i<hm_numb;i++) {
				var chd_tag = document.createElement('li');
				chd_tag.setAttribute('class', 'my_nav');
				chd_tag.setAttribute('fig', '項目');
				chd_tag.innerHTML='<a href="https://www.google.com/">google</a>';
				par_tag.appendChild(chd_tag);
				}
//<li>のfirstChildとして次にhumburgerを追加
//    <li class="my_hamburger" id="my_nav_togl"><a href="#my_resp_menu"><i class="fa fa-bars"></i></a></li>
				var chd_tag = document.createElement('li');
				chd_tag.setAttribute('id', 'my_nav_togl');
				chd_tag.setAttribute('class', 'my_hamburger');
				chd_tag.innerHTML='<a href="#my_resp_menu"><i class="fa fa-bars"></i></a>';
				par_tag.insertBefore(chd_tag, par_tag.firstChild)
			if(doc_add_first){
				doc_edit_node.insertBefore(oya_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(oya_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			doc_add_first=false;
			oya_tag.appendChild(par_tag);
			
			tag_trees=[];
    			tag_trees=get_tagStruct(oya_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=oya_tag;
			doc_origin_node=oya_tag;
			set_parms();
			display_current_tag(doc_edit_node);
			break;
		case 'I_con':
			add_tag="<i>　Icon　　typ_chng_flg=4:  //画像・リンク　";
    			//const selectedText = window.getSelection().toString();
console.log('Enter Icon');
			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
//<i>タグを作成
    			var newNode =document.createElement('i');
			newNode.setAttribute('fig', 'Icon');
    			range.insertNode(newNode);
			if(document.getElementById('link_targ').value) {
				var font_code=document.getElementById('link_targ').value;
				}
			newNode.setAttribute('class', font_code);
    			tag_trees=[];
    			tag_trees=get_tagStruct(newNode,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=newNode;
			doc_origin_node=newNode;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			set_parms();
			display_current_tag(doc_edit_node);
			break;
		}
    });      //End of add_tag

function typ_next() {
//style画面変更ボタンでstyle画面表示を順番に変更する。
//各style画面では個別の設定ボタンで各画面のstyle属性が変更される
console.log('**Type change on but mode =',tag_change_mode);
	if(tag_change_mode) return;
	if(typ_chng_flg==0) typ_chng_flg=1;
	else typ_chng_flg+=1;
	if(typ_chng_flg>4) typ_chng_flg=1;
	typ_chng();
	check_attr(doc_edit_node,prev_doc_edit_style,typ_chng_flg);
    }

function typ_chng() {
console.log('**Type change on flag=',typ_chng_flg);
	if(typ_chng_flg==1) {		//基本配置
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='block';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='block';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='none';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='none';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='none';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='none';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='none';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='none';
		}
	if(typ_chng_flg==2) {		//文字書式
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='none';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='none';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='block';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='block';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='none';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='none';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='none';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='none';
		}
	if(typ_chng_flg==3) {		//並び・装飾
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='none';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='none';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='none';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='none';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='block';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='block';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='none';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='none';
		}
	if(typ_chng_flg==4) {		//画像・リンク
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='none';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='none';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='none';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='none';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='none';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='none';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='block';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='block';
		}
    }

   function hm_tag_disp(node) {
//display_current_tagで現表示のtagに従って表示styleのdefault値は決まる
//但し、style画面変更ボタンで表示style画面を順番に変更される。
//各style画面では個別の設定ボタンで各画面のstyle属性が変更される
	var select = document.getElementById('sel_add_tag');
	select.options[0].selected = true;
	tag_change_mode=0;
	
		typ_chng_flg=1;
		//document.getElementById("Label_01").style.display='none';
		document.getElementById("Label_01").innerHTML='';
		typ_chng();
    }

function tag_change() {
//sel_var!=0ならばtag_change_mode=n　となってstyleメニューは固定となり、tagの追加でstyle値を変更する
	let sel_var=document.getElementById('sel_add_tag').selectedIndex;
	if(sel_var==tag_change_mode) return;
	else tag_change_mode=sel_var;

	var tag_name=document.getElementById('sel_add_tag').value;
console.log('**New tag selected tag_name=',tag_name);

	document.getElementById("Label_01").innerHTML='';
	//document.getElementById("Label_02").style.display='none';
//挿入Tag用にすべてのparmsをクリアする
	clear_parms();

	    	switch (tag_name){
      		case 'none':
console.log('none');
			typ_chng_flg=1;		//基本配置
			break;
      		case 'div':
console.log('DIV');
			typ_chng_flg=1;		//基本配置
			break;
      		case 'flex':
console.log('flex');
			typ_chng_flg=3;		//並び・装飾
			document.getElementById("Label_01").innerHTML = ' 分割数:<input type="text" id="hm_numb" value="3" style="width:30px;"></label><label>&nbsp;width%:<input type="text" id="flex_width" value="" style="width:80px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
//			document.getElementById("flex_just").selectedIndex = 2;
//			document.getElementById("flex_align").selectedIndex = 4;
			document.getElementById("flex_just").value = 'space-around';
			document.getElementById("flex_align").value = 'center';
			break;
      		case 'colm_flex':
console.log('colm_flex');
			typ_chng_flg=1;		//基本配置
			document.getElementById("Label_01").innerHTML = ' 分割数:<input type="text" id="hm_numb" value="3" style="width:30px;"></label><label>&nbsp;height%:<input type="text" id="flex_width" value="" style="width:80px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			document.getElementById("flex_just").selectedIndex = 2;
			document.getElementById("flex_align").selectedIndex = 2;
			break;
      		case 'ul': 
      		case 'ol': 
console.log('ul or ol');
			typ_chng_flg=1;		//基本配置
			document.getElementById("Label_01").innerHTML = ' 項目数:<input type="text" id="hm_numb" value="3" style="width:30px;">';
			//document.getElementById('hm_mar1').value='30px';
			document.getElementById('hm_parm10').value='list-style-position:inside;';
			break;
		case 'nav_menu':
console.log('nav_menu');
			typ_chng_flg=1;		//基本配置
			document.getElementById("Label_01").innerHTML = ' 項目数:<input type="text" id="hm_numb" value="5" style="width:30px;">';
			//document.getElementById('hm_mar1').value='30px';
			//document.getElementById('hm_parm10').value='list-style-type: none;';
			document.getElementById('hm_parm1').value='white';
			document.getElementById('hm_parm2').value='blue';
			document.getElementById('link_targ').value='https://www.google.com/';
			document.getElementById('im_pam5').value='google';
			//document.getElementById('hm_parm14').value='bold';
			document.getElementById('hm_parm14').selectedIndex = 1;
			break;
      		case 'title':               
console.log('title');
			typ_chng_flg=3;		//並び・装飾
			document.getElementById("tit_size").selectedIndex = 4;
			document.getElementById('tit_mar1').value='2px double #ccc';
			document.getElementById('tit_mar2').value='4px solid #ccc';
			document.getElementById('tit_mar3').value='8px solid #ccc';
			document.getElementById('tit_mar4').value='6px double #000';
			document.getElementById('tit_mar5').value='1rem 2rem';
			break;
      		case 'photo':               
console.log('photo');
			typ_chng_flg=4;		//画像・リンク
			break;
      		case 'p_tag':               
console.log('p_tag');
			typ_chng_flg=1;		//基本配置
			break;
      		case 'span':               
console.log('span');
			typ_chng_flg=2;		//文字書式
			break;
      		case 'button': 	//リンク先、Title、width、height、padding             
console.log('button');
			typ_chng_flg=4;		//画像・リンク
			document.getElementById('link_targ').value='https://www.google.com/';
			document.getElementById('im_pam5').value='google';
			//document.getElementById('im_pam1').value='100px';
			//document.getElementById('im_pam2').value='50px';
			document.getElementById('im_pam6').value='width:100px;height:50px;color:white;background-color:black;font-weight:bold;padding:0.5em 0.5em;  border:black 1px solid; border-radius:6px;';
			//document.getElementById('hm_parm1').value='white';
			//document.getElementById('hm_parm2').value='black';
			//document.getElementById('hm_parm14').selectedIndex = 1;
			break;
      		case 'I_con': 	//リンク先、Title
console.log('Icon');
			typ_chng_flg=4;		//画像・リンク
			document.getElementById('link_targ').value='fa fa-map-marker fa-lg fa-fw';
			break;
      		case 'link': 	//リンク先、Title
console.log('link');
			typ_chng_flg=4;		//画像・リンク
			document.getElementById('link_targ').value='https://www.google.com/';
			document.getElementById('im_pam5').value='google';
			break;
/*
      		case 'nav_menu': 	//リンク先、Title
console.log('link');
			typ_chng_flg=3;		//並び・装飾
			document.getElementById("Label_01").innerHTML = ' メニュー数:<input type="text" id="hm_numb" value="5" style="width:30px;"></label><label>&nbsp;width%:<input type="text" id="flex_width" value="" style="width:80px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			document.getElementById('tit_mar6').value='text-align:center; background-color:gold; padding:15px 15px;';
			break;
*/
		}
	typ_chng();
      }  //End of tag_change

  $("#copy_tag").on("click", function(){
console.log('copy node=',doc_edit_node);
//選択中のtagをcopyする前に表示用styleから元に戻す
	if(prev_doc_edit_style==null) prev_doc_edit_style='';
	if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
		if(prev_doc_edit_style) doc_edit_node.setAttribute('style',prev_doc_edit_style);
		else doc_edit_node.removeAttribute('style');
//		doc_edit_node.setAttribute('style',prev_doc_edit_style);
		}
//先頭にTag情報を入れる
	var dumy=doc_edit_node.nodeName+'|<=>|'+doc_edit_node.outerHTML;
console.log('dumy=',dumy);
	update_sysparms(2,dumy);
alert('node copied into my cripboard');
	});

  $("#paste_tag").on("click", function(){
	var from_paste=get_common(2);
	var parms=from_paste.split('|<=>|');
console.log('paste data=',parms[0],parms[1]);

　　	const domParser = new DOMParser();
　　	var htmldoc = domParser.parseFromString(parms[1], 'text/html');
	var node = htmldoc.querySelector('html body > *');
console.log(node);
//	var node=htmlToNode(parms[1]);
//console.log(node,node.nodeName);
	//<a> <span>　の場合
	if(parms[0]=="A" || parms[0]=="SPAN") {
//alert('click insert paste position');
		var sel = window.getSelection();
  		if(!sel.rangeCount) return; 
  		var range = sel.getRangeAt(0);
    		range.insertNode(node);
		}
	else {
		var level=tag_trees[doc_deep_level].level;
		if(level<=0) {
		var result = window.confirm('先頭への追加となります。追加しますか？');
		if(result==true){
			doc_add_first=true;
			}
			else return;
		}
		if(doc_add_first){
			doc_edit_node.insertBefore(node, doc_edit_node.firstChild)
console.log('add First child');
			}
		else {
			$(node).insertAfter(doc_edit_node);
console.log('not first');
			}
		doc_add_first=false;
		}

    	tag_trees=[];
    	tag_trees=get_tagStruct(node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=node;
	doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
alert('paste node');
	//set_parms();
	display_current_tag(doc_edit_node);
	});

/**
 * HTML文字列をノードに変換
 * @param {string} htmlStr 変換するHTMLの文字列
 * @return {NodeList} 変換したHTMLのNodeListを返す
 */
var htmlToNode = function(htmlStr) {
	if (!htmlStr || typeof htmlStr !== 'string') return;

	var tmpElmt = document.createElement('div');

	// 高速処理するが対応ブラウザを考えinnerHTMLを使用
	tmpElmt.innerHTML = htmlStr; 
        //tmpElmt.insertAdjacentHTML('beforeend', htmlStr);
//console.log('node=',tmpElmt,tmpElmt.childNodes);
	return tmpElmt.childNodes;
};

  $("#del_tag").on("click", function(){
console.log('delete tag');
	if(doc_deep_level<0) {
		alert('Not selected text');
		return;
		}
	var del_tag;
	var level=tag_trees[doc_deep_level].level;
console.log('doc_edit_node=',doc_edit_node,' level=',level);
	if(level<=0) {
		alert('level=0 Tagの削除はできません。');
		return;
		}
	var par_tag1 = doc_edit_node.previousElementSibling;
	var par_tag2 = doc_edit_node.nextElementSibling;
console.log('prev & next=',par_tag1,par_tag2)
	if((par_tag1==null) && (par_tag2==null)) {
		alert("Can\'t delete first tag");
		return;
		}
	if(par_tag2) par_tag=par_tag2;
	else par_tag=par_tag1;
console.log('prev tag=',par_tag,' remove_tag=',doc_edit_node);
	var result=check_html_hist(doc_edit_node,tag_trees,level,'del');
	doc_edit_node.remove();
    	tag_trees=[];
    	tag_trees=get_tagStruct(par_tag,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=par_tag;
console.log('present tag=',doc_edit_node);
	display_current_tag(doc_edit_node);
    });


  $("#tag_back").on("click", function(){
console.log('Enter tag_back');

	var prev=doc_edit_node.previousElementSibling;
	if(prev) {
		//prev.setAttribute('style',doc_prev_parms);
		tag_trees=[];
    		tag_trees=get_tagStruct(prev,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=prev;
		display_current_tag(doc_edit_node);
		}
	else {
alert('Not exist previosSibling')
		} 
    });

  $("#tag_next").on("click", function(){
console.log('Enter tag_next');

	var next=doc_edit_node.nextElementSibling;
	if(next) {
		//next.setAttribute('style',doc_prev_parms);
		tag_trees=[];
    		tag_trees=get_tagStruct(next,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=next;
		display_current_tag(doc_edit_node);
		}
	else {
alert('Not exist nextSibling')
		} 
    });

  $("#tag_up").on("click", function(){
console.log('***Up key doc_level=',doc_deep_level,' depth=',tag_trees.length);
    if(doc_deep_level >= tag_trees.length-1) return;
    doc_deep_level=doc_deep_level+1;
//console.log('present tag=',doc_edit_node,tag_trees[doc_deep_level].tag);
    var par_n=doc_edit_node.parentElement;
console.log('parentElem=',par_n);
    if(par_n==null) {
		doc_deep_level=doc_deep_level+1;
		tag_n=tag_trees[doc_deep_level].tag
		par_n=doc_edit_node.closest(tag_n);
console.log('next_parentElem=',par_n,tag_n,' level=',doc_deep_level);
		}
    	doc_edit_node=par_n;
	display_current_tag(doc_edit_node);
    });

  $("#tag_down").on("click", function(){
	alert('Go back to Origin node');
	//doc_deep_level=0;
	doc_edit_node=doc_origin_node;
	doc_deep_level=doc_origin_level;
console.log('down to origin node=',doc_origin_node);
	display_current_tag(doc_edit_node);
    });

   function get_tagStruct(node,level) {
console.log('***Get tag_tree=',node,level);
	var node_fig="";
	var node_id=null;
	var index=0;
	var node_lv=null;
	if(node.nodeName=='DIV' || node.nodeName=='NAV') {
		node_fig=node.getAttribute('fig');
		node_id=node.getAttribute('id');
		node_lv=node.getAttribute('level');
		}
console.log('nodeName=',node.nodeName);
	if(node_lv!='0') {
		var par_n=node.parentNode;
console.log('node and parent=',node,par_n);
//現Tagが親要素の何番目の子かを取得
//var index = [].slice.call( par_n.childNodes).indexOf( node ) ;
		var collection= Array.from(par_n.children);
		var index=collection.indexOf( node);
console.log('****oya=',par_n,' node=',node,' index=',index);
		tag_trees.push({tag:node.nodeName,fig:node_fig,level:level,node:node_id,ind:index});
		get_tagStruct(par_n,level+1);
		}
	else {      //Topレベル（divsvg_xx）をlevel=0としての付け替え
		doc_top_node=node;
		tag_trees.push({tag:node.nodeName,fig:node_fig,level:level,node:node_id,ind:index});
    		for(let i=0;i<tag_trees.length;i++) {
			tag_trees[i].level=tag_trees.length-i-1;
			}
		}
	return tag_trees;
	}

   function get_tree_level(nwnode) {
	var node_id=tag_trees[tag_trees.length-1].node;
	var t_node=document.getElementById(node_id);
	var nn;
	var new_node;
	var id_na='';
console.log('***Trace tree level:top node=',t_node,' node=',nwnode);
	var deep_level;
    	for(let i=tag_trees.length-1;i>=0;i--) {
console.log('tree i=',i,tag_trees[i].tag,tag_trees[i].ind,tag_trees[i+1]);
		deep_level=i;
		nn=0;
		if(i-1>=0) nn=tag_trees[i-1].ind;
		if(t_node==nwnode) break;
		else {
			if(nn>0) {
				//id_na=t_node.getAttribute('id');
				//if(id_na=='my_resp_menu') new_node=t_node.children[nn+1];
				//else new_node=t_node.children[nn];
				new_node=t_node.children[nn];
console.log('tree i=',i,tag_trees[i],'search=',nwnode,'next=',new_node);
				}
		     	else {
				new_node=t_node.firstChild;
console.log('get firstcild=',new_node);
				}
			if(i-1>=0) deep_level=i-1;
			t_node=new_node;
			if(t_node==nwnode) break;
			}
		}
console.log('match tag=',t_node,nwnode,tag_trees[i],'deep_level=',deep_level);
	return deep_level;
	}

</script>
<!-- ポップアップウィンドウ用basic-draw（テンプレート） -->
<div class="dialog" id="basic-figure" title="Utility図及びIcon図">
  <div class="dialog-content">
   	<select id="figure_no" style="width:80px; height:25px;" ></p>
    		<option value="circle">circle</option>
    		<option value="ellipse">ellipse</option>
		<option value="ellipse">quod_line</option>
   	</select></br>
	<label>&nbsp;p1&nbsp;<input type="text" id="param1" value="50" style="width:40px;"></label>
	<label>&nbsp;p2&nbsp;<input type="text" id="param2" value="50" style="width:40px;"></label>
	<label>&nbsp;p3&nbsp;<input type="text" id="param3" value="50" style="width:40px;"></label></br>
	<label>&nbsp;p4&nbsp;<input type="text" id="param4" value="50" style="width:40px;"></label>
	<label>&nbsp;p5&nbsp;<input type="text" id="param5" value="50" style="width:40px;"></label>
	<label>&nbsp;p6&nbsp;<input type="text" id="param6" value="50" style="width:40px;"></label></br>
  	<label>Trim&nbsp;<input type="checkbox" id="Trim" value=""></label><label>&nbsp;&nbsp;R&nbsp;<input type="text" id="paramR" value="10" style="width:40px;"></label></br>
   	<label>連結&nbsp;<input type="checkbox" id="concat" value=""></label>
	<button class="btn" id="start_draw">Draw</button></br>
   	<label>&nbsp;name&nbsp;<input type="text" id="icon_name" value="name" style="width:60px;"></label>
	<button class="btn" id="draw_mesh">確認mesh</button><label>&nbsp;</label><button class="btn" id="regi_icon">登録</button>
	<label>&nbsp;sft_X&nbsp;<input type="text" id="shift_X" value="20" style="width:40px;"></label>
	<label>&nbsp;sft_Y&nbsp;<input type="text" id="shift_Y" value="20" style="width:40px;"></label>
	<label>&nbsp;rate&nbsp;<input type="text" id="red_size" value="0.25" style="width:50px;"></label>
	<label>&nbsp;連結&nbsp;<input type="checkbox" id="concat" value=""></label><button class="btn" id="shift_draw">Basic図</button><button class="btn" id="export_basic">export</button></br>
	<button class="btn" id="Bmode_on" >Mode On</button><button class="btn" id="Mesh_on" >On mesh</button>
  </div>
</div>
<script class="minify">
   $("#basic_fig").on("click", function(){
	Editmode="Svg";
	Draw_mode='';
	document.getElementById("Bmode_on").click();
	var theDialog=$( '#basic-figure' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:340, width: 360,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	});

    start_draw.onclick = function(){
console.log("***Start draw");
	if(figure_no.value=="circle") {
console.log('**enter circle');
/* Circleの場合　p1=cx(R) p2=cy(R) p3=R */
		var cx=Number($("#param1").val());
		var cy=Number($("#param2").val());
		var R=Number($("#param3").val());
console.log('cx,cy,R=',cx,cy,R);
		drawingPoints=[];
		for(var i=0;i<13;i++){
			var deg=2*Math.PI/12*i;
			var x=R*Math.cos(deg)+cx;
			var y=R*Math.sin(deg)+cy;
			drawingPoints.push({x: x,y: y});
/*
			first_point=createFirstPoint([{x:x,y:y}]);
			Object.assign(first_point.style, defaultPointStyle);
        		container.appendChild(first_point);
*/
			}
		var {group,fig_id}=make_group('path');
		var c_para="close";
		group.setAttributeNS(null,'close', c_para);
		var s_para="smooth";
		group.setAttributeNS(null,'smooth', s_para);
		var path=set_line_group(group,c_para,s_para);
		group.appendChild(path);
		drawingPoints = [];
		}
	else if(figure_no.value=="ellipse") {
console.log('**enter ellipse');
/* Ellipseの場合　p1=cx(中心x) p2=cy(中心y) p3=R(100px) p4=bcy(Rに対する短軸長の比率）　*/
		var cx=Number($("#param1").val());
		var cy=Number($("#param2").val());
		var R=Number($("#param3").val());
		var bcy=Number($("#param4").val());
console.log('cx,cy,R,bcy=',cx,cy,R,bcy);
		drawingPoints=[];
		for(var i=0;i<13;i++){
			var deg=2*Math.PI/12*i;
			var x=R*Math.cos(deg)+cx;
			var y=bcy*R*Math.sin(deg)+cy;
			drawingPoints.push({x: x,y: y});
/*
			first_point=createFirstPoint([{x:x,y:y}]);
			Object.assign(first_point.style, defaultPointStyle);
        		container.appendChild(first_point);
*/
			}
		var {group,fig_id}=make_group('path');
		var c_para="close";
		group.setAttributeNS(null,'close', c_para);
		var s_para="smooth";
		group.setAttributeNS(null,'smooth', s_para);
		var path=set_line_group(group,c_para,s_para);
		group.appendChild(path);
		drawingPoints = [];
		}
	else {

		}

	}

var g_temp=null;
var x_mesh_offset=40;
var y_mesh_offset=20;
var xy_mesh=10;
var x_last=440;
var y_last=420;
var mesh_draw=false;
var mesh_integer=true;
var icon_regist='';
    $(document).on('click', '#regi_icon', function(){
	icon_regist='regist';
	document.getElementById("draw_mesh").click();
	});
    $(document).on('click', '#draw_mesh', function(){
console.log("***Enter draw_mesh");
	var mesh_container = document.getElementById('mesh_canv');

	if(!mesh_draw){
		// div要素を生成
		var div = document.createElement('div');
		// classを追加
		div.className = 'show_icon';
		var p_area = document.createElement('p');
		p_area.textContent = "icon_show area";
		div.appendChild(p_area);
		// 生成したdiv要素を追加する
		document.getElementById('tab1').appendChild(div);
		var div_b = document.createElement('div');
		div_b.setAttribute('id', 'use_icon');
		div.appendChild(div_b);
		}
	if(mesh_draw) {
		var result = window.prompt("symbol name:", "name");
console.log('result=',result);
		if(result!=null){
			var symbol = document.createElementNS('http://www.w3.org/2000/svg', 'symbol');
			var fig_id=result;
			symbol.setAttribute('id', fig_id);
			symbol.setAttribute('viewBox', "0 0 440 440");
			symbol.setAttribute('preserveAspectRatio', "none");
			mesh_container.appendChild(symbol);
			target = container;
        			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				var fig_id2='g'+(Date.now()).toString();
				wgroup.setAttribute('id', fig_id2);
				wgroup.setAttribute('fig', 'group');
				var g_temp=container.appendChild(wgroup);
console.log('g_temp=',g_temp);
			simple_fig(g_temp,target);              //transform matrixを適用して図形simple化

			while (target.lastElementChild) {
				target.removeChild(target.lastElementChild);
				}
       			while (g_temp.lastElementChild) {
				target.append(g_temp.lastElementChild.cloneNode(true));
				g_temp.removeChild(g_temp.lastElementChild);
				}

//本システムは<g>タグ下のpath要素が基本なのでこのレベルから連結化及びSimple化を実施する

			for (k = 0; k < target.childElementCount; k++) {
				symbol.append(target.children[k].cloneNode(true));
				}

			var svg_a = document.createElementNS('http://www.w3.org/2000/svg','svg');
			svg_a.setAttribute('class', 'icon');
			var use_a=document.createElementNS('http://www.w3.org/2000/svg','use');
			use_a.setAttributeNS(null,'width', '100%');
			use_a.setAttributeNS(null,'height', '100%');
			use_a.setAttributeNS(null,'href', '#'+fig_id);
console.log('svg_a=',svg_a,'use_a=',use_a);
			svg_a.appendChild(use_a);
			document.getElementById('use_icon').appendChild(svg_a);
			}
//alert('Before regist');
			if(icon_regist=='regist'){
				document.getElementById("clear").click();
				icon_regist='';
console.log('Icon regist');
				}
		}
	else {
//最初のmeshボタンが押された場合のみmesh線を引く
        	var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
		var fig_id='mesh01';
		group.setAttribute('id', 'mesh01');
		mesh_container.appendChild(group);
console.log('***fig id= ',fig_id);
		//draw x_line
		var x0=x_mesh_offset,x1=x_last;
		var y0=y_mesh_offset;
		for ( var i = 0 ; y0+10*i <= y_last ; i++ ){
			var y=y0+10*i;
			var drawPoint=[];
			drawPoint.push({x: x0,y: y});
			drawPoint.push({x: x1,y: y});
			bezier_line=createPath(drawPoint,0);
			mod_i=i % 10;
			if(mod_i==0) {
				Object.assign(bezier_line.style, tempoPathStyle);
				}
			else {
				Object.assign(bezier_line.style, tempoPathStyle2);
				}
			group.appendChild(bezier_line);
			}
		//draw y_line
		var y0=y_mesh_offset,y1=y_last;
		var x0=x_mesh_offset;
		for ( var i = 0 ; x0+10*i <= x_last ; i++ ){
			var x=x0+10*i;
			var drawPoint=[];
			drawPoint.push({x: x,y: y0});
			drawPoint.push({x: x,y: y1});
			bezier_line=createPath(drawPoint,0);
			mod_i=i % 10;
			if(mod_i==0) {
				Object.assign(bezier_line.style, tempoPathStyle);
				}
			else {
				Object.assign(bezier_line.style, tempoPathStyle2);
				}
			group.appendChild(bezier_line);
			}
		mesh_draw=true;
		}
    });

    shift_draw.onclick = function(){
console.log("***Shift draw");
	var x_sf=Number($("#shift_X").val());
	var y_sf=Number($("#shift_Y").val());
	var rate=Number($("#red_size").val());
console.log('shift XY=',x_sf,y_sf,rate);
	target = document.getElementById('svg_00');    //only g01 is Icon target
	shift_fig(target,x_sf,y_sf,rate);

     }

    Bmode_on.onclick = function(){
	if (Draw_mode=='Basic'){
		Draw_mode='';
		document.getElementById("Bmode_on").innerText='Mode Off';
		Svg_mode="Draw"
console.log("***Basic mode changed to=",Draw_mode);
		}
	else {
		Draw_mode='Basic';
		document.getElementById("Bmode_on").innerText='Mode On';
		Svg_mode="";
console.log("***Basic mode changed to=",Draw_mode);
		}
     }

    Mesh_on.onclick = function(){
	if (mesh_integer==true){
		mesh_integer=false;
		document.getElementById("Mesh_on").innerText='Off mesh';
		}
	else {
		mesh_integer=true;
		document.getElementById("Mesh_on").innerText='On mesh';
		}
     }

    export_basic.onclick = function(){
console.log("***Enter export basic");
console.log('**container nodename= ',container.nodeName,'id= ',fig_id);
console.log('**container child length=',container.childElementCount);
	var svg_tag='';
	for (nn = 0; nn < container.childElementCount; nn++) {
		if(container.children[nn].nodeName!='defs'){
			svg_tag=svg_tag+container.children[nn].outerHTML;
			}
console.log('***list n =',nn,' length = ', svg_tag.length);
		}
//	svg_tag=svg_tag+'</svg>';

let blob = new Blob([svg_tag],{type:"svg"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'testfile.txt';
link.click();
	}

</script>
<!-- ポップアップウィンドウ用basic-draw（テンプレート） -->
<div class="dialog" id="basic-draw" title="Basic図">
  <div class="dialog-content">
	<!-- button id="oper_01" class="btn btn-outline-primary" -->
	<button id="oper_01"><svg class="icon"><use xlink:href="#Text" /></svg></button>
	<button id="oper_02"><svg class="icon"><use xlink:href="#circle" /></svg></button>
	<button id="oper_03"><svg class="icon"><use xlink:href="#smcirc" /></svg></button>
	<button id="oper_04"><svg class="icon"><use xlink:href="#ellips" /></svg></button>
	<button id="oper_05"><svg class="icon"><use xlink:href="#if" /></svg></button>
	<button id="oper_06"><svg class="icon"><use xlink:href="#rectLg" /></svg></button>
	<button id="oper_07"><svg class="icon"><use xlink:href="#rectSm" /></svg></button>
	<button id="oper_08"><svg class="icon"><use xlink:href="#rectRLg" /></svg></button>
	<button id="oper_09"><svg class="icon"><use xlink:href="#rectRSm" /></svg></button>
	<button id="oper_10"><svg class="icon"><use xlink:href="#start" /></svg></button>
	<button id="oper_11"><svg class="icon"><use xlink:href="#node" /></svg></button>
	<button id="oper_12"><svg class="icon"><use xlink:href="#input" /></svg></button>
	<button id="oper_13"><svg class="icon"><use xlink:href="#para" /></svg></button>
	<button id="oper_14"><svg class="icon"><use xlink:href="#print" /></svg></button>
	<button id="oper_15"><svg class="icon"><use xlink:href="#drum" /></svg></button>
	<div class="popwindow-content"></div></br>
	<p>    ---------共通--------</p>
	<label>倍率：x <input type="text" id="input1" value="0.5" style="width:60px;" onchange="basic_change_scale()"></label>
	<label>y <input type="text" id="input2" value="0.5" style="width:60px;" onchange="basic_change_scale()"></label>
   	<select id="place_pos" onchange="place_pos()" style="width:60px; height:25px;" ></p>
    		<option value="s000">none</option>
    		<option value="s001">left</option>
    		<option value="s002">center</option>
		<option value="s003">right</option>
   	</select>
   	<button class="btn" id="option_01">補助線</button>

  </div>
</div>
<!--button id="open-sample-dialog">ダイアログを開く</button -->
<script class="minify">
   var draw_op = {
	oper:null,
	align : 'none',
	scx:0.5,
	scy:0.5,
	posx : 0,
	posy:0,
	aux_line:null,
	aux_pos:0,
	target:null,
	fig:null,
	}

   $("#createWindow").on("click", function(){
	Editmode="Svg";
	Draw_mode="Basic";
	var theDialog=$( '#basic-draw' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:300, width: 300,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	});

   $('#basic-draw').on('dialogclose', function(event) {
	Draw_mode="";
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}	
	if(draw_op.aux_line) {
		container.removeChild(draw_op.aux_line);
		}
console.log('Dialog closed');
	});

    $(document).on('click', '#oper_01', function(){
	console.log('Oper_01が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=1;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_02', function(){
	console.log('Oper_02が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=2;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_03', function(){
	console.log('Oper_03が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=3;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_04', function(){
	console.log('Oper_04が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=4;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_05', function(){
	console.log('Oper_05が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=5;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_06', function(){
	console.log('Oper_06が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=6;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_07', function(){
	console.log('Oper_07が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=7;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_08', function(){
	console.log('Oper_08が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=8;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_09', function(){
	console.log('Oper_09が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=9;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_10', function(){
	console.log('Oper_10が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=10;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_11', function(){
	console.log('Oper_11が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=11;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_12', function(){
	console.log('Oper_12が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=12;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_13', function(){
	console.log('Oper_13が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=13;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_14', function(){
	console.log('Oper_14が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=14;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_15', function(){
	console.log('Oper_15が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=15;
	draw_basic_figure(nn);	
	});

    function draw_basic_figure(nn) {
	Draw_mode="Basic";
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}	
	const basic = document.querySelector('#basic_svg');
        draw_op.target = (basic.children[nn]).cloneNode(true);
	draw_op.target.setAttribute("transform", "translate(0,0)"+"scale(1)");
	if(nn==1) {
		draw_op.target.setAttribute("style", "display:block;");
		draw_op.fig='text';
		}
	else {
		draw_op.fig='basic';
		}
	container.append(draw_op.target);
	}

    $(document).on('click', '#option_01', function(){
	console.log('option_01が押されました');
	Draw_mode="Aux";
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;

console.log('draw_present=',this);
	const basic = document.querySelector('#basic_svg');
//	var level=0;
//	svg_list(basic,level);
console.log(draw_op.aux_line,draw_op.align);
	if(!draw_op.aux_line){
        	draw_op.aux_line = (basic.children[0]).cloneNode(true);
		container.append(draw_op.aux_line);
		var xx=draw_op.aux_line.getAttribute('x1');
		draw_op.aux_pos = xx;
console.log('xx=',xx,drag.offsetx);
		draggable(draw_op.aux_line);
console.log('aux_line draw');
		}
/*
	var xx=$("#input1").val();
	var yy=$("#input2").val();
	draw_op.scx=Math.min(5,Math.max(0.1,Math.round(Number(xx)*100)/100));
	draw_op.scy=Math.min(5,Math.max(0.1,Math.round(Number(yy)*100)/100));
	$("#input1").value=String(draw_op.scx);
	$("#input2").value=String(draw_op.scy);
*/
//	console.log('xx,yy=',draw_op.scx+'  '+draw_op.scy);
/*
	var tag_elem=[];
	tag_elem.push(dumy);
	DraggableItem.create('svg_00', tag_elem,'single');
*/
	});

    function basic_change_scale() {
	var xx=$("#input1").val();
	var yy=$("#input2").val();
	draw_op.scx=Math.min(5,Math.max(0.1,Math.round(Number(xx)*100)/100));
	draw_op.scy=Math.min(5,Math.max(0.1,Math.round(Number(yy)*100)/100));
	$("#input1").value=String(draw_op.scx);
	$("#input2").value=String(draw_op.scy);
	console.log('change scale xx,yy=',draw_op.scx+'  '+draw_op.scy);
	}

    function fig_resize(target,sx,sy) {
	switch(target.nodeName){
		case "circle":
			target.setAttribute('cx', target.attributes.cx.value*sx);
			target.setAttribute('cy', target.attributes.cy.value*sx);
			target.setAttribute('r', target.attributes.r.value*sx);
			target.setAttribute("stroke", defaultPathStyle.stroke);
			target.setAttribute("stroke-width", defaultPathStyle.strokeWidth);
			target.setAttribute("fill", defaultPathStyle.fill);
		default:
		}
//	circ1.setAttributeNS(null,'fill','red');
//	circ1.setAttributeNS(null,'stroke','black');
//	svg.appendChild(circ1);

    }

    function shift_fig(g_tag,x_sf,y_sf,rate) {  //g_tag中のsvg要素をマイナス方向に（x_shift,y_shift）ずらしてBasic図を形成する
console.log('**shift fig Node=');

console.log('child node leng=',g_tag.childElementCount);
	for (var k = 0; k < g_tag.childElementCount; k++) {
		tag=g_tag.children[k];
		if(tag.nodeName=="path") {
			var path_p=resolv_figure(tag);
console.log(path_p);
			var path_nw=shift_cord(path_p,x_sf,y_sf,rate);
console.log(path_nw);
			var new_pathd=set_phrase(tag,path_nw);
        		tag.setAttributeNS(null,'d', new_pathd);
			}
		else if(tag.nodeName=='g') {
			shift_fig(tag,x_sf,y_sf,rate);
			}
		else alert('target must be path element');
		}
	} //End function

    function simple_fig(g_temp,g_group) {  //g_group中にあるtagをg_tempにcopyしてsimple化（matrix解消）する
console.log('**simple fig Node=',g_group.nodeName,'temp Node=',g_temp.nodeName);
	if(g_group.nodeName!='g' || g_temp.nodeName!='g') {
//		console.log('cant simplify this element');
alert('cant simplify');
		return;
		}
//console.log('child node leng=',g_group.childElementCount);
	for (var k = 0; k < g_group.childElementCount; k++) {
		tag=g_group.children[k];
//console.log('child k=',k,tag);
		if(tag.nodeName=="path") {
			var target=tag.cloneNode(true);
			var path_p=resolv_figure(target);
//console.log(path_p);
			var path_nw=cord_trans(path_p,g_group);
//console.log(path_nw);
			var new_pathd=set_phrase(target,path_nw);
        		target.setAttributeNS(null,'d', new_pathd);
			Object.assign(target.style, defaultPathStyle);   //Basic図を指定のカラーで描画
			g_temp.appendChild(target);
			}
		else if(tag.nodeName=="g") {
			var target=tag.children[0].cloneNode(true);
			var path_p=resolv_figure(target);
//console.log(path_p);
			var path_nw=cord_trans(path_p,g_group);
//console.log(path_nw);
			var new_pathd=set_phrase(target,path_nw);
        		target.setAttributeNS(null,'d', new_pathd);
			g_temp.appendChild(target);			
			}
		}
	} //End function

    function copy_svgtag(to_tag,from_tag) {  //from_tag<g>中にあるtagをto_tag<g>に移し替える
console.log('copy_svgtag to_tag=',to_tag.nodeName,'from_tag=',from_tag.nodeName);
	if(from_tag.nodeName!='g') {
		console.log('cant simplify this element');
alert('cant copy');
		return;
		}

	to_tag.setAttribute("transform","translate(0,0)");
	to_tag.transform.baseVal=[];
        while (to_tag.lastElementChild) {
            	to_tag.removeChild(to_tag.lastElementChild);
		}

console.log('from_tag=',from_tag);
console.log('child node leng=',from_tag.childElementCount);
	for (var k = 0; k < from_tag.childElementCount; k++) {
		tag=from_tag.children[k];
console.log('child k=',k,tag);
		to_tag.appendChild(tag);
		}
console.log('to_tag=',to_tag);
	} //End function


    function plane_simple_fig(g_temp,parent,g_group) {  //g_group中にあるtagをg_tempにcopyしてsimple化（matrix解消）する
	len=g_group.length;
console.log('**g_group len=',len,'g_group=',g_group);
	for(let k=0;k<len;k++) {
		fig=g_group[k].getAttributeNS(null,'fig');
console.log('*****fig type=',fig);
//fig='group'下の最下位には<path>タグでfigが定義されていない場合の扱い注意
		error=0;
		if(fig=="group") {
			sublen=g_group[k].childElementCount;
			for(let n=0;n<sublen;n++) {
				sub=g_group[k].children[n];
				if(sub.nodeName=="g") {
					plane_simple_fig(g_temp,g_group[k],sub);
					}
				else if(sub.nodeName=="path"){
					var target=sub.cloneNode(true);
					var path_p=resolv_figure(target);
console.log(path_p);
					var path_nw=cord_trans(path_p,g_group[k]);
console.log(path_nw);
					var new_pathd=set_phrase(target,path_nw);
        				target.setAttributeNS(null,'d', new_pathd);
					g_temp.appendChild(target);
					}
				else {
					error=100;
					alert('cant simplyfy elements');
					return error;
					}
				}
			}
		else if(fig=="text") {
			var target=g_group[k].cloneNode(true);
			g_temp.appendChild(target);
			}
		else {
			simple_fig(g_temp,g_group[k]);
			}
		}
		return error;
     } //End function plane_simple_fig

function shift_cord(path_p,x_sf,y_sf,rate) {

console.log('Points=',path_p);
	nw_path=[];
	for ( var i = 0;  i < path_p.length ; i++ ){
		var pt=path_p[i];
		pt.x=(pt.x-x_sf)*rate;
		pt.y=(pt.y-y_sf)*rate;
		nw_path.push({x:pt.x,y:pt.y});
		}
	return nw_path;
	} //End of function

function cord_trans(path_p,group) {

console.log('Points=',path_p);
	var len=group.transform.baseVal.numberOfItems;
	nw_path=path_p;
console.log('matrix len=',len);
//	for( k=0 ; k<len ; k++) {
	for( k=len-1 ; k>=0 ; k--) {
		nw_path=[];
		for ( var i = 0;  i < path_p.length ; i++ ){
			var pt=path_p[i];
			mat=group.transform.baseVal[k].matrix;
//console.log('matric=',mat);
			var pnx=mat.a*pt.x+mat.c*pt.y+mat.e;
			var pny=mat.b*pt.x+mat.d*pt.y+mat.f;
			pt.x=pnx;
			pt.y=pny;
			nw_path.push({x:pt.x,y:pt.y});
			}
		path_p=nw_path;
		}
	return nw_path;
	} //End of function

    function set_phrase(tag,path) {
	attr_char=tag.getAttribute("d"); 
console.log('**set phrase attr= ',attr_char);
	var replaced = attr_char.replace(/-/g, ',-');
//	var replace2 = replaced.split(/M|T|Q|q|S|s|C|c|L|l|Z/g);
	var replace3 = replaced.split(/(?=[MTQqSsCcLlZ])/);
		
	var result='';
	var kk=0;
	for (i=0 ; i<replace3.length ; i++) {
		var cat=replace3[i].replace(/,/g,' ');
		var sub = cat.split(' ');
console.log('leng=',sub.length,'sub=',sub);
		var leng=0;
		for(j=0; j<sub.length ; j++) {
			if(sub[j]!="") leng+=1;
			}
console.log('leng=',leng);
		var res=cat.slice(0,1);
		if(leng>=2) {
			for (k=0 ; k<Math.ceil(leng/2) ; k++) {
				res=res+String(Math.round(path[kk].x*100)/100)+','+String(Math.round(path[kk].y*100)/100)+' ';       
				kk=kk+1;
				}
			}
		result=result+res;
console.log('result=',result);
		}
	return result;
	}

    function place_pos() {
　　let select = document.getElementById('place_pos');
    //選択したf_editによって分岐
    switch (select.selectedIndex){
      case 0:               
		draw_op.align='none';
		break;
      case 1:               
		draw_op.align='left';
		break;
      case 2:               
		draw_op.align='center';
		break;
      case 3:               
		draw_op.align='right';
		break;
		}
console.log('align set=',draw_op.align);
    }

</script>
<!-- ポップアップウィンドウdraw-svg用HTML -->
<div class="dialog" id="draw-svg" title="描画">
  <div class="dialog-content">
	<button id="draw_01"><svg class="icon"><use xlink:href="#line" /></svg></button>
	<button id="draw_02"><svg class="icon"><use xlink:href="#line-endar" /></svg></button>
	<button id="draw_03"><svg class="icon"><use xlink:href="#line-sttar" /></svg></button>
	<button id="draw_04"><svg class="icon"><use xlink:href="#line-stedar" /></svg></button>
	<button id="draw_05"><svg class="icon"><use xlink:href="#serial" /></svg></button>
	<button id="draw_06"><svg class="icon"><use xlink:href="#closed" /></svg></button>
	<button id="draw_07"><svg class="icon"><use xlink:href="#smooth" /></svg></button>
	<button id="draw_08"><svg class="icon"><use xlink:href="#c-smooth" /></svg></button>
	<button id="draw_09"><svg class="icon"><use xlink:href="#q-bezier" /></svg></button>
	<button id="draw_10"><svg class="icon"><use xlink:href="#c-bezier" /></svg></button>
	<button id="draw_11"><svg class="icon"><use xlink:href="#free" /></svg></button>
    <div class="popwindow-content"></div></br>
    <p>    ---------共通--------</p>
        <form name="selbox">
	<label>線幅</label>
	   <input type="text" name="width_combo" list="width_A" id="line_size" onchange="chng_width()" autocomplete="off" style="height:25px; width:55px;">
	   <datalist id="width_A">
		<option>1</option>
    		<option selected>2</option>
		<option>4</option>
    		<option>8</option>
    		<option>12</option>
	   </datalist></br>
	</form>
        <label>矢印</label>
        <select id="arrow" onchange="chng_arrow()" style="width:60px; height:25px;" >
    		<option value="s001" selected>none</option>
    		<option value="s002">start</option>
		<option value="s003">end</option>
    		<option value="s004">both</option>
	</select></br>
	<label>線種</label>
        <select id="Lstyle" onchange="chng_Lstyle()" style="width:60px; height:25px;" >
    		<option value="s001" selected>none</option>
    		<option value="s002">dash</option>
		<option value="s003">1dash</option>
    		<option value="s004">2dash</option>
	</select></br>
  	<label>Trim&nbsp;<input type="checkbox" id="Ftrim" value=""></label><label>&nbsp;&nbsp;R&nbsp;<input type="text" id="Trim_R" value="10" style="width:60px;"></label></br>
  </div>
</div>

<script class="minify">
   var S_line_Trim=0;

   $("#draw_fig").on("click", function(){
console.log('***draw_fig');
	Svg_mode="";
	Draw_mode="";
	drawingPoints = [];
	var theDialog=$( '#draw-svg' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:320, width: 250,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
console.log('default_size=',defaultPathStyle.strokeWidth);
//	$('#line_size').value="2"; jQueryでは設定できない
	document.getElementById( "line_size" ).value = defaultPathStyle.strokeWidth;
	document.getElementById( "Trim_R" ).value = 10;
	//user_select('none');
	});

   $('#draw-svg').on('dialogclose', function(event) {
	Svg_mode="";
	Draw_mode="";
	drawingPoints = [];
	control.value="none";
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
//	user_select('auto');
console.log('Dialog closed');
	});

function draw_focusin() {
	Svg_mode="Draw";
	Draw_mode="Draw";
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}	
	if(draw_op.aux_line) {
		container.removeChild(draw_op.aux_line);
		}
	}

    $(document).on('click', '#draw_01', function(){
	draw_focusin();
	console.log('draw_01が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle='';
	});
    $(document).on('click', '#draw_02', function(){
	draw_focusin();
	console.log('draw_02が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle="end";
	});
    $(document).on('click', '#draw_03', function(){
	draw_focusin();
	console.log('draw_03が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle="start";
	});
    $(document).on('click', '#draw_04', function(){
	draw_focusin();
	console.log('draw_04が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle="both";
	});
    $(document).on('click', '#draw_05', function(){
	draw_focusin();
	console.log('draw_05が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='seri_line';
	S_line_Trim=0;
	var trim=document.getElementById("Ftrim").checked;
	if(trim==true){
		S_line_Trim=Number(document.getElementById("Trim_R").value);
	}
console.log('trim=',trim,'value=',S_line_Trim);
	});
    $(document).on('click', '#draw_06', function(){
	draw_focusin();
	console.log('draw_06が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='close_line';
	S_line_Trim=0;
	var trim=document.getElementById("Ftrim").checked;
	if(trim==true){
		S_line_Trim=Number(document.getElementById( "Trim_R" ).value);
	}
console.log('trim=',trim,'value=',S_line_Trim);
	});
    $(document).on('click', '#draw_07', function(){
	draw_focusin();
	console.log('draw_07が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='smooth';
	});
    $(document).on('click', '#draw_08', function(){
	draw_focusin();
	console.log('draw_08が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='close_smooth';
	});
    $(document).on('click', '#draw_09', function(){
	draw_focusin();
	console.log('draw_09が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='quad_bezier';
	});
    $(document).on('click', '#draw_10', function(){
	draw_focusin();
	console.log('draw_10が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='cubic_bezier';
	});
    $(document).on('click', '#draw_11', function(){
	draw_focusin();
	console.log('draw_11が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='free_line';
	});

   function chng_width()　{
console.log('**Enter change svg linewidth**',Editmode);
　　//let select = document.getElementById('line_size');
    //選択したf_editによって分岐
        var line_width=$("#line_size").val();
	defaultPathStyle.strokeWidth=String(line_width)+"px";
console.log('line width=',line_width,defaultPathStyle.strokeWidth);

	}
</script>
<!-- ポップアップウィンドウ カラーパレット　pallet用HTML -->
<div class="dialog" id="pallet" title="カラーパレット">
  <div class="dialog-content" style="position:absolute; Top:0;">
    <svg id="pallet_svg" version="1.1" style="position:absolute; Top:0;" width="300"height="88%" xmlns="http://www.w3.org/2000/svg">
          <!-- circle id="pal_circ01" cx="20" cy="20" r="5" stroke="blue" fill="yellow" stroke-width="2"/ -->
    </svg>
	</br>
    <span class="mgr-50" style="font-size:12px; font-weight:bold;">線色:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">塗色:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">文字:</span></br>
    <div class="popwindow-content"></div></br>
	<p>----------------------------------------------　　　　　　　　</p>
	</br></br></br></br></br></br><span style="font-size:12px; font-weight:bold;">&nbsp;&nbsp;&nbsp;追加:</span></br></br><input type="text" id="color_code" value="" style="position:relative; left:100px; width:65px;" ></br></br>
	<div id="set_color" style="display:none;">
	<input type="color" id="color_box">
	</div>
  </div>
</div>
<script class="minify">
var gm_selpal=['#000000','#000000','#ffffff'];
var gm_stand01=['#ffffff','#c8c8cb','#84919e','#000000','#ffcabf','#ffff80','#d8f255','#bfe4ff','#ffca80','#77d9a8'];
var gm_stand02=['#c9ace6','#804000','#990099','#f6aa00','#ff8082','#4dc4ff','#005aff','#03af7a','#fff100','#ff4b00'];
var gm_stand03=['#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff'];
var pall_init=true;
var changed_pallet=99;
var pallet_mend_flag=false;
var pallet_mode='';
var gm_sel_num=0;
var gm_pal_num=0;
var gm_sel_tag='';
var gm_sel=[];
var gm_pal=[];
var svg_gm_sel=[];
var svg_gm_pal=[];
var html_gm_sel=[];
var html_gm_pal=[];
var fw_colval;
var bk_colval;

   $("#pallet_dialog").on("click", function(){
console.log('***pallet');
	var theDialog=$( '#pallet' ) . dialog( { autoOpen: false, draggable: true, resizable: false,
		height:230, width: 350,  position: {my: "right top", at: "right top", of: window}} );
	//ダイアログを表示する
	if(Editmode!="Edit" && 	Editmode!="Svg") {
alert('pallet must be at Edit or Svg');
		return;
		}
	if(Editmode=="Edit") {
console.log('Edit pallet');
		$('#pallet').dialog('option', 'title', 'カラーパレット(html)');
		set_pallet(html_gm_sel,html_gm_pal);
		}
	if(Editmode=="Svg") {
console.log('Svg pallet');
		//document.getElementById('#pallet').value="カラーパレット(svg)";
		$('#pallet').dialog('option', 'title', 'カラーパレット(svg)');
		set_pallet(svg_gm_sel,svg_gm_pal);
		}
	theDialog.dialog("open");
	});

   $("#pallet_dialog2").on("click", function(){
console.log('Enter pallet dialog2');
	document.getElementById("pallet_dialog").click();
	});

   $('#draw-svg').on('dialogclose', function(event) {
	Svg_mode="";
//	user_select('auto');
console.log('Dialog closed');
	});

function pallet_init() {
console.log('pallet init');
	cx=-35;
	cy=20;
	for(let k=0; k<3;k++){
	  cx=cx+80;
	  let circ_id='sel_'+("00" + (k+1)).slice( -2 );
	  gm_sel.push([k,circ_id,cx,cy,gm_selpal[k]]);
	}

	var stand=gm_stand01.concat(gm_stand02,gm_stand03);
	nn=0;
	cy=40;
	for(let j=0; j<3 ;j++ ){
	  	cx=-10;
		st=10;
		if(j==2) {
				cx=40;
				st=8;
			}
	  	cy=cy+25;
		for(let k=0; k<st; k++){
			nn=nn+1;
	  		cx=cx+25;
	  		let circ_id='pal_'+("00" + (nn)).slice( -2 );
	  		gm_pal.push([nn-1,circ_id,cx,cy,stand[nn-1]]);
			}
		}
console.log('sel=',gm_sel,'pal=',gm_pal);
	return {gm_sel:gm_sel,gm_pal:gm_pal};
   }

function set_pallet(sel,pal) {
console.log('set pallet ',sel,pal);
	var pal_tag=document.getElementById('pallet_svg');
	cx=-35;
	cy=20;
	for(let k=0; k<3;k++){
	  c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
	  cx=cx+80;
	  c.setAttributeNS(null, 'cx', cx);
	  c.setAttributeNS(null, 'cy', cy);
	  c.setAttributeNS(null, 'r', 10);
	  c.setAttributeNS(null,'id',sel[k][1]);
          c.setAttributeNS(null,'fill',sel[k][4]);
	  c.setAttribute('stroke', 'green');
	  c.setAttributeNS(null, 'stroke-width', '1');
	  pal_tag.append(c);
	}

	nn=0;
	cy=40;
	for(let j=0; j<3 ;j++ ){
	  	cx=-10;
		st=10;
		if(j==2) {
				cx=40;
				st=8;
			}
	  	cy=cy+25;
		for(let k=0; k<st; k++){
			nn=nn+1;
	  		c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
	  		cx=cx+25;
	  		c.setAttributeNS(null, 'cx', cx);
	  		c.setAttributeNS(null, 'cy', cy);
	  		c.setAttributeNS(null, 'r', 10);
			c.setAttributeNS(null,'id',pal[nn-1][1]);
          		c.setAttributeNS(null,'fill',pal[nn-1][4]);
	  		c.setAttribute('stroke', 'green');
	  		c.setAttributeNS(null, 'stroke-width', '1');
	  		pal_tag.append(c);
			}
		}
   }

$(document).on('click', '#pallet', function(){
	if(Editmode=="Edit") {
console.log('Treat Edit pallet');
		treat_pallet(html_gm_sel,html_gm_pal);
		set_changed_pallet()
		}
	if(Editmode=="Svg") {
console.log('Treat Svg pallet');
		treat_pallet(svg_gm_sel,svg_gm_pal);
		set_changed_pallet()
		}
});

function treat_pallet(gm_sel,gm_pal) {
console.log('Enter treat_pallet',gm_sel,gm_pal);
	var pal_tag=document.getElementById('pallet_svg');
	var code_box = document.getElementById('color_code');
	var pnts=jQuery(":hover");
	var leng=pnts.length;
	var sel_tag=pnts[leng-1];
	var sel_id=sel_tag.id;
	var sel_kind=sel_id.slice(0,3);
	if(sel_kind=='sel') {
		num=Number(sel_id.slice(-2))-1;
		code_box.value=gm_sel[num][4];
		code_box.select();
		document.execCommand("copy");
		}
	if(sel_kind=='pal') {
		var num=Number(sel_id.slice(-2))-1;
		code_box.value=gm_pal[num][4];
		code_box.select();		
		document.execCommand("copy");
		}
console.log('catch leng=',pnts.length,' clicked=',jQuery(":hover"),'tag=',sel_tag,'catch=',sel_id,'kind=',sel_kind);
	if( sel_kind!='sel' && sel_kind!='pal'&& pallet_mode!='pick') return;
	switch (pallet_mode){
      		case 'sel':
console.log('selモード');
			//既にselモードだった場合は前の選択タグを元に戻す。
			//新たに選択されたselタグを協調表示してselモードに設定する
			if(sel_kind=='sel') {
				gm_sel_tag.setAttributeNS(null, 'stroke-width', '0');
				gm_sel_num=Number(sel_id.slice(-2))-1;
				pallet_mode='sel';
console.log('Enter to Sel mode id=',sel_id,'num=',gm_sel_num);
				sel_tag.setAttributeNS(null, 'stroke', 'red');
				sel_tag.setAttributeNS(null, 'stroke-width', '3');
				gm_sel_tag=sel_tag;
				}
			else if(sel_kind=='pal') {
				var pal_num=Number(sel_id.slice(-2))-1;
				gm_sel[gm_sel_num][4]=gm_pal[pal_num][4];
console.log('selected color=',gm_sel_num,gm_sel[gm_sel_num],gm_sel[gm_sel_num][4],'from= ',pal_num,gm_pal[pal_num],gm_pal[pal_num][4]);
          			gm_sel_tag.setAttributeNS(null,'fill',gm_sel[gm_sel_num][4]);
	  			gm_sel_tag.setAttribute('stroke', 'green');
	  			gm_sel_tag.setAttributeNS(null, 'stroke-width', '1');
				pallet_mode='';
				pallet_mend_flag=true;
				changed_pallet=gm_sel_num+1;
				}
			else return;
				break;
      		case 'pick':
console.log('Enter to Pick mode');
			//setモードで選択されたタグがpalタグであれば選択されたタグのcolorを取得しselタグに設定し表示する
				let color_box = document.getElementById('color_box');
				var set_color=color_box.value;
console.log('Pick color=',set_color,'sel_num=',gm_sel_num);
				if(set_color!='#ffffff') {
					gm_pal[gm_sel_num][4]=set_color;
					gm_sel_tag.setAttributeNS(null, 'stroke-width', '1');
          				gm_sel_tag.setAttributeNS(null,'fill',gm_pal[gm_sel_num][4]);
					gm_sel_tag.setAttribute('stroke', 'green');
					pallet_mode='';
					var set_color = document.getElementById('set_color');
					set_color.setAttribute('style', 'display:none;');
					pallet_mend_flag=true;
					code_box.value=gm_pal[gm_sel_num][4];
					code_box.select();		
					document.execCommand("copy");
					}
				break;
		default:
			//選択されたselタグを強調表示してselモードに設定する
			if(sel_kind=='sel') {
				gm_sel_num=Number(sel_id.slice(-2))-1;
				pallet_mode='sel';
console.log('Enter to Select mode id=',sel_id,'num=',gm_sel_num);
				sel_tag.setAttributeNS(null, 'stroke', 'red');
				sel_tag.setAttributeNS(null, 'stroke-width', '3');
				gm_sel_tag=sel_tag;
				}
			//選択されたタグが追加タグの場合(21以上）は協調表示してpickモードに設定する
			else if(sel_kind=='pal') {
				gm_sel_num=Number(sel_id.slice(-2))-1;
				if(gm_sel_num<20 || isNaN(gm_sel_num)) return;
				pallet_mode='pick';
console.log('Enter to Set mode id=',sel_id,'num=',gm_sel_num);
				sel_tag.setAttributeNS(null, 'stroke', 'red');
				sel_tag.setAttributeNS(null, 'stroke-width', '3');
				gm_sel_tag=sel_tag;
				var set_color = document.getElementById('set_color');
				set_color.setAttribute('style', 'display:block;');
				let color_box = document.getElementById('color_box');
				color_box.value='#ffffff';
				}
			break;
			}
	set_changed_pallet();
   }

function set_changed_pallet() {
	if(changed_pallet==0) return;
	if(changed_pallet==99) {
		defaultPathStyle.stroke=svg_gm_sel[0][4];
		document.querySelector('#svgtrig1').style.backgroundColor = svg_gm_sel[0][4];
		defaultPathStyle.fill=svg_gm_sel[1][4];
		document.querySelector('#svgtrig2').style.backgroundColor = svg_gm_sel[1][4];
		defaultCharStyle.fill=svg_gm_sel[2][4];
		document.querySelector('#svgtrig3').style.backgroundColor = svg_gm_sel[2][4];
		fw_colval=html_gm_sel[0][4];
		bk_colval=html_gm_sel[1][4];
		document.querySelector('#trig1').style.backgroundColor=html_gm_sel[0][4];
		document.querySelector('#trig2').style.backgroundColor=html_gm_sel[1][4];
		}
	else if(Editmode=="Edit") {
		if(changed_pallet==1) {
			fw_colval=html_gm_sel[0][4];
			document.querySelector('#trig1').style.backgroundColor=html_gm_sel[0][4];
			}
		if(changed_pallet==2) {
			bk_colval=html_gm_sel[1][4];
			document.querySelector('#trig2').style.backgroundColor=html_gm_sel[1][4];
			}
		}
	else {   //Editmode=="Svg"
		if(changed_pallet==1) {
			defaultPathStyle.stroke=svg_gm_sel[0][4];
			document.querySelector('#svgtrig1').style.backgroundColor = svg_gm_sel[0][4];
			}
		if(changed_pallet==2) {
			defaultPathStyle.fill=svg_gm_sel[1][4];
			document.querySelector('#svgtrig2').style.backgroundColor = svg_gm_sel[1][4];
			}
		if(changed_pallet==3) {
			defaultCharStyle.fill=svg_gm_sel[2][4];
			document.querySelector('#svgtrig3').style.backgroundColor = svg_gm_sel[2][4];
			}		
		}
	changed_pallet=0;
console.log('Style=',defaultPathStyle);
	}

function save_sysparms() {
	var svg_pal=each_charpal(svg_gm_sel,svg_gm_pal);
	svg_pal='svg;'+svg_pal+'|<=>|';

	var html_pal=each_charpal(html_gm_sel,html_gm_pal);
	html_pal='html;'+html_pal+'|<=>|';

	var pal_data=svg_pal+html_pal;
console.log('save system_data=',pal_data);
	//変数palletをDB　My_SysにEditor終了時に書き込む
	update_sysparms(1,pal_data);

	}
function each_charpal(gm_sel,gm_pal) {
	var pal_data='';
	for(let k=0; k<3;k++){
	  pal_data=pal_data+String(gm_sel[k][0])+','+gm_sel[k][1]+','+String(gm_sel[k][2])+','+String(gm_sel[k][3])+','+gm_sel[k][4]+';'
	}
	var st=10;
	var kk=0;
	for(let j=0; j<3 ;j++ ){
		if(j==2) st=8;
		for(let k=0; k<st; k++){
	  		pal_data=pal_data+String(gm_pal[kk][0])+','+gm_pal[kk][1]+','+String(gm_pal[kk][2])+','+String(gm_pal[kk][3])+','+gm_pal[kk][4]+';'
			kk+=1;
			}
		}
	return pal_data;
	}

function each_numpal(sels) {
	var sel=[];
	sel_n=0;
	for(let k=0; k<3;k++){
		sel_elem=[Number(sels[sel_n+1]),sels[sel_n+2],Number(sels[sel_n+3]),Number(sels[sel_n+4]),sels[sel_n+5]];
		sel.push(sel_elem);
		sel_n=sel_n+5;
	}
	var pal=[];
	st=10;
	for(let j=0; j<3 ;j++ ){
		if(j==2) st=8;
		for(let k=0; k<st; k++){
			pal_elem=[Number(sels[sel_n+1]),sels[sel_n+2],Number(sels[sel_n+3]),Number(sels[sel_n+4]),sels[sel_n+5]];
			pal.push(pal_elem);
			sel_n=sel_n+5;
			}
		}
	return {sel:sel,pal:pal};
	}

function read_sysparms() {
	//Editor開始時にDB My_Sysからデータを読み込んでSvg用及びHTML用pallet変数にセットする
	var from_sys=get_common(1);
//from_sys='';
console.log('from_sys=',from_sys);
	if(from_sys=='') {
console.log('sysdata initial');
		var {gm_sel,gm_pal}=pallet_init();
		svg_gm_sel=gm_sel;
		svg_gm_pal=gm_pal;
		html_gm_sel=gm_sel;
		html_gm_pal=gm_pal;
		}
	else {
		var parms=from_sys.split('|<=>|');
console.log('sys parms=',parms);
		len=parms.length;
		for(let kn=0;kn<len;kn++){
			if(parms[kn]=='') break;
			var sels=parms[kn].split(/;|,/);
			if(sels[0]=='svg') {
				var {sel,pal}=each_numpal(sels);
				svg_gm_sel=sel;
				svg_gm_pal=pal;
				}
			if(sels[0]=='html') {
				var {sel,pal}=each_numpal(sels);
				html_gm_sel=sel;
				html_gm_pal=pal;
				}
			}
		}
	set_changed_pallet();
console.log('svg pallet=',svg_gm_sel,svg_gm_pal);
console.log('html pallet=',html_gm_sel,html_gm_pal);
	} //End of read_sysparms

   function update_sysparms(rec,data) {
		var save_data=escapeHtml(escape(data));
		n_rec=String(rec);
		
        	$.ajax({
            		url: "/db_serv/update_sys/",
            		async:false,
            		data: {
				"rec_num":n_rec,
				"script":save_data,
				},
            		dataType: 'json'
        		})
        	.done((data) => {
            		//結果が帰ってきたら、表示します。
//console.log('**Ajax Returned result=',data);
        		});
		}
</script>
<!-- ポップアップウィンドウdraw-svg用HTML -->
<div class="dialog" id="pop_input_search" title="概要">
  <div class="dialog-content">
	<form name="selboxB">
	<p><label>課題名</label><br>
	<input type="text" name="comboA" list="list_A" id="comA" onchange="chanComA()" autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_A"></datalist>
	<p><label>大分類</label><br>
	<input type="text" name="comboB" list="list_B" id="comB" onchange="chanComB()"  autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_B"></datalist>
	<p><label>中分類</label><br>
	<input type="text" name="comboC" list="list_C" id="comC" onchange="chanComC()"  autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_C"></datalist>
	<p><label>小分類</label><br>
	<input type="text" name="comboD" list="list_D" id="comD" onchange="chanComD()"  autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_D"></datalist>
	<p><label>概要</label><br>
	<textarea name="viewText" id="Texview" cols="32" rows=5 maxlength="150" style="line-height: 1em"></textarea>
	<p><label>更新日</label><br>
	<input type="date" id="T_date"></input>
	</form>
   	<button id="pop_save">Save</button>　<button id="pop_cancel">Cancel</button>
  </div>
</div>
<script class="minify">
//　My_Indexモデルのixdata_n　よりコンボデータを作成する
   var gDataCombobox = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxA = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxB = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxC = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxD = [{ id: 0, value: "" ,pk:0,nn:0}];

   var set_ComboA = { id: 0, value: "" ,pk:0,nn:0};
   var set_ComboB = { id: 0, value: "" ,pk:0,nn:0};
   var set_ComboC = { id: 0, value: "" ,pk:0,nn:0};
   var set_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   var old_ComboA = { id: 0, value: "" ,pk:0,nn:0};
   var old_ComboB = { id: 0, value: "" ,pk:0,nn:0};
   var old_ComboC = { id: 0, value: "" ,pk:0,nn:0};
   var old_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   var Pop_Edit=0;

function pop_inp_search() {
console.log('***popup_input検索');
	var theDialog=$( '#pop_input_search' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:450, width: 320,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	get_index(0,1,'');    // Top indexを取得する
//indexdata（keyword）の読み込み
	if (my_overview!='') {
//documentを既に読み込んでいる場合（Edit又はCopy新規の場合）
		overview_term=my_overview.split('|<=>|');
console.log('overviews=',overview_term);
		document.getElementById( "comA" ).value=overview_term[0];
		chanComA();
		document.getElementById( "comB" ).value=overview_term[1];
		chanComB();
		document.getElementById( "comC" ).value=overview_term[2];
		chanComC();
		document.getElementById( "comD" ).value=overview_term[3];
		chanComD();
		document.getElementById( "Texview" ).value=unescapeHtml(unescape(overview_term[7]));
		old_ComboA.value=set_ComboA.value;
		old_ComboA.pk=set_ComboA.pk;
		old_ComboB.value=set_ComboB.value;
		old_ComboB.pk=set_ComboB.pk;
		old_ComboC.value=set_ComboC.value;
		old_ComboC.pk=set_ComboC.pk;
		old_ComboD.value=set_ComboD.value;
		old_ComboD.pk=set_ComboD.pk;
console.log('old_Combo=',old_ComboA,old_ComboB,old_ComboC,old_ComboD);
		Pop_Edit=0;
		}
}  //End pop_inp_search

/*  index dataの要求　　　　*/
function ret_index(){
	gDataComboboxA=gDataCombobox;
console.log('gDataComboboxA=',gDataComboboxA);

  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_B"));
	remove_all_child(document.getElementById("list_C"));
	remove_all_child(document.getElementById("list_D"));
//console.log(document.getElementById("list_A").children);
  	for(var i=0;i<gDataComboboxA.length;i++){
	    	var op = document.createElement("option");
    		op.value = gDataComboboxA[i].value;
    		document.getElementById("list_A").appendChild(op);
  		}
	document.getElementById( "comA" ).value='';
	document.getElementById( "comB" ).value='';
	document.getElementById( "comC" ).value='';
	document.getElementById( "comD" ).value='';
   }  //End of function get_topindex

function remove_all_child(elem) {
	while( elem.firstChild ){
  		elem.removeChild( elem.firstChild );
	}
   }

function get_index(level,pk_num,key_wd) {
console.log('*** get index data require　Entered  ***');
console.log('level=',level,' pk_num=',pk_num,' key_wd=',key_wd);
        $.ajax({
            url: "/db_serv/get_index/",
            async:false,
            data: {
		"level":level,
		"pk_num":pk_num,
		"key_wd":key_wd
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		console.log('**Ajax Returned result=',data);
		var key_elem=data['key_tags'].split('|<=>|');
		console.log('keys=',key_elem);
		gDataCombobox = [{ id: 0, value: "" ,pk:0,nn:0}];
		for(var i=0;i<key_elem.length;i++) {
			var dkey=key_elem[i].split(',');
			var item = new Object();
			item.id = i; // input value
			item.value = dkey[0];
			item.pk=dkey[1];
			item.nn=dkey[2];
			gDataCombobox.push(item)
			}
console.log('level=',data['level']);
		 switch (data['level']){
      			case 0:
console.log('enter case 0');
				ret_index();
				break;
      			case 1:
 				ret_chngcombA();
				Pop_Edit=4;
				break;
      			case 2:
 				ret_chngcombB();
				if (Pop_Edit<3) {
					Pop_Edit=3;
					}
				break;
	  		case 3:
 				ret_chngcombC();
				if (Pop_Edit<2) {
					Pop_Edit=2;
					}
				break;
	  		case 4:
				if (Pop_Edit<1) {
					Pop_Edit=1;
					}
				break;
			default:
				break;
			}
        });
   }  //End function get_index

pop_save.onclick = function(){
console.log('** Enter pop Save Pop_Edit=',Pop_Edit)
//new keys 及び　old keysの健全性checkと変更をAjax送信（mod_index())
console.log('new_Combo=',set_ComboA,set_ComboB,set_ComboC,set_ComboD);
console.log('old_Combo=',old_ComboA,old_ComboB,old_ComboC,old_ComboD);
	if(Pop_Edit>0) {
		var save_Pop_Edit=Pop_Edit;
		set_new_index()
		Pop_Edit=save_Pop_Edit;
		set_old_index()
		mod_index('last',0,1,'');
		}

//テスト用としてここでdocumentをsaveする
//my_overviewの生成
	overview_term[7]=document.getElementById("Texview").value;
	my_overview=compose_overview(set_ComboA.value,set_ComboB.value,set_ComboC.value,set_ComboD.value,overview_term);
console.log(my_overview);
	doc_save();
	$( '#pop_input_search' ) . dialog("close");
//Doc　本体のSave(set key_wd to my_overview, set my_head, 本体（html　and　Svg）
   }  //End of function pop_save

function newdoc_compose(){
	const ary = new Array(9);
	for (let i = 0, len = ary.length; i < len; i++) {
    		ary[i] = '';
		}
	ary[7]='新規レコード:'
	var dat=formatDate(new Date());
	ary[4]=dat;
	ary[5]=dat;

	ret=ary[0];
	for(var k=1;k<ary.length;k++) {
		ret=ret+'|<=>|'+ary[k];
		}
console.log(ret);
	return ret;
	}  //End newdoc_compose

// 日付をYYYY-MM-DDの書式で返すメソッド
function formatDate(dt) {
  var y = dt.getFullYear();
  var m = ('00' + (dt.getMonth()+1)).slice(-2);
  var d = ('00' + dt.getDate()).slice(-2);
  return (y + '-' + m + '-' + d);
}

function compose_overview(a,b,c,d,term){
	var ret=a+'|<=>|'+b+'|<=>|'+c+'|<=>|'+d;
console.log('term=',term,term.length);
	for(var k=4;k<term.length;k++) {
	term[k]=escapeHtml(escape(term[k]));
		ret=ret+'|<=>|'+term[k];
		}
console.log(ret);
	return ret;
	}

function set_new_index(){
	start_ind=0;
	if(Pop_Edit>3) {
console.log('Pop_Edit=',Pop_Edit,'start from Top_index');
console.log('modify_index=',set_ComboA,old_ComboA);
		start_ind=1;
		mod_index('start',0,1,'');
		if(set_ComboA.pk==0) {
			mod_index('new',1,set_ComboA.pk,set_ComboA.value);
			}
		else if(set_ComboA.pk!=0) {
			mod_index('add',1,set_ComboA.pk,set_ComboA.value);
			}
		Pop_Edit=3;
		}
	if(Pop_Edit>2) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboA);
console.log('modify_index=',set_ComboB,old_ComboB);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',1,set_ComboA.pk,set_ComboA.value);
			}
		if((set_ComboB.pk==0)&&(set_ComboB.value!='')) {
			mod_index('new',2,set_ComboB.pk,set_ComboB.value);
			}
		else if(set_ComboB.pk!=0){
			mod_index('add',2,set_ComboB.pk,set_ComboB.value);
			}
		Pop_Edit=2;
		}
	if(Pop_Edit>1) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboB);
console.log('modify_index=',set_ComboC,old_ComboC);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',2,set_ComboB.pk,set_ComboB.value);
			}
		if((set_ComboC.pk==0)&&(set_ComboC.value!='')) {
			mod_index('new',3,set_ComboC.pk,set_ComboC.value);
			}
		else if(set_ComboC.pk!=0) {
			mod_index('add',3,set_ComboC.pk,set_ComboC.value);
			}
		Pop_Edit=1;
		}
	if(Pop_Edit>0) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboC);
console.log('modify_index=',set_ComboD,old_ComboD);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',3,set_ComboC.pk,set_ComboC.value);
			}
		if((set_ComboD.pk==0)&&(set_ComboD.value!='')) {
			mod_index('new',4,set_ComboD.pk,set_ComboD.value);
			}
		else if(set_ComboD.pk!=0) {
			mod_index('add',4,set_ComboD.pk,set_ComboD.value);
			}
		Pop_Edit=0;
		}
	} //End set_new_index

function set_old_index(){
	start_ind=0;
	if(Pop_Edit>3) {
console.log('Pop_Edit=',Pop_Edit,'start from Top_index');
console.log('modify_index=',set_ComboA,old_ComboA);
		start_ind=1;
		mod_index('start',0,1,'');
		if((set_ComboA.pk!=old_ComboA.pk)&&(old_ComboA.pk!=0)){
			mod_index('del',1,old_ComboA.pk,old_ComboA.value);
			}
		Pop_Edit=3;
		}
	if(Pop_Edit>2) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboA);
console.log('modify_index=',set_ComboB,old_ComboB);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',1,set_ComboA.pk,set_ComboA.value);
			}
		if((set_ComboB.pk!=old_ComboB.pk)&&(old_ComboB.pk!=0)){
			mod_index('del',2,old_ComboB.pk,old_ComboB.value);
			}
		Pop_Edit=2;
		}
	if(Pop_Edit>1) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboB);
console.log('modify_index=',set_ComboC,old_ComboC);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',2,set_ComboB.pk,set_ComboB.value);
			}
		if((set_ComboC.pk!=old_ComboC.pk)&&(old_ComboC.pk!=0)){
			mod_index('del',3,old_ComboC.pk,old_ComboC.value);
			}
		Pop_Edit=1;
		}
	if(Pop_Edit>0) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboC);
console.log('modify_index=',set_ComboD,old_ComboD);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',3,set_ComboC.pk,set_ComboC.value);
			}
		if((set_ComboD.pk!=old_ComboD.pk)&&(old_ComboD.pk!=0)){
			mod_index('del',4,old_ComboD.pk,old_ComboD.value);
			}
		Pop_Edit=0;
		}
	}  //End set_old_index

function mod_index(mod,level,pk_num,key_wd) {
console.log('*** modify index Ajax mod=',mod,'level=',level,'pk=',pk_num,'key=',key_wd);
        $.ajax({
            url: "/db_serv/mod_index/",
            async:false,
            data: {
		"mod":mod,
		"level":level,
		"pk_num":pk_num,
		"key_wd":key_wd
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		console.log('**Ajax Returned result=',data);
        	})

   }  //End function mod_index


//Editor画面 combobox ComA onchange function 
function chanComA() {
   E_selA=$("#comA").val();
console.log('**Editor SelectA =',E_selA);
console.log('gDataComboboxA=',gDataComboboxA,'leng=',gDataComboboxA.length);
	n_selA=0;
	for(i=0; i<gDataComboboxA.length ;i++) {
		if(gDataComboboxA[i].value==E_selA) {
			n_selA=i;
			break;
			}
		}
	E_selA=cutescape(E_selA.trim());
	if(n_selA!=0){
		var level=1;
		var pk_num=gDataComboboxA[n_selA].pk
		set_ComboA=gDataComboboxA[n_selA];
console.log('comA=',gDataComboboxA[n_selA]);
		get_index(level,pk_num,E_selA);
		}
	else {
		set_ComboA.value=E_selA;
		set_ComboA.pk=0;
		dmret_chngcombA();
		Pop_Edit=4;
		}
   }

function ret_chngcombA(){
	gDataComboboxB=gDataCombobox;
console.log('gDataComboboxB=',gDataComboboxB);
	dmret_chngcombA();

  	for(var i=0;i<gDataComboboxB.length;i++){
    		var op = document.createElement("option");
    		op.value = gDataComboboxB[i].value;
    		document.getElementById("list_B").appendChild(op);
  		}
//console.log(document.getElementById("list_B").children);
	}

function dmret_chngcombA(){
  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_B"));
	remove_all_child(document.getElementById("list_C"));
	remove_all_child(document.getElementById("list_D"));

	document.getElementById( "comB" ).value='';
	document.getElementById( "comC" ).value='';
	document.getElementById( "comD" ).value='';
	set_ComboB = { id: 0, value: "" ,pk:0,nn:0};
	set_ComboC = { id: 0, value: "" ,pk:0,nn:0};
	set_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   }  //End of function ret_chngcombA

// combobox CombB onchange function
function chanComB() {
   E_selB=$("#comB").val();
console.log('**Editor SelectB =',E_selB);
console.log('gDataComboboxB=',gDataComboboxB,'leng=',gDataComboboxB.length);
	n_selB=0;
	for(i=0; i<gDataComboboxB.length ;i++) {
		if(gDataComboboxB[i].value==E_selB) {
			n_selB=i;
			break;
			}
		}
	E_selB=cutescape(E_selB.trim());
	if(n_selB!=0){
		var level=2;
		var pk_num=gDataComboboxB[n_selB].pk
		set_ComboB=gDataComboboxB[n_selB];
console.log('comB=',gDataComboboxB[n_selB]);
		get_index(level,pk_num,E_selB);
		}
	else {
		set_ComboB.value=E_selB;
		set_ComboB.pk=0;
		dmret_chngcombB();
		if(Pop_Edit<3){
			Pop_Edit=3;
			}
		}
   }

function ret_chngcombB(){
	gDataComboboxC=gDataCombobox;
console.log('gDataComboboxC=',gDataComboboxC);
	dmret_chngcombB();
  	for(var i=0;i<gDataComboboxC.length;i++){
    		var op = document.createElement("option");
    		op.value = gDataComboboxC[i].value;
    		document.getElementById("list_C").appendChild(op);
  		}
//console.log(document.getElementById("list_C").children);
   }

function dmret_chngcombB(){
  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_C"));
	remove_all_child(document.getElementById("list_D"));

	document.getElementById( "comC" ).value='';
	document.getElementById( "comD" ).value='';
	set_ComboC = { id: 0, value: "" ,pk:0,nn:0};
	set_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   }  //End of function ret_chngcombB

// combobox CombC onchange function
function chanComC() {
   E_selC=$("#comC").val();
console.log('**Editor SelectC =',E_selC);
console.log('gDataComboboxC=',gDataComboboxC,'leng=',gDataComboboxC.length);
	n_selC=0;
	for(i=0; i<gDataComboboxC.length ;i++) {
		if(gDataComboboxC[i].value==E_selC) {
			n_selC=i;
			break;
			}
		}
	E_selC=cutescape(E_selC.trim());
	if(n_selC!=0){
		var level=3;
		var pk_num=gDataComboboxC[n_selC].pk
		set_ComboC=gDataComboboxC[n_selC];
console.log('comC=',gDataComboboxC[n_selC]);
		get_index(level,pk_num,E_selC);
		}
	else {
		set_ComboC.value=E_selC;
		set_ComboC.pk=0;
		dmret_chngcombC();
		if(Pop_Edit<2){
			Pop_Edit=2;
			}
		}
   }

function ret_chngcombC(){
	gDataComboboxD=gDataCombobox;
console.log('gDataComboboxD=',gDataComboboxD);
	dmret_chngcombC();
  	for(var i=0;i<gDataComboboxD.length;i++){
    		var op = document.createElement("option");
    		op.value = gDataComboboxD[i].value;
    		document.getElementById("list_D").appendChild(op);
  		}
//console.log(document.getElementById("list_D").children);
   }

function dmret_chngcombC(){
  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_D"));
	document.getElementById( "comD" ).value='';
	set_ComboD = { id: 0, value: "" ,pk:0,nn:0};
   }  //End of function ret_chngcombB

function chanComD() {
   E_selD=$("#comD").val();
console.log('**Editor SelectD =',E_selD);
//console.log('gDataComboboxD=',gDataComboboxD,'leng=',gDataComboboxD.length);
	n_selD=0;
	for(i=0; i<gDataComboboxD.length ;i++) {
		if(gDataComboboxD[i].value==E_selD) {
			n_selD=i;
			break;
			}
		}
	E_selD=cutescape(E_selD.trim());;
	if(n_selD!=0){
		var level=4;
		var pk_num=gDataComboboxD[n_selD].pk
		set_ComboD=gDataComboboxD[n_selD];
console.log('comD=',gDataComboboxD[n_selD]);
		get_index(level,pk_num,E_selD);
   		}
	else {
		set_ComboD.value=E_selD;
		set_ComboD.pk=0;
		if(Pop_Edit<1){
			Pop_Edit=1;
			}
		}
   }

function make_url(num){
   //window.location.href = "{% url 'editor' 123 %}".replace(/123/,num);
   window.open().location.href = "{% url 'editor' 123 %}".replace(/123/,num);
}

//新規Svg領域の作成（chain_svg）
chain_svg.onclick = function() {
    const selectedText = window.getSelection().toString();
console.log('**Chain svg at text=',selectedText);
    if(Editmode!='Edit') {
		alert('Only Edit mode');
		return;
		}
    place_to_tag();
console.log('top_node=',doc_top_node,'node=',doc_edit_node,'level=',doc_deep_level);
    var new_node=tag_trees[tag_trees.length-2].node;

    var svg_div = document.createElement('div');
    var newtag=getname_cnsvg(cnsvg_tags);
console.log('new cnsvg=',newtag);
    cnsvg_nums=cnsvg_nums+1;
    var divtag='div'+newtag;
    svg_div.setAttribute('id', divtag);
    var parms=doc_top_node.getAttribute('style');
    svg_div.setAttribute('style', parms);
    svg_div.setAttribute('class', 'divsvg');

    var oya=doc_top_node.parentNode;
    $(svg_div).insertAfter(doc_top_node);
    svg_div.appendChild(new_node);

    var tagn=document.getElementById('chain');
    var newsvg=tagn.cloneNode(true);
    newsvg.setAttribute('id', newtag);
    newsvg.setAttribute('style', 'display:block;');
	var rect=createRectFig(0,0,20,20);
	rect.setAttribute('class', 'chain_svg_mark');
	rect.setAttribute('stroke', 'blue');
	rect.setAttribute('stroke-width', '1');
	rect.setAttribute('fill', 'blue');
	newsvg.appendChild(rect);
console.log('***make g01 group as container');
    container=newsvg;
    var {group,fig_id}=make_group('top');
    group.setAttribute('class', 'top');
console.log(newsvg,svg_div);
    oya.insertBefore(newsvg,svg_div);
    svg_tag_add(newtag);

//    var res=confirm("This position OK ?");
//新規My_CnSvgのAjaxへの設定と書き込み
    var cn_header=cnhead_compose('0','CnSvg','False','False');
    var svg_tags=fold_svg(newtag);
    save_cnsvg(cn_header,svg_tags);
console.log('cnsvg_header=',cn_header);
//My_Dtataのcnsvg_tagsへの変更処理とDBへの書き込み
    cnsvg_tags.push({name: newtag,pk: cnsvg_new_pk,head:wfcn_header});
console.log('cnsvg_tags=',cnsvg_tags);
//    var tags_header=cntags_compose();
//    update_head(header_term[0],String(cnsvg_nums),tags_header);
//console.log('My_Data mend nk=',header_term[0],String(cnsvg_nums),tags_header);
    set_svg('svg_00');
    change_css(Editmode);
    }

function getname_cnsvg(){
	nn=cnsvg_tags.length;
	var max=0;
	for(var i=0;i<nn;i++){
		var name=cnsvg_tags[i].name;
		var num = Number(name.slice( -2 ));
		if(num>max) {
			max=num;
			}
		}
	max=max+1;
	var newtag='svg_'+("00" + max).slice( -2 );
	return newtag;
	}

function cnhead_compose(a,b,c,d) {
	ret=a+','+b+','+c+','+d;
console.log(ret);
	return ret;
	}

function svgtag_decompose(nums,header) {
	var elem=header.split(';');
console.log('elems leng=',elem.length,elem);
//cn_svgs = [{ name: "" ,pk:0}];
	var cn_svgs=[];
	for(var i=0;i<elem.length-1;i++) {
		var value=elem[i].split(',');
		cn_svgs.push({name: value[0],pk: value[1]});
		}
	return cn_svgs;
	}

function cntags_compose(){
	tags='';
	if(cnsvg_nums>0) {
		for(var i=0;i<cnsvg_nums;i++) {
		tags=tags+cnsvg_tags[i].name+','+String(cnsvg_tags[i].pk)+';';
			}
		}
	return tags;
	}

function svg_tag_add(newtag) {
	var element = document.getElementById( "svg_tag_menu" ) ;
	var newElement = new Option(newtag,newtag) ;	// <option value="baz">選択肢3</option>
	element.add( newElement ) ;
}

function svg_tag_del() {
	var sl = document.getElementById( "svg_tag_menu" ) ;
	while(sl.childElementCount>1)
		{
		sl.removeChild(sl.lastChild);
		}
}

  function chang_svg() {
console.log('**Change svg_tag');

//     id="svg_tag_menu" onchange="chang_svg()
    console.log('selectIndex=',svg_tag_menu.selectedIndex);
	var k=svg_tag_menu.selectedIndex;
console.log(svg_tag_menu,svg_tag_menu.options[k].value);
	var tag=svg_tag_menu.options[k].value;
        var target = document.getElementById("JumpTo");
        target.href = "#"+tag;

	svg_now=tag;
	set_svg(tag);

        document.getElementById('JumpTo').click();
    }

function set_svg(tag) {

	org_container = document.getElementById(tag);

	if(org_container.querySelector('.top')==null) {
console.log('***make g01 group as container');
		container=org_container;
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		container=org_container.appendChild(group);
		}
	else {
		container=org_container.querySelector('.top');
		}
console.log('change container to=',org_container,container);

} //End set_svg

//クリック時の動作
function keyClick(event) { //*2
	//イベント処理
	var key_event = event || window.event; //*3
	var key_shift = (key_event.shiftKey); //*4
	var key_ctrl = (key_event.ctrlKey);
	var key_alt = (key_event.altKey);
	var key_meta = (key_event.metaKey);
	//キーに対応した処理
	var s = "click! ";
	if (key_shift) s += "shiftキー ";
	if (key_ctrl) s += "ctrlキー ";
	if (key_alt) s += "altキー ";
	if (key_meta) s += "metaキー ";
	//出力
console.log(s);
}
function sfift_key(event) { //*2
	//イベント処理
	var key_event = event || window.event; //*3
	var key_shift = (key_event.shiftKey); //*4
	return key_shift;
}

function key_event(event) { //*2
	//イベント処理
	var key_event = event || window.event; //*3
	return key_event;
}
/*
function code_to_html(e){
   var res='';
   if(Editmode=="Thtm")　{   //　Editモードの場合のみhtml変換
	if(window.event.keyCode==13){
		if(window.event.shiftKey){ //Shift+Enterの場合
			var res="<br>"
			}
		else {  //Enterの場合
			var res="</p>"
			}
		//テキストエリアと挿入する文字列を取得
console.log('***Inskey***');
		var area = document.getElementById('texh');
		//カーソルの位置を基準に前後を分割して、その間に文字列を挿入
		area.value = area.value.substring(0, area.selectionStart)
			+ res
			+ area.value.substring(area.selectionStart);

		}
	}
   else {
	if (Editmode=="Edit") {
console.log('event=',window.event.keyCode);
		if(window.event.keyCode==8){
			return false;
			}
		}
	}
   }
*/
</script>
<script  class="minify">
//ダブルクリック時の処理を入れる
var dbl_click_func=function(e){
// ダブルクリックイベントの処理内容
console.log( "ダブルクリック!!" ) ;
//simple lineなのにdouble clickで終わった場合を入れる
//serial_line　close_line　smooth_line smooth & close lineの場合
	clickCount = 0 ;
	if(Svg_mode=="Svg_reshape_pending") return;
	Oper=2;
	if ((control.value== 'simp_line')||(control.value== 'seri_line')||(control.value== 'close_line')||(control.value== 'smooth')||(control.value== 'close_smooth')){
		var x0=e.clientX;
		var y0=e.clientY;
		if(mesh_draw && mesh_integer) {
			x0=Math.round(x0/10)*10;
			y0=Math.round(y0/10)*10;
			}
		else {
			x0=Math.round(x0*10)/10;
			y0=Math.round(y0*10)/10;
			}
        	drawingPoints.push({x: x0,y: y0});
		if((key_shift)&&(drawingPoints.length>1)) {
console.log('x0,y0=',x0,y0);
			mend_points();
			}
		if(drawingPoints.length<2) {
			alert('not proper figure');
			drawingPoints = [];
			Step=0;
			return;
			}
		else if((drawingPoints.length==2) && (control.value=='simp_line')){
			var {group,fig_id}=make_group('line');
console.log('make_group=',group,fig_id,'Step=',Step);
			}
		else {
			var {group,fig_id}=make_group('path');
console.log('make_group=',group,fig_id,'Step=',Step);
			}
console.log('***fig id= ',fig_id);
		var c_para="else";
		if((control.value== 'close_line')||(control.value== 'close_smooth')) {
			c_para="close";
			drawingPoints.push(drawingPoints[0]);
			}
		if (first_point){
			container.removeChild(first_point);
			first_point=null;
			}
		if(drawingPath){
        		container.removeChild(drawingPath);
                	drawingPath=null;
			}
        	drawingPath = null;
        	var path;
		group.setAttributeNS(null,'close', c_para);
		var s_para="else";
console.log(drawingPoints);
		if((control.value== 'smooth')||(control.value== 'close_smooth')) {
			//3次ベジエで滑らかにするアルゴリズム　resultPoints=catmullRom2bezier(drawingPoints);では上手くいかず
			s_para="smooth";
			}
		else if(((control.value== 'seri_line')||(control.value== 'close_line'))&&(S_line_Trim>0)) {
			var R=S_line_Trim;
			s_para='trim '+String(S_line_Trim);
			}
		group.setAttributeNS(null,'smooth', s_para);
		var path=set_line_group(group,c_para,s_para);
		if(tempArrowStyle || defaultArrowStyle) {
			if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
			if(c_para=='close') tempArrowStyle='';
console.log('arrowstyle=',tempArrowStyle);
			remake_group(group,path,tempArrowStyle);
			tempArrowStyle='';
			}
		group.appendChild(path);
		drawingPoints = [];
		}
}  //Double Click End
////
    function set_line_group(group,close,s_para) {
	var result = s_para.split(' ');
	var smooth =result[0];
	var trim_val=result[1];
console.log('close=',close,' smooth=',smooth,'trim_val=',trim_val);
		if((smooth== 'smooth') && (drawingPoints.length>2)) {
			//3次ベジエで滑らかにするアルゴリズム　resultPoints=catmullRom2bezier(drawingPoints);では上手くいかず
//			path_p=Cubic_interpol(drawingPoints,control.value);
			my_confirm(4);

console.log('*****Exec Cubic code Path_P=',path_p);
			bez_path=createCubicBezier(path_p,close)
			Object.assign(bez_path.style, defaultPathStyle);
		        var rtn_path=bez_path;
//			group.append(bez_path);
/*
			for (var i=0;i<path_p.length;i++){          //　Bezier構成pointsの描画
				first_point=createFirstPoint([path_p[i]]);
	        		Object.assign(first_point.style, defaultPointStyle);
        			container.appendChild(first_point);
				}
*/
			}
		else  {           //if ((control.value== 'line')||(control.value== 'close_line') の場合
			if(smooth=='trim') {
//console.log(drawingPoints);
				var f_cls=0;
				var nn=drawingPoints.length;
				var x0=drawingPoints[0].x;
				var y0=drawingPoints[0].y;
				var R=trim_val;
				var vx;
				var vy;
				var vlen;
				var xs,xe,ys,ye,qx,qy;
				var def_points='';
				if(close== 'close') f_cls=1;
				for (let i=0;i<nn-1;i++) {
					vx=drawingPoints[i+1].x-drawingPoints[i].x
					vy=drawingPoints[i+1].y-drawingPoints[i].y
					vlen=Math.sqrt(vx**2+vy**2);
					vx=vx/vlen;
					vy=vy/vlen;
					xs=Math.round((drawingPoints[i].x+R*vx)*100)/100;
					ys=Math.round((drawingPoints[i].y+R*vy)*100)/100;
					xe=Math.round((drawingPoints[i+1].x-R*vx)*100)/100;
					ye=Math.round((drawingPoints[i+1].y-R*vy)*100)/100;
console.log('x y=',xs,ys,xe,ye);
					if(i==0) {
						if(f_cls==1) {
							x0=xs;
							y0=ys;
							def_points=def_points+` M${xs}, ${ys} `;
							}
						else {
							def_points=def_points+` M${x0}, ${y0} `;
							}
						}
					if(i>0){
						def_points=def_points+` ${xs}, ${ys} `;
						def_points=def_points+` M${xs}, ${ys} `;
						}
					if((i==nn-2)&&(f_cls==0)){
						def_points=def_points+` ${drawingPoints[i+1].x}, ${drawingPoints[i+1].y} `;
						}
					else {
						def_points=def_points+` ${xe}, ${ye} `;
						def_points=def_points+` M${xe}, ${ye} Q${drawingPoints[i+1].x}, ${drawingPoints[i+1].y}`;
						}
					}
				if(f_cls==1) {
					def_points=def_points+` ${x0}, ${y0} `;
					}
console.log('Points=',def_points);
        			var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        			path.setAttributeNS(null, 'd', def_points);
				Object.assign(path.style, defaultPathStyle);
				var rtn_path=path;
//				group.append(path);
				}
			else {
	        		path = createPath(drawingPoints,close,rect,def_points);
        			Object.assign(path.style, defaultPathStyle);
				var rtn_path=path;
//        			group.append(path);
				}
			}

		var def_points='';
		var rect='';
		Oper=0;
		Step=0;
		return(rtn_path);
	}　　　//　End　of　line、close_line、smooth、close_smooth

        function set_common(code,name){
            var script = document.createElement('script');
	    script.setAttribute('id', name);
	    script.innerHTML =code ;
//            script.innerText =code ;
//            script.textContent = code;
            document.body.appendChild(script);
	}

   function get_common(n_rec){
	var script='';
	rec_num=String(n_rec);
		
        	$.ajax({
            		url: "/db_serv/get_script/",
            		async:false,
            		data: {
				"rec_num":rec_num,
				},
            		dataType: 'json'
        		})
        	.done((data) => {
            		//結果が帰ってきたら、表示します。
console.log('**Ajax Returned result=',data);
			script=data['script'];
			script=unescapeHtml(unescape(script));
console.log('length,script=',script.length,script);
        		});
	return script;
	}

function my_confirm(n) {
	var exe_script01=get_common(n);
	set_common(exe_script01,'exe01');
	var script00=document.getElementById('exe01');
	script00.remove();
	}

function Debug_Cubic_interpol(pts,controle){
   var iLen= pts.length;
   var cubics=[];
   var sn=[];
   var vn=[];
   var wn=[];

   for ( var i = 0;  i < iLen ; i++ ){
	sn[i]=[0,0];
	vn[i]=[0,0];
	wn[i]=[0,0];
	}
//slope vector の作成   pts[i]からpts[i-1]→pts[i+1]の方向
   for ( var i = 1;  i < iLen-1 ; i++ ){
	sn[i][0]=pts[i].x+pts[i+1].x-pts[i-1].x;
	sn[i][1]=pts[i].y+pts[i+1].y-pts[i-1].y;
	}

     if (controle=='close_line') {
	sn[iLen-1][0]=pts[iLen-1].x+pts[1].x-pts[iLen-2].x;
	sn[iLen-1][1]=pts[iLen-1].y+pts[1].y-pts[iLen-2].y;

	sn[0][0]=pts[0].x+pts[1].x-pts[iLen-2].x;
	sn[0][1]=pts[0].y+pts[1].y-pts[iLen-2].y;
	}

     else{
	var vn0x=(pts[0].x+pts[1].x)/2;
	var vn0y=(pts[0].y+pts[1].y)/2;
	var vnx=vn0x-(pts[1].y-pts[0].y);
	var vny=vn0y+(pts[1].x-pts[0].x);

	var point1 = {
	    start : { x : pts[0].x, y : pts[0].y }, // 始点
	    end   : { x : pts[0].x+(pts[2].x-pts[0].x) , y : pts[0].y+(pts[2].y-pts[0].y) }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);

	sn[0][0]=2*vn0x-result.x;                        //at　Start　ポイント
	sn[0][1]=2*vn0y-result.y;

	var vn0x=(pts[iLen-2].x+pts[iLen-1].x)/2;
	var vn0y=(pts[iLen-2].y+pts[iLen-1].y)/2;
	var vnx=vn0x-(pts[iLen-1].y-pts[iLen-2].y);
	var vny=vn0y+(pts[iLen-1].x-pts[iLen-2].x);

	var point1 = {
	    start : { x : pts[iLen-1].x, y : pts[iLen-1].y }, // 始点
	    end   : { x : pts[iLen-1].x+(pts[iLen-1].x-pts[iLen-3].x) , y : pts[iLen-1].y+(pts[iLen-1].y-pts[iLen-3].y) }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);

	sn[iLen-1][0]=2*vn0x-result.x;　　//at　End　ポイント
	sn[iLen-1][1]=2*vn0y-result.y;

var drawPoint=[];
var x0,y0,x1,x2;
drawPoint.push({x: pts[iLen-1].x,y: pts[iLen-1].y});
drawPoint.push({x: sn[iLen-1][0],y: sn[iLen-1][1]});
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle);
container.appendChild(bezier_line);
     }

var drawPoint=[];
var x0,y0,x1,x2;
   for ( var i = 0; i < iLen-1 ; i++ ){
drawPoint.push({x: pts[i].x,y: pts[i].y});
drawPoint.push({x: sn[i][0],y: sn[i][1]});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle);
container.appendChild(bezier_line);
drawPoint=[];

	var vn0x=(2*pts[i].x+pts[i+1].x)/3;
	var vn0y=(2*pts[i].y+pts[i+1].y)/3;
	var vnx=vn0x-(pts[i+1].y-pts[i].y);
	var vny=vn0y+(pts[i+1].x-pts[i].x);

	var point1 = {
	    start : { x : pts[i].x, y : pts[i].y }, // 始点
	    end   : { x : sn[i][0], y : sn[i][1] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	vn[i][0]=result.x;
	vn[i][1]=result.y;

drawPoint.push({x: result.x, y: result.y});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle2);
container.appendChild(bezier_line);
drawPoint=[];

	var vn0x=(pts[i].x+2*pts[i+1].x)/3;
	var vn0y=(pts[i].y+2*pts[i+1].y)/3;
	var vnx=vn0x-(pts[i+1].y-pts[i].y);
	var vny=vn0y+(pts[i+1].x-pts[i].x);

	var point1 = {
	    start : { x : pts[i+1].x, y : pts[i+1].y }, // 始点
	    end   : { x : sn[i+1][0], y : sn[i+1][1] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	wn[i][0]=result.x;
	wn[i][1]=result.y;

drawPoint.push({x: result.x, y: result.y});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle2);
container.appendChild(bezier_line);
drawPoint=[];

	}
console.log('vn ,wn=',vn,wn);

   for ( var i = 0; i < iLen-1 ; i++ ){
	cubics.push({x: pts[i].x,y: pts[i].y});
	cubics.push({x: vn[i][0],y: vn[i][1]});
	cubics.push({x: wn[i][0],y: wn[i][1]});
	}

   cubics.push({x: pts[iLen-1].x,y: pts[iLen-1].y});
console.log('Cubics=',cubics);
   return cubics;
}  //End of Debug_Cubic_interpol
</script>
<script>
var svg_tex='';
var under_con='yes';
window.onload = function() {
//
/*
//ソース隠蔽部
//ソース隠蔽用のscriptレーコードのDB save
//ソースは<textarea>タグにid名を付けて準備する
//

   function generate_source(rec,tagn){
		var origin = document.getElementById(tagn);
		var src_script=origin.innerHTML;
console.log('length & script=',src_script.length,src_script);
		update_sysparms(rec,src_script);
	}

	generate_source(4,'script04');
console.log('script04 complete');
	generate_source(5,'script05');
console.log('script05 complete');
	generate_source(6,'script06');
console.log('script06 complete');
	generate_source(7,'script07');
console.log('script07 complete');
	generate_source(8,'script08');
console.log('script08 complete');
	generate_source(9,'script09');
console.log('script09 complete');

//	my_confirm(4);     実行部はcode内に設置
//alert('code generated stop');
//
//ソース隠蔽終了部
//
*/
//
//System構成　①Main　Program　②Display document　③System Controle(mousehandling)　④HTML　edit
//　　　　　　⑤SVG　drawing　⑥SVG　edit
//
//ブラウザ表示用データの準備(DbデータのDjango（Python）からの受取りとinlinesvgへの書き込み　
//
      texxx=unescapeHtml(unescape("{{view_tex}}"));
      my_header=unescapeHtml(unescape("{{header}}"));
console.log('my_header=',my_header);
      header_term=my_header.split('|<=>|');
console.log('header=',header_term);
//
//Document Title（overviews）の展開と本文の表示とfirst_containerを設定
//
      my_overview=unescapeHtml(unescape("{{overviews}}"));
      overview_term=my_overview.split('|<=>|');
console.log('overviews=',overview_term);
      document.getElementById("texx").innerHTML=texxx;
　　  first_container = document.getElementById('texx');
      svg_tex=unescapeHtml(unescape("{{svg_field}}"));
console.log('**svg length=',svg_tex.length,' tex=',svg_tex);

	var all_divsvg=$("div[id^='divsvg']");
console.log('divsvg_all=',all_divsvg);
	for(let i=0;i<all_divsvg.length;i++){
		var idname=all_divsvg[i].getAttribute('id');
		if(idname.slice(0,6)=='divsvg') {
			all_divsvg[i].setAttribute('class','divsvg');
			all_divsvg[i].setAttribute('level','0');
			}
console.log('idname=',idname,all_divsvg[i].getAttribute('class'));
		}
	
//document text部のdivsvgタグのcheckと再編集
      	var fst_tag=first_container.firstChild;
console.log('First node=',fst_tag.nodeName);
	var idname=''
	var clsname=''
	if(fst_tag.nodeName=='DIV') {
		idname=fst_tag.getAttribute('id');
		clsname=fst_tag.getAttribute('class');
		}
	if(fst_tag.nodeName=='DIV' && clsname=='divsvg') {
		if(idname!='divsvg_00') {
console.log('Enter to set divsvg tag',fst_tag);
	      		var cnsvg_tags=svgtag_decompose(header_term[5],header_term[6]);
console.log('cnsvg_tags=',cnsvg_tags);
	      		var cnsvg_nums=cnsvg_tags.length;
console.log('chain svg_nums=',cnsvg_nums);
			if(cnsvg_nums>0) {
				var html_str=document.getElementById("texx").innerHTML;
//console.log('html_str=',html_str);
				while (first_container.firstChild) {
	            			first_container.removeChild(first_container.firstChild);
		    			}
				var text='';
				var st_p=0;
				var end_p=html_str.length;
				var newtag='divsvg_00';
				for(let i=0;i<cnsvg_nums;i++){
					var tagn=cnsvg_tags[i].name;
					var div_name='div'+tagn;
					var svg_div=document.getElementById('div'+tagn);
//console.log('cnsvg tag=',tagn,div_name,svg_div);
				
					var {pt1,pt2}=catch_cnsvg(div_name,html_str,st_p);
					text=html_str.substring(st_p,pt1);
//console.log('select text=',text);
    					var svg_div = document.createElement('div');
    					svg_div.setAttribute('id', newtag);
    					svg_div.setAttribute('class', 'divsvg');
    					svg_div.setAttribute('level', '0');
					var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
					svg_div.setAttribute('style', marginLR);
    					svg_div.innerHTML=text;
					first_container.appendChild(svg_div);
//console.log('loop tag=',svg_div);
					newtag=div_name;
					st_p=pt1;
					}
				text=html_str.substring(st_p,end_p);
//console.log('end text=',text);
    				var svg_div = document.createElement('div');
    				svg_div.setAttribute('id', newtag);
    				svg_div.setAttribute('class', 'divsvg');
    				svg_div.setAttribute('level', '0');
				var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
				svg_div.setAttribute('style', marginLR);
    				svg_div.innerHTML=text;
				first_container.appendChild(svg_div);
//console.log('end tag=',svg_div);
				}
			}
		}
	else {                                             //Top textのみの場合
    		var newtag='divsvg_00';
		var node=document.getElementById(newtag);
console.log('old node=',svg_div,'node=',node);
    		//var div_parent=document.getElementById("wClone")
    		var svg_div = document.createElement('div');
    		svg_div.setAttribute('id', newtag);
    		svg_div.setAttribute('class', 'divsvg');
    		svg_div.setAttribute('level', '0');
		var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
		svg_div.setAttribute('style', marginLR);
		if(node==newtag) svg_div.innerHTML=document.getElementById(newtag).innerHTML;
		else svg_div.innerHTML=document.getElementById("texx").innerHTML;
console.log('only Top text=',svg_div,'node=',node);
    		//div_parent.appendChild(svg_div);
		while (first_container.firstChild) {
            		first_container.removeChild(first_container.firstChild);
	    		}
		first_container.appendChild(svg_div);
		}

      my_confirm(5);
console.log('**doc loaded at my_confirm(5)');
     read_sysparms();

    var NS = container.getAttribute('xmlns');
//
//②Display document (editor初期表示モードの設定）
//
		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';
		document.getElementById(svg_now).style.display="block";
		document.getElementById( "texx" ).style.zIndex ='40';
		document.getElementById( "texh" ).style.zIndex ='20';
//		document.getElementById("texh").value=document.getElementById("texx").innerHTML;
		document.getElementById("texh").innerHTML=escapeHtml(escape(document.getElementById("texx").innerHTML));
		Editmode='Visual';
		change_css(Editmode);

//Pasteを禁止する
//      document.body.onpaste=function(){return false;}

//特定のキー入力に対してのVisual Editorでの処理
//document.getElementById('texx').onkeypress=code_to_html;
} //End of window.onload = function()

function catch_cnsvg(name,text,stp) {
	var text_n='';
	var point_n=0;
	var st_a1=st_b1=st_c1=stp;
	var st_a2,st_b2,st_c2;

	var st_a2=text.indexOf(name, st_a1);
	var st_b2=text.indexOf('<div', st_b1);
	var st_c2=text.indexOf('</div>', st_c1);
console.log('a =',st_a1,st_a2,'b =',st_b1,st_b2,'c =',st_c1,st_c2);

	while(st_a2>st_c2) {
		st_c1=st_b1=st_c2+6;
		var st_b2=text.indexOf('<div', st_b1);
	        var st_c2=text.indexOf('</div>', st_c1);
		}
	if(st_b2<st_a2) {
		var pt1=st_b2;
		var pt2=st_c2+6
		}
	return {pt1:pt1,pt2:pt2};
	}

function goScriptC(nn) {
alert('this part is under construction');
	if(nn==2) {
		under_con='yes';
		}
//console.log('nn=',nn,' under_con=',under_con);
	}
</script>
<textarea id="script04" class="special" style="display:none;">
function Cubic_interpol(pts,controle){
   var iLen= pts.length;
   var cubics=[];
   var sn=[];
   var vn=[];
   var wn=[];

   for ( var i = 0;  i < iLen ; i++ ){
	sn[i]=[0,0];
	vn[i]=[0,0];
	wn[i]=[0,0];
	}
//slope vector の作成   pts[i]からpts[i-1]→pts[i+1]の方向(snは終点のベクトル（始点＋方向成分）
   for ( var i = 1;  i < iLen-1 ; i++ ){
	sn[i][0]=pts[i].x+pts[i+1].x-pts[i-1].x;
	sn[i][1]=pts[i].y+pts[i+1].y-pts[i-1].y;
	}

     if (controle=='close_smooth') {
	sn[iLen-1][0]=pts[iLen-1].x+pts[1].x-pts[iLen-2].x;
	sn[iLen-1][1]=pts[iLen-1].y+pts[1].y-pts[iLen-2].y;

	sn[0][0]=pts[0].x+pts[1].x-pts[iLen-2].x;
	sn[0][1]=pts[0].y+pts[1].y-pts[iLen-2].y;
	}

     else{
	var vn0x=(pts[0].x+pts[1].x)/2;
	var vn0y=(pts[0].y+pts[1].y)/2;
	var vnx=vn0x-(pts[1].y-pts[0].y);
	var vny=vn0y+(pts[1].x-pts[0].x);

	var point1 = {
	    start : { x : pts[0].x, y : pts[0].y }, // 始点
	    end   : { x : pts[0].x+(pts[2].x-pts[0].x) , y : pts[0].y+(pts[2].y-pts[0].y) }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);

	sn[0][0]=2*vn0x-result.x;                        //at　Start　ポイント
	sn[0][1]=2*vn0y-result.y;

	var vn0x=(pts[iLen-2].x+pts[iLen-1].x)/2;
	var vn0y=(pts[iLen-2].y+pts[iLen-1].y)/2;
	var vnx=vn0x-(pts[iLen-1].y-pts[iLen-2].y);
	var vny=vn0y+(pts[iLen-1].x-pts[iLen-2].x);

	var point1 = {
	    start : { x : pts[iLen-1].x, y : pts[iLen-1].y }, // 始点
	    end   : { x : pts[iLen-1].x+(pts[iLen-1].x-pts[iLen-3].x) , y : pts[iLen-1].y+(pts[iLen-1].y-pts[iLen-3].y) }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);

	sn[iLen-1][0]=2*vn0x-result.x;　　//at　End　ポイント
	sn[iLen-1][1]=2*vn0y-result.y;
/*
var drawPoint=[];
var x0,y0,x1,x2;
drawPoint.push({x: pts[iLen-1].x,y: pts[iLen-1].y});
drawPoint.push({x: sn[iLen-1][0],y: sn[iLen-1][1]});
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle);
container.appendChild(bezier_line);
*/
     }

var drawPoint=[];
var x0,y0,x1,x2;
   for ( var i = 0; i < iLen-1 ; i++ ){
/*
drawPoint.push({x: pts[i].x,y: pts[i].y});
drawPoint.push({x: sn[i][0],y: sn[i][1]});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle);
container.appendChild(bezier_line);
drawPoint=[];
*/
	var vn0x=(2*pts[i].x+pts[i+1].x)/3;
	var vn0y=(2*pts[i].y+pts[i+1].y)/3;
	var vnx=vn0x-(pts[i+1].y-pts[i].y);
	var vny=vn0y+(pts[i+1].x-pts[i].x);

	var point1 = {
	    start : { x : pts[i].x, y : pts[i].y }, // 始点
	    end   : { x : sn[i][0], y : sn[i][1] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	vn[i][0]=result.x;
	vn[i][1]=result.y;
/*
drawPoint.push({x: result.x, y: result.y});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle2);
container.appendChild(bezier_line);
drawPoint=[];
*/
	var vn0x=(pts[i].x+2*pts[i+1].x)/3;
	var vn0y=(pts[i].y+2*pts[i+1].y)/3;
	var vnx=vn0x-(pts[i+1].y-pts[i].y);
	var vny=vn0y+(pts[i+1].x-pts[i].x);

	var point1 = {
	    start : { x : pts[i+1].x, y : pts[i+1].y }, // 始点
	    end   : { x : sn[i+1][0], y : sn[i+1][1] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	wn[i][0]=result.x;
	wn[i][1]=result.y;
/*
drawPoint.push({x: result.x, y: result.y});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle2);
container.appendChild(bezier_line);
drawPoint=[];
*/
	}
//console.log('vn ,wn=',vn,wn);

   for ( var i = 0; i < iLen-1 ; i++ ){
	pts[i].x=Math.round(pts[i].x*100)/100;
	pts[i].y=Math.round(pts[i].y*100)/100;
	cubics.push({x: pts[i].x,y: pts[i].y});
	vn[i][0]=Math.round(vn[i][0]*100)/100;
	vn[i][1]=Math.round(vn[i][1]*100)/100;
	cubics.push({x: vn[i][0],y: vn[i][1]});
	wn[i][0]=Math.round(wn[i][0]*100)/100;
	wn[i][1]=Math.round(wn[i][1]*100)/100;
	cubics.push({x: wn[i][0],y: wn[i][1]});
	}

   pts[iLen-1].x=Math.round(pts[iLen-1].x*100)/100;
   pts[iLen-1].y=Math.round(pts[iLen-1].y*100)/100;
   cubics.push({x: pts[iLen-1].x,y: pts[iLen-1].y});
//console.log('Cubics=',cubics);
   return cubics;
}  //End of Cubic_interpol
path_p=Cubic_interpol(drawingPoints,control.value);
</textarea>
<textarea id="script05" class="special" style="display:none;">
//
//Chain Svgの展開
//
      cnsvg_tags=svgtag_decompose(header_term[5],header_term[6]);
      cnsvg_nums=cnsvg_tags.length;
//console.log('tags leng=',cnsvg_tags.length,cnsvg_tags);
//CnSvg(複数個所の読み込みと展開
//console.log('*Start set cnsvg tag leng=',cnsvg_tags.length);
	for(var i=0;i<cnsvg_tags.length;i++) {
		var tagn=cnsvg_tags[i].name;
		get_cnsvg(cnsvg_tags[i].pk)
		cnsvg_tags[i].head=wfcn_header;
		var svg_div=document.getElementById('div'+tagn);
    		var oya = svg_div.parentNode;
    		var dumy=document.getElementById('chain');
    		var newsvg=dumy.cloneNode(true);
    		newsvg.setAttribute('id', tagn);
    		newsvg.setAttribute('style', 'display:block;');
//console.log(newsvg,svg_div);
		var rect=createRectFig(0,0,20,20);
		rect.setAttribute('class', 'chain_svg_mark');
		rect.setAttribute('stroke', 'blue');
		rect.setAttribute('stroke-width', '1');
		rect.setAttribute('fill', 'blue');
		newsvg.appendChild(rect);
		cnsvg_field=unescapeHtml(unescape(cnsvg_field));
//console.log(cnsvg_field,svg_div,oya);
    		oya.insertBefore(newsvg,svg_div);
//console.log('expand chain_svg');
		expand_svg(cnsvg_field,tagn);
//console.log(cnsvg_field,svg_div,oya);
		svg_tag_add(tagn)
		}
//console.log('cnsvg tags leng=',cnsvg_tags.length,cnsvg_tags);

//
//Top Svgの展開と表示
//
      var first_child = first_container.firstChild ;
      var dumy=document.getElementById('chain');
      var newsvg=dumy.cloneNode(true);
      newsvg.setAttribute('id', 'svg_00');
      newsvg.setAttribute('style', 'display:block;');
	var rect=createRectFig(0,0,20,20);
	rect.setAttribute('class', 'chain_svg_mark');
	rect.setAttribute('stroke', 'blue');
	rect.setAttribute('stroke-width', '1');
	rect.setAttribute('fill', 'blue');
	newsvg.appendChild(rect);
      first_container.insertBefore(newsvg,first_child);

      org_container = document.getElementById('svg_00');
//containerは下記expand_svgnの中でsvg_00中のg01を設定
//console.log('expand top_svg leng=',svg_tex.length);
      expand_svg(svg_tex,'svg_00');
      set_svg(svg_now);

	if(org_container.querySelector('.top')==null) {
//console.log('***make g01 group as container');
		container=org_container;
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		container=org_container.appendChild(group);
		}
	else {
		container=org_container.querySelector('.top');
		}
</textarea>
<textarea id="script06"  class="special" style="display:none;">
	var text_to_serv;
	var svg_tag;
	var term=overview_term[7].slice(0,7);
//console.log('****pre Save overview=',term,'Popcheck=',Popcheck);
	if(((term=='新規レコード:') || (term=='Copy新規:')) && (Popcheck==0)){
//console.log('Popcheck Enter',term,'check=',Popcheck);
		pop_inp_search();
		Popcheck=1;
		}
	else {
//Saveの順番は①最初にChain_CnSvgが最初でその後②本体HTML（含む本体SVG（svg_00)のsaveとする
//CnSvgのsaveはcnsvg_tagで分かる
//console.log('**Save CnSvg Enter leng=',cnsvg_tags.length,cnsvg_tags);
		for(var i=0;i<cnsvg_tags.length;i++){
			svg_tag=fold_svg(cnsvg_tags[i].name);
//console.log('each cnsvg lenth=',svg_tag.length,svg_tag,'head=',cnsvg_tags[i].head);
			save_cnsvg(cnsvg_tags[i].head,svg_tag);
			}
		my_confirm(8);

    		var tags_header=cntags_compose();
//console.log('my_header=',my_header);
//console.log('text_to_serv=',tex_to_serv);
//console.log('svg=',svg_tag);
//console.log('my_overview=',my_overview);
//console.log('svg_tag',svg_tag);

        	$.ajax({
            		url: "/db_serv/update/",
            		async:true,
			type: "POST",
            		data: {
				"description":tex_to_serv,
				"my_header":my_header,
				"my_overview":my_overview,
				"cnsvg_nums":cnsvg_nums,
				"cnsvg_header":tags_header,
				"svg":svg_tag,
				},
            		dataType: 'json'
        		})
        	.done((data) => {
            		//結果が帰ってきたら、表示します。
console.log('**Ajax Returned result=',data);
        		});

//    var tags_header=cntags_compose();
//    update_head(header_term[0],String(cnsvg_nums),tags_header);
//console.log('My_Data mend nk=',header_term[0],String(cnsvg_nums),tags_header);
	Popcheck=0;
	}  //End else
</textarea>
<textarea id="script08"  class="special" style="display:none;">
//Text本体部分（含むTop_svg）のsaveをするがその前にCnSvg部分を削除後の残り部分とする
//console.log('***Enter to Save HTML_Text');
//const element = document.querySelector('section')
//element.remove()
		dumy_div=document.getElementById('wClone').cloneNode(true);
		var dumy=(document.getElementById('texx')).cloneNode(true);
    		dumy.appendChild(dumy_div);

        	while (del_tag = dumy.querySelector('svg')) {
//console.log(del_tag);
			del_tag.remove();
			}
        	while (del_tag = dumy.querySelector('#wClone')) {
//console.log(del_tag);
			del_tag.remove();
			}
//console.log(dumy);

		tex_to_serv=escapeHtml(escape(dumy.innerHTML));
//console.log('**save text=',text_to_serv);
		svg_tag=fold_svg('svg_00');
		svg_tag=escapeHtml(escape(svg_tag));
		dumy.remove();
		dumy_div.remove();
</textarea>
<textarea id="script09"  class="special" style="display:none;">
	export_html();
function export_html(){
//class=Tivの複製
  var data=get_common(7);
//console.log('data=',data);

    const parser = new DOMParser();
    const html_dat = parser.parseFromString(data, "text/html");

    var tagn=document.getElementById('texx');
    var dumy=tagn.cloneNode(true);

	dlist=dumy.querySelectorAll('svg');
	dlist.forEach(function (element) {
		element.children[0].remove();
		element.setAttribute('style','display;block');
		element.setAttribute('class','canv point_none');
//console.log(element);
		});

	var btag=html_dat.querySelector('body');
//console.log(btag);
	btag.appendChild(dumy);
//console.log(html_dat);
	const serializer = new XMLSerializer();
	const es_html = serializer.serializeToString(html_dat);
//console.log('export html length=',es_html.length);
	if(es_html.length > 12000) {
		alert('Download HTML is too large this Demo version!');
		return;
		}

let blob = new Blob([es_html],{type:"html"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'testfile.html';
link.click();
   }
</textarea>
<textarea id="script07"  class="special" style="display:none;">
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<title>Sample</title>
</head>
<style>
.Tvis {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width:100%;
  height:auto;
  z-index: 30;
  background-color:"red";
  opacity: 0.;  
}
.canv {
  z-index:20;
  padding:0px;
  left: -20px;
  margin:0px;
  width:100%;
  position: absolute;
  opacity: 0.;  
}
.my_button {
  display: block;
  width: 160px;
  height: 36px;
  margin: 10px 10px 10px 10px; /* 外側の時計回りの余白 */
  text-align: center;
  color: #fff;   /* #666; */
  line-height: 36px;
  text-decoration: none;
  background-color: #69c;  /*  #efefef;  */
  border: 1px solid #69c;  /*  #ddd;     */
  border-radius: 5px;
  float: left;
}
.my_button:hover {color:#ffffff; background:#0000cc;} /*カーソルが乗っているリンクの色*/

.point_none {
  pointer-events:none;
}
.point_auto {
  pointer-events: auto;
}
.my_navi ul {
  display: flex;
  flex-flow: column;
  margin: 0;
  padding: 6px;
  list-style-type: none;
}
.my_navi li.my_hamburger {
  align-self: flex-end;
}
.my_navi a {
  display: block;
  border-radius: 4px;
  padding: 12px 24px;
  color: white;
  text-decoration: none;
}
.my_navi li a:hover {
  opacity: 0.6;
}

@media only screen and (min-width:550px) {
.my_navi ul {
    display: flex;
    flex-flow: row;
    margin: 0;
    padding: 6px;
    list-style-type: none;
  }

.my_navi li.my_hamburger {
     display: none;
  }
}
</style>
<body>
        <svg id="mesh_canv" class="canv" width="1000" height="1000" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	    <defs>
	      <marker id="start_arw" viewBox="-10 -3 10 6" refX="-10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M -10 0 L 0 -3 L 0 3 Z"/>
	      </marker>
	      <marker id="end_arw" viewBox="0 -3 10 6" refX="10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M 0 -3 L 0 3 L 10 0 Z"/>
	      </marker>
	    </defs>
	</svg>
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous">
</script>
<script>
$(function () {
  $('#my_nav_togl').on('click', function () {        // js-btnクラスをクリックすると、
console.log('click');
	$('li.my_nav').slideToggle();  // こちらがOK
  })
});
</script>
</body>
</html>
</textarea>
{% include 'db_serv/footer.html' %}
